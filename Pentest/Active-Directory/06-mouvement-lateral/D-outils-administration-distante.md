# VI.D. Utilisation d'Outils d'Administration à Distance

Plusieurs outils, qu'ils soient légitimes (faisant partie de Windows ou de suites d'administration) ou développés spécifiquement pour les tests d'intrusion, facilitent l'exécution de commandes et le contrôle à distance de machines. Ces outils s'appuient souvent sur les protocoles décrits précédemment (SMB, WMI, WinRM).

## 1. PsExec (Sysinternals)

*   **Description :** Outil légitime de la suite Sysinternals, largement utilisé par les administrateurs et les attaquants. Il permet d'exécuter des processus sur des systèmes distants.
*   **Fonctionnement :** Utilise SMB pour copier `PSEXESVC.exe` dans `ADMIN$` sur la cible, puis crée et démarre un service temporaire pour exécuter la commande.
*   **Prérequis :** Droits d'admin local sur la cible, partage `ADMIN$` accessible, service "Server" en cours d'exécution sur la cible.
*   **Utilisation (Windows) :**
    ```bash
    # Obtenir un shell interactif
    PsExec.exe \\<IP_CIBLE_OU_NOM> -u <DOMAINE>\<UTILISATEUR> -p <MOT_DE_PASSE> cmd.exe
    # Exécuter une commande spécifique
    PsExec.exe \\<IP_CIBLE_OU_NOM> -u <DOMAINE>\<UTILISATEUR> -p <MOT_DE_PASSE> ipconfig
    # Exécuter en tant que SYSTEM (si vous êtes déjà admin local)
    PsExec.exe \\<IP_CIBLE_OU_NOM> -s cmd.exe
    ```
*   **Détection :** La création du service `PSEXESVC` et l'exécution de `PSEXESVC.exe` depuis `C:\Windows\` sont des indicateurs classiques. Les EDRs le détectent souvent.

## 2. Impacket `psexec.py` (Linux)

*   **Description :** Fait partie de la suite Impacket, réimplémentation de PsExec en Python.
*   **Fonctionnement :** Similaire à PsExec original. Supporte Pass-the-Hash et Kerberos.
*   **Utilisation (Linux) :**
    ```bash
    # Avec mot de passe
    psexec.py <DOMAINE>/<UTILISATEUR>:<MOT_DE_PASSE>@<IP_CIBLE>
    # Avec Pass-the-Hash
    psexec.py <DOMAINE>/<UTILISATEUR>@<IP_CIBLE> -hashes aad3b435b51404eeaad3b435b51404ee:<HASH_NTLM>
    # Avec Kerberos (si KRB5CCNAME est configuré avec un TGT valide)
    psexec.py <DOMAINE>/<UTILISATEUR>@<IP_CIBLE_FQDN> -k -no-pass
    ```

## 3. Impacket `smbexec.py` (Linux)

*   **Description :** Alternative à `psexec.py` qui tente d'être plus furtive. Au lieu de dropper un binaire, elle utilise des commandes `cmd.exe /c` redirigées via un partage SMB temporaire pour simuler un shell.
*   **Fonctionnement :** Crée un partage SMB temporaire sur la machine de l'attaquant (ou utilise un existant), puis exécute des commandes sur la cible en redirigeant la sortie vers ce partage.
*   **Utilisation (Linux) :**
    ```bash
    # Avec mot de passe
    smbexec.py <DOMAINE>/<UTILISATEUR>:<MOT_DE_PASSE>@<IP_CIBLE>
    # Avec Pass-the-Hash
    smbexec.py <DOMAINE>/<UTILISATEUR>@<IP_CIBLE> -hashes aad3b435b51404eeaad3b435b51404ee:<HASH_NTLM>
    # Exécuter une commande unique
    smbexec.py <DOMAINE>/<UTILISATEUR>@<IP_CIBLE> -hashes ... -C "whoami"
    ```
*   **Furtivité :** Moins de traces de service/binaire sur la cible, mais génère du trafic SMB.

## 4. Impacket `wmiexec.py` (Linux)

*   **Description :** Utilise WMI pour obtenir un shell semi-interactif.
*   **Fonctionnement :** Interagit avec WMI sur la cible pour créer des processus et récupérer leur sortie.
*   **Utilisation (Linux) :**
    ```bash
    # Avec mot de passe
    wmiexec.py <DOMAINE>/<UTILISATEUR>:<MOT_DE_PASSE>@<IP_CIBLE>
    # Avec Pass-the-Hash
    wmiexec.py <DOMAINE>/<UTILISATEUR>@<IP_CIBLE> -hashes aad3b435b51404eeaad3b435b51404ee:<HASH_NTLM>
    ```

## 5. Impacket `dcomexec.py` (Linux)

*   **Description :** Utilise DCOM pour exécuter des commandes à distance. Peut être utile si WMI ou SMB sont restreints mais DCOM est accessible.
*   **Fonctionnement :** Exploite différentes méthodes DCOM (comme ShellExecute, ShellWindows) pour lancer des commandes.
*   **Utilisation (Linux) :**
    ```bash
    dcomexec.py <DOMAINE>/<UTILISATEUR>:<MOT_DE_PASSE>@<IP_CIBLE> -object <OBJET_DCOM> <COMMANDE>
    # Exemple:
    dcomexec.py <DOMAINE>/<UTILISATEUR>:<MOT_DE_PASSE>@<IP_CIBLE> MMC20.Application "notepad.exe"
    ```

## 6. PowerShell Remoting / `Enter-PSSession` / `Invoke-Command`

*   **Description :** Fonctionnalités natives de Windows pour l'administration à distance via WinRM.
*   **Utilisation (Windows PowerShell) :**
    ```powershell
    # Session interactive
    Enter-PSSession -ComputerName <IP_CIBLE_OU_NOM> -Credential (Get-Credential)
    # Commande unique
    Invoke-Command -ComputerName <IP_CIBLE_OU_NOM> -ScriptBlock { hostname } -Credential (Get-Credential)
    ```
*   Voir [VI.C Exploitation de Services Réseau](./C-exploitation-services-reseau.md#2-winrm-windows-remote-management--powershell-remoting) pour plus de détails.

## 7. evil-winrm (Ruby)

*   **Description :** Client WinRM populaire, facile à utiliser, supporte Pass-the-Hash.
*   **Utilisation :**
    ```bash
    evil-winrm -i <IP_CIBLE> -u <UTILISATEUR> -p <MOT_DE_PASSE_OU_HASH_NTLM>
    # Si c'est un hash, utiliser -H <HASH_NTLM> ou simplement fournir le hash au lieu du mot de passe.
    ```

## Considérations
*   **Living Off the Land (LotL) :** L'utilisation d'outils natifs comme PowerShell Remoting ou `wmic` peut être plus furtive que l'introduction d'outils tiers comme PsExec.
*   **Détection :** Les EDRs et les solutions de surveillance réseau sont de plus en plus efficaces pour détecter l'utilisation abusive de ces outils, même légitimes.
*   **Permissions :** Toutes ces méthodes nécessitent généralement des droits d'administrateur local sur la machine cible.
*   **Configuration Réseau/Pare-feu :** Les ports et protocoles requis (SMB:445, WinRM:5985/5986, RPC pour WMI) doivent être ouverts entre l'attaquant et la cible.

Choisir l'outil dépend du contexte, des défenses en place, et des credentials disponibles. 