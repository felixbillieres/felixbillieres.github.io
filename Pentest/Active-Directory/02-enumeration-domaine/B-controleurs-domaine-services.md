# B. Contrôleurs de Domaine et Services Clés

L'identification et l'analyse des contrôleurs de domaine (DCs) et autres services d'infrastructure critiques sont fondamentales.

## 1. Énumération des Contrôleurs de Domaine (DC)

*   **Objectif :** Lister tous les DCs du domaine, obtenir leurs FQDN, adresses IP, versions d'OS, et rôles FSMO.
*   **Outils et Commandes :**

    *   **PowerView (Windows) :**
        ```powershell
        # Lister les DCs du domaine actuel
        Get-DomainController | select Name, IPAddress, Domain, Forest, OSVersion, Roles, IsGlobalCatalog, IsReadOnly

        # Lister les DCs d'un domaine spécifique (si trust)
        Get-DomainController -Domain <AUTRE_DOMAINE.LOCAL>
        ```

    *   **nltest (Windows natif) :**
        ```cmd
        nltest /dclist:<DOMAINE.LOCAL>  # Liste les DCs
        nltest /dcname:<DOMAINE.LOCAL> # Nom du DC contacté par la machine
        nltest /dsgetdc:<DOMAINE.LOCAL> # Informations détaillées sur un DC (IP, site, flags)
        ```

    *   **Requêtes LDAP manuelles (ldapsearch) :**
        ```bash
        # Lister les objets serveurs qui sont des DCs (userAccountControl flag pour DC)
        # Le flag 8192 (0x2000) dans userAccountControl indique un DC.
        ldapsearch -x -H ldap://<IP_UN_DC> -D "<DN_USER>" -w "<PASSWORD>" \
                   -b "<DN_BASE_DOMAINE>" \
                   "(&(objectCategory=computer)(userAccountControl:1.2.840.113556.1.4.803:=8192))" \
                   name dnshostname operatingsystem operatingsystemversion
        ```
        *Note : `1.2.840.113556.1.4.803:` est le matching rule OID pour les opérations bitwise AND.*

    *   **DNS Records :**
        ```bash
        # SRV records pour LDAP (identifie les DCs)
        nslookup -type=SRV _ldap._tcp.pdc._msdcs.<DOMAINE.LOCAL> # PDC Emulator
        nslookup -type=SRV _ldap._tcp.gc._msdcs.<DOMAINE.LOCAL>   # Global Catalogs
        ```

## 2. Identification des Serveurs Critiques et Services AD Étendus

*   **Objectif :** Découvrir d'autres serveurs et services importants dans l'infrastructure AD.
*   **Services à rechercher :**

    *   **Active Directory Certificate Services (AD CS) - PKI :**
        *   **Impact :** Des configurations vulnérables peuvent permettre l'escalade de privilèges (ESC1 à ESC8+).
        *   **Détection :**
            ```bash
            # CrackMapExec (module adcs)
            crackmapexec ldap <IP_DC_OU_PLAGE_LDAP> -u <user> -p <password> -M adcs

            # Certipy (outil spécialisé)
            certipy find -u <user>@<DOMAINE.LOCAL> -p <password> -dc-ip <IP_DC> -stdout -vulnerable
            # Ou avec hash: certipy find -u <user>@<DOMAINE.LOCAL> -hashes <LM:NT> -dc-ip <IP_DC> ...

            # PowerView (recherche d'objets pKIEnrollmentService)
            Get-DomainObject -LDAPFilter "(objectClass=pKIEnrollmentService)" | Select-Object distinguishedName, name
            Get-DomainObject -LDAPFilter "(objectClass=msPKI-Enterprise-CA)"
            ```
        *   **Points Clés :** Nom de la CA, templates de certificats vulnérables, permissions d'enrôlement.

    *   **Microsoft Exchange Server :**
        *   **Impact :** Souvent privilégié, accès aux emails, peut avoir des droits élevés sur AD.
        *   **Détection :**
            ```powershell
            # PowerView (recherche de SPNs liés à Exchange)
            Get-DomainComputer -Properties serviceprincipalname | Where-Object {$_.serviceprincipalname -like "*Exchange*"} | select name, dnshostname, serviceprincipalname
            Get-DomainUser -Properties serviceprincipalname | Where-Object {$_.serviceprincipalname -like "*Exchange*"} | select samaccountname, serviceprincipalname

            # Nmap (scan des ports Exchange: 25, 80, 110, 135, 143, 443, 993, 995, etc.)
            nmap -p 25,80,110,135,143,443,587,993,995,444 <IP_CIBLE_EXCHANGE> -sV
            ```
        *   **Points Clés :** Version d'Exchange (vulnérabilités connues comme ProxyLogon, ProxyShell), accès OWA.

    *   **Active Directory Federation Services (ADFS) :**
        *   **Impact :** Gère l'authentification fédérée, sa compromission peut donner accès à des applications cloud.
        *   **Détection :**
            ```powershell
            # PowerView (recherche de SPNs)
            Get-DomainComputer -Properties serviceprincipalname | Where-Object {$_.serviceprincipalname -like "*sts*"} | select name, dnshostname # Souvent host/sts.domaine.local
            # Chercher des serveurs avec le rôle ADFS installé.
            # DNS: sts.domaine.local, enterpriseregistration.domaine.local, adfs.domaine.local

            # Nmap (scan port 443, 49443)
            nmap -p 443,49443 <IP_CIBLE_ADFS> -sV
            # Chercher /adfs/ls/IdpInitiatedSignon.aspx
            ```
        *   **Points Clés :** Version d'ADFS, certificats de signature de jetons (leur clé privée est critique).

    *   **Serveurs SQL avec authentification Windows intégrée :**
        *   **Impact :** Peuvent contenir des données sensibles, et si le compte de service SQL est privilégié, il peut être abusé.
        *   **Détection :**
            ```powershell
            # PowerView (recherche de SPNs MSSQLsvc)
            Get-DomainUser -SPN | Where-Object {$_.serviceprincipalname -like "MSSQLsvc*"} | select samaccountname, serviceprincipalname, memberof
            Get-DomainComputer -Properties serviceprincipalname | Where-Object {$_.serviceprincipalname -like "MSSQLsvc*"} | select name, dnshostname

            # Nmap (scan port 1433/tcp, 1434/udp)
            nmap -p T:1433,U:1434 <PLAGE_IP> -sV
            ```

    *   **Serveurs de fichiers critiques (partages sensibles) :**
        *   Déjà en partie couvert par l'énumération SMB, mais focus sur les serveurs identifiés comme importants.

## Points Clés à Observer (DCs et Services)
*   Nombre de DCs, leurs noms, IPs, et versions d'OS (pour vulnérabilités spécifiques aux DCs).
*   Qui est le PDC Emulator (cible prioritaire pour certaines attaques).
*   Présence et configuration d'AD CS (extrêmement important).
*   Présence de serveurs Exchange, ADFS, SQL.
*   Comptes de service associés à ces serveurs et leurs privilèges. 