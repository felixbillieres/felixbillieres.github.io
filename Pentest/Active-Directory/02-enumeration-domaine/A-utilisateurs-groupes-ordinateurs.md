# A. Utilisateurs, Groupes et Ordinateurs

Une fois un accès (même basique) obtenu, ou avec des identifiants valides, l'énumération détaillée des objets AD est cruciale.

## 1. Énumération des Utilisateurs

*   **Objectif :** Lister les comptes utilisateurs, identifier les comptes potentiellement intéressants (admins, services), et ceux vulnérables à certaines attaques.
*   **Outils et Commandes :**

    *   **Kerbrute (Bruteforce de noms d'utilisateurs via Kerberos Pre-Auth - discret) :**
        ```bash
        # Prérequis: liste de noms d'utilisateurs potentiels (users.txt)
        # <dc_ip> est l'IP d'un DC, <domaine.local> est le FQDN du domaine
        kerbrute userenum --dc <dc_ip> -d <domaine.local> users.txt
        # Chercher : Utilisateurs valides (ceux qui ne retournent pas KRB_AP_ERR_BAD_INTEGRITY ou KDC_ERR_C_PRINCIPAL_UNKNOWN)
        ```

    *   **CrackMapExec (avec credentials valides) :**
        ```bash
        # Lister les utilisateurs du domaine
        crackmapexec <protocol> <IP_DC_ou_CIBLE> -u <user> -p <password> --users
        # Protocoles: smb, ldap, winrm
        # Exemple: crackmapexec ldap 10.10.10.1 -u 'john.doe' -p 'Password123!' --users

        # Lister les utilisateurs avec leur description
        crackmapexec ldap <IP_DC> -u <user> -p <password> -M enum_users_by_group --option GROUP="Domain Users" # Pas direct pour description, mais liste les users
        # Mieux avec LDAP search ou PowerView pour les descriptions
        ```

    *   **PowerView (Windows, module PowerShell) :**
        ```powershell
        # Importer le module
        # Import-Module .\PowerView.ps1 (ou via IEX)

        # Lister tous les utilisateurs (attributs de base)
        Get-DomainUser | select samaccountname, distinguishedname, description, pwdlastset, lastlogon, memberof

        # Lister tous les attributs d'un utilisateur spécifique
        Get-DomainUser -Identity <NOM_UTILISATEUR> -Properties *

        # Chercher des mots-clés dans les descriptions (ex: "password", "admin", "service")
        Get-DomainUser -Properties description | Where-Object {$_.Description -like "*pass*"} | select samaccountname, description
        Get-DomainUser -Properties description | Where-Object {$_.Description -ne $null} | select samaccountname, description

        # Comptes avec pré-authentification Kerberos non requise (vulnérables à AS-REP Roasting)
        Get-DomainUser -PreauthNotRequired | select samaccountname, userprincipalname

        # Comptes avec SPN configurés (vulnérables à Kerberoasting)
        Get-DomainUser -SPN | select samaccountname, serviceprincipalname, memberof
        ```

    *   **Requêtes LDAP manuelles (ldapsearch) :**
        ```bash
        # Lister tous les utilisateurs (nécessite credentials)
        ldapsearch -x -H ldap://<IP_DC> -D "CN=user,CN=Users,DC=domain,DC=local" -w "password" \
                   -b "DC=domain,DC=local" "(&(objectCategory=person)(objectClass=user))" \
                   samaccountname description pwdlastset lastlogon memberof
        ```

## 2. Énumération des Groupes

*   **Objectif :** Identifier les groupes, en particulier ceux à privilèges (Domain Admins, Enterprise Admins, Administrators locaux sur des serveurs clés), et leurs membres.
*   **Outils et Commandes :**

    *   **CrackMapExec (avec credentials valides) :**
        ```bash
        crackmapexec <protocol> <IP_DC_ou_CIBLE> -u <user> -p <password> --groups
        # Lister les membres d'un groupe spécifique (ex: Domain Admins)
        crackmapexec <protocol> <IP_DC_ou_CIBLE> -u <user> -p <password> -M enum_users_by_group --option GROUP="Domain Admins"
        ```

    *   **PowerView :**
        ```powershell
        # Lister tous les groupes du domaine
        Get-DomainGroup | select samaccountname, distinguishedname, description, memberof, members

        # Lister les membres d'un groupe spécifique
        Get-DomainGroupMember -Identity "Domain Admins" | select MemberName, MemberDistinguishedName
        Get-DomainGroupMember -Identity "Enterprise Admins"
        Get-DomainGroupMember -Identity "Administrators" # Groupe local sur le DC si exécuté sur un DC

        # Chercher des groupes par mot-clé dans la description
        Get-DomainGroup -Properties description | Where-Object {$_.Description -like "*admin*"}

        # Groupes dont un utilisateur est membre (directement)
        Get-DomainGroup -UserName <NOM_UTILISATEUR>
        # Groupes dont un utilisateur est membre (récursivement)
        Get-DomainGroup -UserName <NOM_UTILISATEUR> -Recurse
        ```

    *   **Requêtes LDAP manuelles (ldapsearch) :**
        ```bash
        # Lister tous les groupes
        ldapsearch -x -H ldap://<IP_DC> -D "<DN_USER>" -w "<PASSWORD>" \
                   -b "<DN_BASE_DOMAINE>" "(objectClass=group)" \
                   samaccountname description member
        ```

## 3. Énumération des Ordinateurs

*   **Objectif :** Lister les objets ordinateurs, identifier les serveurs, les postes de travail, et potentiellement leurs systèmes d'exploitation.
*   **Outils et Commandes :**

    *   **CrackMapExec (avec credentials valides) :**
        ```bash
        crackmapexec <protocol> <IP_DC_ou_CIBLE> -u <user> -p <password> --computers
        ```

    *   **PowerView :**
        ```powershell
        # Lister tous les ordinateurs du domaine
        Get-DomainComputer | select name, dnshostname, operatingsystem, serviceprincipalname, distinguishedname

        # Lister les ordinateurs avec un OS spécifique (ex: serveurs)
        Get-DomainComputer -Properties operatingsystem | Where-Object {$_.operatingsystem -like "*Server*"} | select name, operatingsystem

        # Lister les ordinateurs où un utilisateur spécifique est admin local (nécessite des droits pour interroger à distance)
        # Find-DomainLocalAdminAccess -UserName <NOM_UTILISATEUR_CIBLE> (peut être long et bruyant)
        ```

    *   **Requêtes LDAP manuelles (ldapsearch) :**
        ```bash
        # Lister tous les objets ordinateurs
        ldapsearch -x -H ldap://<IP_DC> -D "<DN_USER>" -w "<PASSWORD>" \
                   -b "<DN_BASE_DOMAINE>" "(objectCategory=computer)" \
                   name dnshostname operatingsystem serviceprincipalname
        ```

## Points Clés à Observer (Utilisateurs, Groupes, Ordinateurs)
*   **Utilisateurs :**
    *   Descriptions (mots de passe, rôles).
    *   Date de dernière connexion (`lastlogon`), date de dernier changement de mot de passe (`pwdlastset`).
    *   Appartenance à des groupes privilégiés.
    *   Comptes avec `PreauthNotRequired` (AS-REP Roasting).
    *   Comptes avec SPN (Kerberoasting).
*   **Groupes :**
    *   Membres des groupes "Domain Admins", "Enterprise Admins", "Schema Admins", "Administrators" (sur DCs/serveurs).
    *   Groupes avec des droits délégués sur des OUs ou objets sensibles.
    *   Descriptions des groupes.
*   **Ordinateurs :**
    *   Systèmes d'exploitation (identifier les serveurs vs postes de travail).
    *   DCs, serveurs de fichiers, serveurs d'applications critiques.
    *   Ordinateurs avec délégation Kerberos configurée (voir section délégation).
``` 