# C. Politiques de Sécurité et Configurations

Comprendre les politiques de sécurité du domaine et identifier les configurations potentiellement dangereuses est essentiel pour planifier les attaques.

## 1. Énumération de la Politique de Mot de Passe du Domaine

*   **Objectif :** Connaître les contraintes sur les mots de passe (longueur, complexité, historique, durée de vie) et la politique de verrouillage de compte. Utile pour les attaques par force brute ou password spraying.
*   **Outils et Commandes :**

    *   **PowerView (Windows) :**
        ```powershell
        # Obtenir la politique de mot de passe du domaine par défaut
        Get-DomainPolicyData | select -ExpandProperty SystemAccess | Format-List *
        # Ou de manière plus ciblée :
        (Get-DomainPolicyData)."SystemAccess"
        # Chercher : MinimumPasswordLength, PasswordHistoryLength, MaxPasswordAge, LockoutThreshold, LockoutDuration, ResetLockoutCount
        ```

    *   **CrackMapExec (avec credentials valides ou parfois session nulle) :**
        ```bash
        crackmapexec <protocol> <IP_DC> -u <user> -p <password> --pass-pol
        # Exemple: crackmapexec smb 10.10.10.1 -u 'user' -p 'pass' --pass-pol
        ```

    *   **enum4linux (session nulle) :**
        ```bash
        enum4linux -P <IP_DC>
        ```
    *   **Requêtes LDAP manuelles (attributs sur l'objet domaine) :**
        ```bash
        # Nécessite de mapper les attributs comme minPwdLength, pwdHistoryLength, etc.
        ldapsearch -x -H ldap://<IP_DC> -D "<DN_USER>" -w "<PASSWORD>" \
                   -b "<DN_BASE_DOMAINE>" -s base \
                   minPwdLength pwdHistoryLength maxPwdAge lockoutThreshold lockoutDuration lockoutObservationWindow
        ```

## 2. Énumération des Utilisateurs Connectés (Sessions Actives)

*   **Objectif :** Identifier où des utilisateurs (surtout privilégiés) sont actuellement connectés. Utile pour cibler des machines pour l'extraction de credentials ou le mouvement latéral.
*   **Outils et Commandes :**

    *   **CrackMapExec (nécessite des droits d'admin local sur les cibles ou SMB activé) :**
        ```bash
        # Scanner une plage d'IPs pour les utilisateurs connectés
        crackmapexec smb <PLAGE_IP_CIDR> -u <user> -p <password> --loggedon-users
        # Peut être très bruyant.
        ```

    *   **PowerView (depuis une machine jointe au domaine) :**
        ```powershell
        # Trouver où sont connectés les utilisateurs du domaine (interroge les DCs pour les sessions)
        Find-DomainUserLocation -ShowAll | select UserName, SessionFromName, ComputerName

        # Trouver où un utilisateur spécifique est connecté
        Find-DomainUserLocation -User <NOM_UTILISATEUR_CIBLE>

        # Lister les sessions sur une machine spécifique (nécessite droits admin sur la cible)
        Get-NetSession -ComputerName <NOM_OU_IP_CIBLE>

        # Lister les utilisateurs connectés localement et via RDP sur une machine (nécessite droits admin sur la cible)
        Get-NetLoggedon -ComputerName <NOM_OU_IP_CIBLE>
        ```
    *   **psloggedon.exe (Sysinternals - nécessite droits admin sur la cible) :**
        ```cmd
        psloggedon.exe \\<NOM_OU_IP_CIBLE>
        ```
    *   **qwinsta / query session (Windows natif - nécessite droits admin sur la cible) :**
        ```cmd
        qwinsta /server:<NOM_OU_IP_CIBLE>
        ```

## 3. Configurations Sensibles et Dangereuses

*   **Objectif :** Identifier des faiblesses de configuration spécifiques qui peuvent être exploitées.

    *   **Partages SMB mal configurés / Fichiers sensibles :**
        *   **Détection (PowerView) :**
            ```powershell
            # Trouver les partages accessibles sur le domaine
            Invoke-ShareFinder -Verbose | select name, path, computername, remark
            # Chercher des fichiers par mot-clé sur les partages accessibles (peut être long)
            Invoke-FileFinder -SearchQuery "*.kdbx,*.config,*.xml,*password*" -Verbose
            ```
        *   **Détection (CrackMapExec) :**
            ```bash
            crackmapexec smb <PLAGE_IP_CIDR> -u <user> -p <password> --shares -r # -r pour lister récursivement
            # Pour lire des fichiers spécifiques si accès en lecture
            crackmapexec smb <IP_CIBLE> -u <user> -p <password> -M get_files --option '\\SHARE\\path\\to\\file.txt' '/tmp/local_copy.txt'
            ```
        *   **Détection (smbmap) :**
            ```bash
            smbmap -u <user> -p <password> -d <DOMAINE> -H <IP_CIBLE> -R # Lister récursivement
            smbmap -u <user> -p <password> -d <DOMAINE> -H <IP_CIBLE> --download "SHARE\\path\\to\\file"
            ```
        *   **Recherche manuelle de chaînes (Windows natif) :**
            ```cmd
            # Sur un partage monté ou localement
            findstr /SI /M "password" \\serveur\partage\*.txt \\serveur\partage\*.xml \\serveur\partage\*.ini \\serveur\partage\*.config
            # /S: sous-dossiers, /I: ignore casse, /M: affiche nom du fichier seulement
            ```

    *   **Comptes avec Pré-authentification Kerberos Désactivée (AS-REP Roasting) :**
        *   **Détection (PowerView) :**
            ```powershell
            Get-DomainUser -PreauthNotRequired | select samaccountname, userprincipalname, distinguishedname
            ```
        *   **Détection (Requête LDAP) :**
            L'attribut `userAccountControl` contient le flag `DONT_REQ_PREAUTH` (4194304 ou 0x400000).
            ```bash
            ldapsearch -x -H ldap://<IP_DC> -D "<DN_USER>" -w "<PASSWORD>" \
                       -b "<DN_BASE_DOMAINE>" \
                       "(&(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=4194304))" \
                       samaccountname userprincipalname
            ```
        *   **Exploitation :** Voir section [03.C. AS-REP Roasting](../03-acces-initial/C-asrep-roasting.md).

    *   **Comptes Utilisateur/Ordinateur avec Noms de Principal de Service (SPN) - (Kerberoasting) :**
        *   **Détection (PowerView) :**
            ```powershell
            # Utilisateurs avec SPN (cibles principales pour Kerberoasting)
            Get-DomainUser -SPN | select samaccountname, serviceprincipalname, memberof, distinguishedname
            # Ordinateurs avec SPN (moins courant pour Kerberoasting direct, mais informatif)
            Get-DomainComputer -SPN | select name, serviceprincipalname
            ```
        *   **Détection (setspn.exe - Windows natif) :**
            ```cmd
            setspn -Q */*   # Lister tous les SPNs du domaine (peut être très long)
            setspn -T <DOMAINE.LOCAL> -Q */* # Cible un domaine spécifique
            # Filtrer pour les comptes utilisateurs :
            setspn -Q */* | findstr /B /C:"CN=Users" # Approximatif, dépend de la structure AD
            ```
        *   **Exploitation :** Voir section [05.B. Kerberoasting](../05-elevation-privileges/B-kerberoasting.md).

    *   **Délégations Kerberos Dangereuses (Non Contrainte, Contrainte, Basée sur les Ressources) :**
        *   **Détection (PowerView) :**
            ```powershell
            # Délégation Non Contrainte (Unconstrained)
            Get-DomainComputer -Unconstrained | select dnshostname, samaccountname
            Get-DomainUser -Unconstrained | select samaccountname

            # Délégation Contrainte (Constrained) - S4U2Self / S4U2Proxy
            Get-DomainUser -TrustedToAuth | select samaccountname, msds_allowedtodelegateto
            Get-DomainComputer -TrustedToAuth | select dnshostname, samaccountname, msds_allowedtodelegateto

            # Délégation Contrainte Basée sur les Ressources (RBCD)
            # Qui peut agir au nom d'autres sur CET ordinateur :
            Get-DomainComputer -Identity <NOM_ORDINATEUR_CIBLE> -Properties msDS-AllowedToActOnBehalfOfOtherIdentity
            # Lister tous les ordinateurs qui ont cet attribut configuré :
            Get-DomainComputer -LDAPFilter "(msDS-AllowedToActOnBehalfOfOtherIdentity=*)" -Properties msDS-AllowedToActOnBehalfOfOtherIdentity,dnshostname | select dnshostname, @{N="AllowedToAct";E={$_.('msDS-AllowedToActOnBehalfOfOtherIdentity') | ForEach-Object {(New-Object System.Security.Principal.SecurityIdentifier($_.BinaryValue,0)).Translate([System.Security.Principal.NTAccount])}}}
            ```
        *   **Exploitation :** Voir section [05.C. Abus de Délégation Kerberos](../05-elevation-privileges/C-delegation-kerberos.md).

    *   **Group Policy Objects (GPOs) avec mots de passe (Group Policy Preferences - GPP) :**
        *   Bien que patché (MS14-025), des backups anciens ou des fichiers XML orphelins peuvent exister.
        *   **Détection :** Chercher les fichiers `Groups.xml`, `Services.xml`, `ScheduledTasks.xml` dans SYSVOL (`\\<DOMAINE.LOCAL>\SYSVOL\<DOMAINE.LOCAL>\Policies\`) contenant `cpassword`.
            ```powershell
            Get-ChildItem "\\<DOMAINE.LOCAL>\SYSVOL\<DOMAINE.LOCAL>\Policies\" -Recurse -Include Groups.xml,Services.xml,ScheduledTasks.xml | Select-String -Pattern "cpassword"
            # PowerView
            Get-NetGPO -ComputerName <NOM_ORDINATEUR_POUR_APPLIQUER_GPO> | %{Get-ObjectAcl -ResolveGUIDs -Name $_.Name} # Pour les permissions sur les GPO
            Get-NetGPOGroup -ResolveGUIDs # Pour les GPP de groupes
            ```
        *   **Décrypter `cpassword` :** La clé AES est publique. PowerSploit a `Get-GPPPassword`.

## Points Clés à Observer (Politiques et Configurations)
*   Politique de mot de passe (longueur, complexité, verrouillage).
*   Utilisateurs connectés sur des machines clés (DCs, serveurs d'applications).
*   Partages SMB avec permissions faibles ou contenant des fichiers sensibles.
*   Comptes vulnérables à AS-REP Roasting ou Kerberoasting.
*   Configurations de délégation Kerberos.
*   Permissions sur les GPOs et présence de GPP avec credentials.
*   ACLs faibles sur des objets AD (utilisateurs, groupes, ordinateurs, OUs, GPOs) - voir section [04.B Énumération des ACLs](../04-post-compromission/B-enumeration-acls.md). 