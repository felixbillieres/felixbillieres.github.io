# IV.D. BloodHound et Analyse de Chemins d'Attaque

BloodHound est un outil graphique qui permet de visualiser les relations au sein d'un environnement Active Directory. Il utilise la théorie des graphes pour révéler des chemins d'attaque cachés et complexes qui seraient difficiles à identifier manuellement. C'est un outil indispensable pour la post-compromission et la planification du mouvement latéral.

## 1. Collecte de Données avec SharpHound

SharpHound est le collecteur officiel de données pour BloodHound. Il doit être exécuté sur une machine Windows (jointe au domaine ou avec une connectivité réseau aux DCs et autres machines).

*   **Méthodes de Collecte (`-c` ou `--CollectionMethods`) :**
    *   `Default` : Collecte les utilisateurs, groupes, ordinateurs, sessions, admins locaux, trusts. Bon point de départ.
    *   `All` : Collecte tout (Default + GPOs, OUs, ACLs, conteneurs, etc.). Le plus complet.
    *   `Session` : Collecte les sessions actives.
    *   `LoggedOn` : Collecte les utilisateurs connectés (plus précis que Session, utilise NetWkstaUserEnum).
    *   `ACL` : Collecte les ACLs sur les objets AD.
    *   `Group` : Collecte les membres des groupes.
    *   `LocalAdmin` : Énumère les membres du groupe Administrateurs local sur les machines.
    *   `GPOLocalGroup` : Énumère les membres des groupes locaux via les GPOs.
    *   `Trusts` : Collecte les relations de confiance du domaine.
    *   `Container` : Collecte les conteneurs et OUs.
    *   `ObjectProps` : Collecte certaines propriétés d'objets (ex: `msDS-AllowedToActOnBehalfOfOtherIdentity`).
    *   `RDP` : Énumère les membres du groupe "Remote Desktop Users".
    *   `DCOM` : Énumère les membres du groupe "Distributed COM Users".
    *   `PSRemote` : Énumère les membres du groupe "Remote Management Users".
    *   `SessionLoop` : Collecte les sessions en boucle (pour capturer des sessions éphémères).
    *   `DcOnly` : Collecte uniquement les données des DCs (utile pour limiter le bruit réseau).

*   **Exemples de Commandes SharpHound (PowerShell ou Exécutable) :**
    ```powershell
    # Depuis PowerShell (Invoke-BloodHound)
    # Importer PowerView.ps1 qui contient Invoke-BloodHound (SharpHound.ps1)
    # Import-Module .\SharpHound.ps1
    Invoke-BloodHound -CollectionMethod All -Domain <DOMAINE.LOCAL> -LDAPUser <USER_AD> -LDAPPass <PASSWORD_AD> -NoSaveCache
    Invoke-BloodHound -CollectionMethod Default,GPOLocalGroup,ACL -NoSaveCache -ZipFileName mydata.zip

    # Exécutable SharpHound.exe
    SharpHound.exe --CollectionMethods All --Domain <DOMAINE.LOCAL> --LDAPUser <USER_AD> --LDAPPass <PASSWORD_AD> --NoSaveCache
    SharpHound.exe -c Default,GPOLocalGroup,ACL --NoSaveCache --JsonFolder .\BloodHoundData --ZipFileName my_bloodhound_data.zip
    SharpHound.exe -c SessionLoop -d <DOMAINE.LOCAL> --Loopduration 02:00:00 --Loopinterval 00:05:00 # Boucle pendant 2h, collecte toutes les 5min

    # Options utiles :
    # --Domain <DOMAINE.LOCAL> : Spécifier le domaine à cibler.
    # --Stealth : Collecte uniquement via LDAP (moins de bruit, mais moins d'infos comme les sessions/admins locaux).
    # --LDAPUser / --LDAPPass : Utiliser des credentials spécifiques pour LDAP.
    # --NoSaveCache : Ne pas utiliser de fichier cache local (recommandé pour éviter les problèmes).
    # --JsonFolder .\PathToOutput : Spécifier le dossier de sortie pour les fichiers JSON.
    # --ZipFileName data.zip : Créer une archive ZIP des résultats.
    # --ExcludeDCs : Exclure les DCs de la collecte de sessions/admins locaux (réduit le bruit).
    # --ComputerFile computers.txt : Cibler des ordinateurs spécifiques pour la collecte de sessions/admins locaux.
    # --OutputPrefix <PREFIXE> : Ajouter un préfixe aux noms des fichiers JSON.
    ```
    Les fichiers JSON générés (ex: `*_users.json`, `*_groups.json`, `*_computers.json`, `*_sessions.json`, `*_acls.json`) doivent être importés dans l'interface BloodHound.

## 2. Installation et Utilisation de BloodHound

*   **Installation :**
    *   Télécharger la dernière version de BloodHound depuis le [GitHub officiel](https://github.com/BloodHoundAD/BloodHound).
    *   Nécessite Neo4j comme base de données backend. BloodHound fournit souvent un exécutable Neo4j packagé ou des instructions pour l'installer.
*   **Lancement :**
    1.  Démarrer le serveur Neo4j.
    2.  Lancer l'exécutable BloodHound.
    3.  Se connecter à la base de données Neo4j (les identifiants par défaut sont souvent `neo4j`/`neo4j`, à changer au premier lancement).
*   **Importation des Données :**
    *   Glisser-déposer les fichiers JSON (ou l'archive ZIP) générés par SharpHound dans l'interface BloodHound.
    *   Cliquer sur "Upload Data".

## 3. Analyse dans BloodHound

*   **Interface :**
    *   **Node Info :** Affiche les informations sur le nœud sélectionné (utilisateur, groupe, ordinateur).
    *   **Database Info :** Statistiques sur les données importées.
    *   **Search Bar :** Rechercher des nœuds spécifiques.
    *   **Pathfinding :** Trouver des chemins entre deux nœuds (ex: de l'utilisateur compromis vers "Domain Admins").
    *   **Pre-built Queries (Analysis Tab) :** Requêtes Cypher prédéfinies pour trouver des vulnérabilités courantes (ex: "Shortest Paths to Domain Admins", "Reachable High Value Targets", "Users with Foreign Group Membership").
*   **Requêtes Cypher Personnalisées :**
    Pour des analyses plus avancées, on peut écrire ses propres requêtes Cypher dans l'onglet "Raw Query".
    ```cypher
    // Exemples de requêtes Cypher simples :
    // Lister tous les Domain Admins
    MATCH (u:User)-[:MemberOf*1..]->(g:Group {name:'DOMAIN ADMINS@DOMAINE.LOCAL'}) RETURN u,g

    // Trouver les chemins les plus courts vers les Domain Admins depuis un utilisateur spécifique
    MATCH p = shortestPath((u:User {name:'COMPROMISED_USER@DOMAINE.LOCAL'})-[*1..]->(g:Group {name:'DOMAIN ADMINS@DOMAINE.LOCAL'})) RETURN p

    // Lister les ordinateurs où un utilisateur spécifique a des droits d'admin local
    MATCH (u:User {name:'USER@DOMAINE.LOCAL'})-[r:AdminTo]->(c:Computer) RETURN u,r,c

    // Lister les utilisateurs avec des SPNs pour Kerberoasting
    MATCH (u:User) WHERE u.hasspn = true RETURN u.name
    ```

## Points Clés de l'Analyse BloodHound
*   **Chemins vers les groupes à privilèges :** "Domain Admins", "Enterprise Admins", "Administrators" sur des serveurs clés.
*   **Sessions d'utilisateurs privilégiés :** Où sont connectés les admins ?
*   **Droits d'admin local :** Sur quelles machines l'utilisateur compromis (ou les groupes auxquels il appartient) a-t-il des droits d'admin local ?
*   **ACLs exploitables :** `GenericAll`, `WriteDacl`, `WriteProperty` sur des objets sensibles.
*   **Relations de confiance inter-domaines.**
*   **Configurations de délégation Kerberos.**
*   **GPOs liés à des objets intéressants.**

BloodHound est un outil puissant qui demande de la pratique pour être maîtrisé, mais il est essentiel pour comprendre la complexité des environnements AD modernes. 