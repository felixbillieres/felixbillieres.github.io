# IV.B. Énumération des ACLs et des Relations de Confiance (Post-Compromission)

Depuis un accès initial, même avec des privilèges limités, il est crucial d'énumérer les Access Control Lists (ACLs) sur les objets Active Directory et de comprendre les relations de confiance du domaine. Cela peut révéler des chemins d'escalade de privilèges ou de mouvement latéral.

## 1. Énumération des ACLs (Access Control Lists)

*   **Objectif :** Identifier les permissions que l'utilisateur compromis (ou les groupes auxquels il appartient) possède sur d'autres objets AD (utilisateurs, groupes, ordinateurs, GPOs, OUs, domaine).
*   **Points d'Intérêt :**
    *   Droits `GenericAll`, `GenericWrite`, `WriteDacl`, `WriteOwner`.
    *   Droits spécifiques comme `WriteProperty` sur des attributs sensibles (ex: `member` d'un groupe, `userPassword`, `msDS-AllowedToActOnBehalfOfOtherIdentity`).
    *   Droits étendus comme `User-Force-Change-Password`, `DS-Replication-Get-Changes` (DCSync).
*   **Outils et Commandes :**

    *   **PowerView (Windows) :**
        ```powershell
        # Importer PowerView
        # Import-Module .\PowerView.ps1

        # Lister les ACLs pour un objet spécifique (ex: un utilisateur)
        Get-ObjectAcl -SamAccountName "UtilisateurCible" -ResolveGUIDs | Format-Table ObjectDN, ActiveDirectoryRights, ObjectType, IdentityReference -AutoSize

        # Lister les ACLs pour un groupe
        Get-ObjectAcl -SamAccountName "GroupeCible" -ResolveGUIDs

        # Lister les ACLs pour un GPO (par nom)
        Get-ObjectAcl -ADSpath "LDAP://CN={GUID_GPO},CN=Policies,CN=System,DC=domaine,DC=local" -ResolveGUIDs

        # Trouver tous les objets où l'utilisateur actuel (ou un utilisateur spécifié) a des droits spécifiques
        # Ex: Où l'utilisateur 'attaquant' a GenericAll
        Find-InterestingDomainAcl -ResolveGUIDs | Where-Object {$_.IdentityReference -match "attaquant" -and $_.ActiveDirectoryRights -match "GenericAll"}

        # Lister les droits explicites d'un trustee (utilisateur/groupe) sur des objets
        Get-DomainObjectAcl -Identity "UtilisateurCible" -ResolveGUIDs | ? {$_.IdentityReference -match "NOM_ATTAQUANT_OU_GROUPE"}

        # Lister les objets où un trustee a des droits spécifiques (plus ciblé)
        # Exemple: Où 'Domain Users' peut écrire sur l'attribut 'member' d'un groupe
        # Get-DomainObjectAcl -SamAccountName "GroupeSensible" -ResolveGUIDs | ? {$_.IdentityReference -eq "DOMAIN\Domain Users" -and $_.ObjectType -eq "bf9679c0-0de6-11d0-a285-00aa003049e2" -and $_.ActiveDirectoryRights -match "WriteProperty"}
        # (bf9679c0-0de6-11d0-a285-00aa003049e2 est le GUID pour l'attribut 'member')
        ```

    *   **BloodHound (Collecte avec SharpHound) :**
        SharpHound collecte les informations sur les ACLs. L'analyse se fait ensuite dans l'interface BloodHound.
        ```powershell
        # Exécuter SharpHound (depuis une machine Windows jointe ou avec accès LDAP)
        # SharpHound.exe -c ACL --NoSaveCache
        # SharpHound.exe -c All,GPOLocalGroup,LoggedOn,ACL -d <DOMAINE.LOCAL> --NoSaveCache
        # Les fichiers JSON générés sont à importer dans BloodHound.
        ```
        Dans BloodHound, utiliser des requêtes Cypher pour trouver des chemins basés sur les ACLs (ex: `GenericAll`, `WriteDacl` vers des objets privilégiés).

    *   **dsacls.exe (Windows natif) :**
        ```cmd
        dsacls "CN=UtilisateurCible,CN=Users,DC=domaine,DC=local"
        dsacls "\\<IP_DC>\CN=UtilisateurCible,CN=Users,DC=domaine,DC=local"
        ```

    *   **Module ActiveDirectory PowerShell :**
        ```powershell
        (Get-Acl "AD:CN=UtilisateurCible,CN=Users,DC=domaine,DC=local").Access | Format-Table IdentityReference, ActiveDirectoryRights, AccessControlType, ObjectType, InheritanceType
        ```

    *   **ADExplorer (Sysinternals) :**
        Permet d'inspecter graphiquement l'attribut `nTSecurityDescriptor` des objets AD.

## 2. Énumération des Relations de Confiance (Trusts)

*   **Objectif :** Identifier les relations de confiance entre le domaine actuel et d'autres domaines (dans la même forêt ou des forêts externes). Les trusts peuvent offrir des chemins d'accès à d'autres domaines.
*   **Types de Trusts :**
    *   **Parent/Child :** Bidirectionnel et transitif par défaut.
    *   **Tree-Root :** Bidirectionnel et transitif par défaut.
    *   **Forest :** Peut être unidirectionnel ou bidirectionnel, transitif ou non transitif.
    *   **External :** Non transitif, peut être unidirectionnel ou bidirectionnel.
    *   **Shortcut :** Transitif, pour optimiser l'authentification entre domaines éloignés dans une forêt.
*   **Outils et Commandes :**

    *   **PowerView :**
        ```powershell
        # Lister tous les trusts du domaine actuel
        Get-DomainTrust | Format-Table SourceName, TargetName, TrustType, TrustDirection, TrustAttributes, IsTreeParent, IsTreeRoot, IsForestTrust
        # Lister les trusts pour un domaine spécifique
        Get-DomainTrust -Domain <AUTRE_DOMAINE.LOCAL>
        # Lister tous les domaines de la forêt
        Get-ForestDomain | Select-Object Name, Forest, DomainControllers
        # Mapper les trusts de la forêt
        Get-ForestTrust -Forest <NOM_FORET>
        Get-NetForestTrust # (alias pour Get-ForestTrust)
        ```

    *   **nltest.exe (Windows natif) :**
        ```cmd
        nltest /domain_trusts               # Trusts du domaine de la machine
        nltest /domain_trusts /all_trusts   # Tous les trusts de la forêt (si DC)
        nltest /server:<NOM_SERVEUR> /domain_trusts # Trusts pour un serveur spécifique
        ```

    *   **Module ActiveDirectory PowerShell :**
        ```powershell
        Get-ADTrust -Filter * | Format-Table Name, Source, Target, TrustDirection, TrustType, SelectiveAuthentication
        Get-ADForest | Select-Object Domains, RootDomain, SchemaMaster, DomainNamingMaster
        ```

    *   **BloodHound (Collecte avec SharpHound) :**
        SharpHound collecte les informations sur les trusts.
        ```powershell
        # SharpHound.exe -c Trusts --NoSaveCache
        # Ou inclus dans la collection 'All'
        ```
        Dans BloodHound, les trusts sont visualisables et peuvent être utilisés pour trouver des chemins inter-domaines.

## Points Clés à Analyser
*   **ACLs :**
    *   Quels objets l'utilisateur compromis peut-il contrôler ou modifier ?
    *   Y a-t-il des ACLs menant à des comptes/groupes privilégiés (Domain Admins, Enterprise Admins, admins locaux de serveurs clés) ?
    *   Des GPOs modifiables qui s'appliquent à des ordinateurs/utilisateurs intéressants ?
*   **Trusts :**
    *   Vers quels domaines peut-on potentiellement se déplacer ?
    *   Le trust est-il transitif ? Bidirectionnel ?
    *   La "Selective Authentication" est-elle activée (nécessite des permissions explicites pour s'authentifier à travers le trust) ?

L'exploitation des ACLs est détaillée dans la section [05.A. Exploitation des ACLs Vulnérables](../05-elevation-privileges/A-exploitation-acls.md).
Les attaques inter-domaines via trusts sont plus avancées et dépendent des configurations spécifiques. 