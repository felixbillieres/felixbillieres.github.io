# IV.A. Énumération Locale Approfondie

Une fois un accès obtenu sur une machine, une énumération locale détaillée est essentielle pour comprendre le système, trouver des informations sensibles, et identifier des vecteurs d'élévation de privilèges locaux ou de mouvement latéral.

## 1. Informations Système et Réseau

*   **Objectif :** Collecter des informations de base sur le système d'exploitation, l'architecture, les patchs, la configuration réseau, et l'appartenance au domaine.
*   **Commandes (Windows CMD/PowerShell) :**
    ```cmd
    REM Informations Système
    systeminfo
    hostname
    whoami /all
    echo %USERNAME%
    echo %USERDOMAIN%
    set                             # Variables d'environnement
    ver
    wmic qfe get Caption,Description,HotFixID,InstalledOn # Patchs installés

    REM Informations Réseau
    ipconfig /all
    arp -a
    route print
    netstat -ano                  # Connexions actives, ports en écoute
    netsh advfirewall show allprofiles # Configuration du pare-feu Windows
    nltest /domain_trusts         # Relations de confiance du domaine (si machine jointe)
    nltest /dsgetdc:%USERDNSDOMAIN% # Trouver un DC
    ```
    ```powershell
    # PowerShell équivalents et améliorations
    Get-ComputerInfo
    $env:USERNAME
    $env:USERDOMAIN
    Get-HotFix
    Get-NetIPConfiguration -Detailed
    Get-NetNeighbor
    Get-NetRoute
    Get-NetTCPConnection
    Get-NetFirewallProfile -Profile Domain,Private,Public | Select-Object Name, Enabled
    Get-NetFirewallRule | Where-Object {$_.Enabled -eq "True" -and $_.Direction -eq "Inbound"} | Select-Object DisplayName, Enabled, Direction, Action
    (Get-ADDomainController -Discover -DomainName $env:USERDNSDOMAIN).HostName
    ```

## 2. Utilisateurs, Groupes Locaux et Sessions

*   **Objectif :** Identifier les utilisateurs locaux, les groupes (surtout `Administrators`), et les sessions actives.
*   **Commandes :**
    ```cmd
    net user
    net user <utilisateur>
    net localgroup
    net localgroup Administrators
    query user                    # Sessions RDP et console (qwinsta)
    quser
    ```
    ```powershell
    Get-LocalUser
    Get-LocalGroup
    Get-LocalGroupMember -Group "Administrators"
    Get-LoggedOnUser # Nécessite des outils comme PSTools (PsLoggedon) ou des scripts PowerShell
    ```

## 3. Processus, Services et Tâches Planifiées

*   **Objectif :** Identifier les processus en cours (surtout ceux avec des privilèges élevés), les services (et leurs permissions), et les tâches planifiées (potentiel de persistance ou d'exécution de code).
*   **Commandes :**
    ```cmd
    tasklist /v                   # Processus détaillés
    tasklist /svc                 # Processus et services associés
    wmic process get Caption,CommandLine,ProcessId,ParentProcessId,ExecutablePath
    net start                     # Services démarrés
    sc query                      # Tous les services
    sc qc <nom_service>           # Configuration d'un service (chemin binaire, compte de service)
    schtasks /query /fo LIST /v   # Tâches planifiées détaillées
    ```
    ```powershell
    Get-Process -IncludeUserName
    Get-Service | Select-Object Name, DisplayName, Status, StartType, PathName
    Get-ScheduledTask | Select-Object TaskName, TaskPath, State, Actions, Principal
    (Get-ScheduledTask <NOM_TACHE>).Actions
    (Get-ScheduledTask <NOM_TACHE>).Principal
    ```
    *   **Outils :** `accesschk.exe` (Sysinternals) pour vérifier les permissions sur les services/processus.
        ```cmd
        accesschk.exe -uwcqv "Authenticated Users" * /accepteula # Services modifiables par les utilisateurs authentifiés
        accesschk.exe -ucqv <NOM_SERVICE>
        ```

## 4. Recherche de Credentials et Informations Sensibles

*   **Objectif :** Trouver des mots de passe en clair, des hashes, des clés API, des fichiers de configuration sensibles, etc.
*   **Emplacements et Techniques :**
    *   **Fichiers de configuration :** `web.config`, `appsettings.json`, scripts PowerShell/Batch (`.ps1`, `.bat`), fichiers `unattend.xml`, `SAM`/`SYSTEM` (backups).
        ```cmd
        dir /s /b *pass*.*
        dir /s /b *.config
        findstr /si "password" *.xml *.ini *.txt *.config *.ps1
        ```
        ```powershell
        Get-ChildItem -Path C:\ -Recurse -Include "*.config","*.xml","*.ini","*.txt","*.ps1","*unattend.xml*" -ErrorAction SilentlyContinue | Select-String -Pattern "password","apikey","secret"
        ```
    *   **SAM/SYSTEM (pour hashes locaux) :**
        ```cmd
        reg save HKLM\SAM C:\temp\sam.save
        reg save HKLM\SYSTEM C:\temp\system.save
        # Nécessite des droits admin. Extraire ensuite avec Mimikatz, secretsdump.py.
        ```
    *   **LSASS (Local Security Authority Subsystem Service) :**
        *   **Mimikatz (nécessite des droits admin/SYSTEM) :**
            ```powershell
            # Invoke-Mimikatz (PowerSploit)
            Invoke-Mimikatz -Command '"privilege::debug" "sekurlsa::logonpasswords"'
            # mimikatz.exe
            privilege::debug
            sekurlsa::logonpasswords
            sekurlsa::tickets /export # Exporter les tickets Kerberos
            ```
        *   **Dump de LSASS (puis analyse hors ligne) :**
            ```cmd
            # Via Task Manager (clic droit sur lsass.exe -> Create dump file)
            # Via procdump (Sysinternals)
            procdump.exe -accepteula -ma lsass.exe lsass.dmp
            ```
    *   **Historique PowerShell :**
        ```powershell
        Get-Content (Get-PSReadlineOption).HistorySavePath
        ```
    *   **Credentials Manager (Vault) :**
        ```cmd
        cmdkey /list
        ```
        ```powershell
        # Utiliser des outils comme VaultPasswordView (NirSoft) ou des scripts PowerShell.
        # PowerSploit: Get-VaultCredential
        ```
    *   **Logiciels installés :** Certains logiciels stockent des credentials (clients FTP, SGBD, navigateurs).
        *   **Navigateurs :** Outils comme `LaZagne`, `SharpChromium`.
    *   **Partages réseau montés.**
    *   **Clés SSH privées.**

## 5. Logiciels Installés et Vulnérabilités Locales

*   **Objectif :** Identifier les logiciels installés, leurs versions, et rechercher des vulnérabilités connues pouvant mener à une élévation de privilèges locale.
*   **Commandes :**
    ```cmd
    wmic product get name,version,vendor
    ```
    ```powershell
    Get-WmiObject -Class Win32_Product | Select-Object Name, Version, Vendor
    # Pour les applications non MSI (plus complet) :
    Get-ItemProperty HKLM:\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\* | Select-Object DisplayName, DisplayVersion, Publisher, InstallDate | Format-Table –AutoSize
    Get-ItemProperty HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\* | Select-Object DisplayName, DisplayVersion, Publisher, InstallDate | Format-Table –AutoSize
    ```
*   **Outils d'audit de vulnérabilités locales :** `Sherlock.ps1`, `Watson.exe`, `Seatbelt.exe`, `WinPEAS.bat/exe`.
    ```powershell
    # Sherlock
    # Find-AllVulns
    ```

Cette énumération doit être méthodique et les résultats soigneusement documentés pour les étapes suivantes. 