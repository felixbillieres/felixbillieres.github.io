# IV.C. Énumération ADCS (Active Directory Certificate Services)

Active Directory Certificate Services (AD CS) est une infrastructure à clé publique (PKI) intégrée à Windows Server. Des configurations incorrectes ou vulnérables d'AD CS peuvent offrir des chemins d'escalade de privilèges puissants, souvent jusqu'à Administrateur de Domaine. L'énumération d'AD CS est donc une étape critique en post-compromission.

## 1. Découverte des Serveurs d'Autorité de Certification (CA)

*   **Objectif :** Identifier les serveurs CA dans le domaine.
*   **Outils et Commandes :**

    *   **Certutil (Windows natif) :**
        ```cmd
        certutil.exe -config - -ping
        certutil.exe -dump
        # Lister les CAs du domaine via la configuration AD (si accessible)
        certutil.exe -dsPublished Öffentlichkeitsarbeit
        certutil.exe -dsPublished Unternehmens
        ```

    *   **PowerView :**
        ```powershell
        # Rechercher les objets pKIEnrollmentService et msPKI-Enterprise-CA
        Get-DomainObject -LDAPFilter "(objectClass=pKIEnrollmentService)" | Select-Object distinguishedName, name, dNSHostName
        Get-DomainObject -LDAPFilter "(objectClass=msPKI-Enterprise-CA)" | Select-Object distinguishedName, name, dNSHostName
        # Les CAs sont souvent publiées dans :
        # CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=Configuration,DC=domain,DC=local
        ```

    *   **Certipy (outil spécialisé Python) :**
        ```bash
        # Découvrir les CAs
        certipy find -u <user>@<DOMAINE.LOCAL> -p <password> -dc-ip <IP_DC>
        # Avec hash NTLM
        certipy find -u <user>@<DOMAINE.LOCAL> -hashes <LM_HASH>:<NT_HASH> -dc-ip <IP_DC>
        # Lister les CAs et leurs templates
        certipy ca -ca <NOM_CA> -u <user>@<DOMAINE.LOCAL> -p <password> -dc-ip <IP_DC> -enum-templates
        ```

    *   **CrackMapExec (module `adcs`) :**
        ```bash
        crackmapexec ldap <IP_DC_OU_PLAGE_LDAP> -u <user> -p <password> -M adcs
        ```

## 2. Énumération des Templates de Certificats

*   **Objectif :** Identifier les templates de certificats, leurs configurations, et surtout les permissions d'enrôlement et les droits qu'ils accordent.
*   **Points d'intérêt pour les vulnérabilités (ESC1-ESC8+) :**
    *   **ESC1 :** Permissions d'enrôlement pour un template permettant de spécifier un SAN (Subject Alternative Name) arbitraire, et le template est configuré pour l'authentification client ou Smart Card Logon.
    *   **ESC2 :** Permissions d'enrôlement pour un template "Agent d'inscription" (Enrollment Agent).
    *   **ESC3 :** Permissions de modification sur un template de certificat (changer les permissions d'enrôlement, ajouter des EKUs, etc.).
    *   **ESC4 :** Permissions d'enrôlement pour un template permettant l'authentification client, et l'utilisateur a des droits de `WriteDacl` sur l'objet utilisateur/ordinateur cible (pour ajouter le certificat à `altSecurityIdentities`).
    *   **ESC8 (et variantes) :** Vulnérabilités dans les configurations de la CA elle-même (ex: `EDITF_ATTRIBUTESUBJECTALTNAME2` flag sur la CA).
*   **Outils et Commandes :**

    *   **Certipy :**
        ```bash
        # Énumérer tous les templates et leurs configurations
        certipy find -u <user>@<DOMAINE.LOCAL> -p <password> -dc-ip <IP_DC> -templates -enabled
        # Identifier les templates vulnérables
        certipy find -u <user>@<DOMAINE.LOCAL> -p <password> -dc-ip <IP_DC> -vulnerable
        # Analyser un template spécifique
        certipy template <NOM_TEMPLATE> -u <user>@<DOMAINE.LOCAL> -p <password> -dc-ip <IP_DC>
        ```

    *   **PSPKIAudit (PowerShell) :**
        ```powershell
        # Importer le module
        # Get-PKCertificateTemplate | ?{$_.Name -eq "WebServer"} | Get-PKCertificateTemplateAcl
        # Get-PKCertificateTemplate | Get-PKEnumFieldsFromCertTemplate -FieldName SubjectName,AlternateSubjectName,EKU
        # Des commandes plus spécifiques pour auditer les templates existent.
        ```

    *   **ADExplorer (Sysinternals) :**
        Naviguer vers `CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=domain,DC=local` pour inspecter les attributs des templates (`msPKI-Cert-Template-OID`, `pKIExtendedKeyUsage`, `msPKI-RA-Signature`, `mspki-enrollment-flag`, `ntSecurityDescriptor`).

## 3. Énumération des Permissions sur la CA et les Templates

*   **Objectif :** Vérifier qui a des droits de gestion sur la CA (`ManageCA`, `ManageCertificates`) ou sur les templates (`WriteProperty`, `WriteDacl`, `Enroll`).
*   **Outils :**
    *   **Certipy :**
        ```bash
        # Lister les permissions sur une CA
        certipy ca <NOM_CA> -u <user>@<DOMAINE.LOCAL> -p <password> -dc-ip <IP_DC> -list-access
        # Lister les permissions sur un template
        certipy template <NOM_TEMPLATE> -u <user>@<DOMAINE.LOCAL> -p <password> -dc-ip <IP_DC> -list-access
        ```
    *   **PowerView / Module ActiveDirectory PowerShell :**
        ```powershell
        # Pour un template (exemple)
        (Get-ACL "AD:CN=User,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=domain,DC=local").Access
        # Pour la CA (exemple)
        (Get-ACL "AD:CN=NomCA,CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=Configuration,DC=domain,DC=local").Access
        ```

## Outils Clés pour l'Audit AD CS
*   **Certipy :** L'outil de référence actuel pour l'audit et l'exploitation d'AD CS.
*   **PSPKIAudit :** Module PowerShell utile pour l'énumération.
*   **Certutil :** Outil natif pour des interactions basiques.
*   **ADExplorer :** Pour une inspection manuelle des objets AD.

L'exploitation des vulnérabilités AD CS est traitée dans la section [05.D. Exploitation de Services (Exchange, ADCS)](../05-elevation-privileges/D-exploitation-services.md). 