# VIII.A. DCSync

DCSync est une technique qui permet à un attaquant d'imiter le comportement d'un contrôleur de domaine (DC) et de demander la réplication des données d'identification (principalement les hashes NTLM et parfois les clés Kerberos) pour n'importe quel compte du domaine, y compris les comptes privilégiés comme `krbtgt`, les administrateurs du domaine, et les comptes de service.

Cette attaque ne nécessite pas d'exécuter du code sur un DC, mais requiert des privilèges spécifiques au sein d'Active Directory.

## Prérequis (Droits Nécessaires)

Pour exécuter une attaque DCSync, le compte utilisé par l'attaquant doit avoir au minimum les droits suivants sur l'objet Domaine (ou parfois sur l'objet `Domain Controllers` OU) :
*   `DS-Replication-Get-Changes` (GUID: `1131f6aa-9c07-11d1-f79f-00c04fc2dcd2`)
*   `DS-Replication-Get-Changes-All` (GUID: `1131f6ad-9c07-11d1-f79f-00c04fc2dcd2`)
*   Optionnellement, `DS-Replication-Get-Changes-In-Filtered-Set` (GUID: `89e95b76-444d-4c62-991a-0facbeda640c`)

Ces droits sont typiquement détenus par :
*   Administrateurs du Domaine
*   Administrateurs de l'Entreprise
*   Contrôleurs de Domaine (comptes machine)
*   Parfois, des comptes de service mal configurés (ex: pour des logiciels de sauvegarde/réplication).

## Outils et Commandes

*   **Mimikatz (Windows) :**
    L'outil de prédilection pour DCSync.
    ```
    # Demander le hash NTLM du compte krbtgt
    lsadump::dcsync /domain:<DOMAINE_FQDN> /user:krbtgt
    *   **Microsoft Defender for Identity (MDI) / Azure ATP :** Peut détecter les tentatives de DCSync provenant de machines non-DC ou d'utilisateurs inhabituels.
    *   **Journaux d'Événements Windows :** L'événement `4662` (Une opération a été effectuée sur un objet) sur les DCs peut être activé pour auditer l'accès aux objets de l'annuaire, en particulier pour les droits de réplication. Cependant, cela peut générer beaucoup de bruit. Rechercher les accès avec les GUIDs de droits de réplication.
    *   **Surveillance du Réseau :** Le trafic de réplication DRSUAPI (Directory Replication Service Remote Protocol) provenant de sources inattendues.

*   **Prévention / Mitigation :**
    *   **Principe de Moindre Privilège :** Limiter drastiquement le nombre de comptes ayant les droits de réplication. Auditer régulièrement qui possède ces droits.
    *   **Protection des Comptes Privilégiés :** Sécuriser les comptes d'administrateurs et les comptes machines des DCs.
    *   **Segmentation :** Bien que DCSync n'implique pas d'exécution de code sur le DC, la compromission initiale du compte avec les droits nécessaires est souvent le point de départ.
    *   **Changement Régulier du Mot de Passe `krbtgt` :** Si le hash `krbtgt` est compromis, il doit être changé deux fois.

DCSync est l'une des attaques les plus puissantes contre Active Directory car elle permet d'obtenir les "clés du royaume" (en particulier le hash `krbtgt`) de manière relativement discrète si les droits sont déjà acquis. 