# VIII.B. Abus des Relations d'Approbation (Trusts)

Les relations d'approbation (trusts) dans Active Directory permettent aux utilisateurs d'un domaine d'accéder à des ressources dans un autre domaine. Si un domaine est compromis, ces relations peuvent être abusées pour étendre la compromission à d'autres domaines approuvés (trusting domains) ou même à d'autres forêts.

## Types de Relations d'Approbation

*   **Parent-Enfant (Parent-Child Trust) :** Bidirectionnelle et transitive, créée automatiquement lorsqu'un nouveau domaine est ajouté à une arborescence existante.
*   **Arborescence (Tree-Root Trust) :** Bidirectionnelle et transitive, créée automatiquement lorsqu'une nouvelle arborescence est ajoutée à une forêt existante.
*   **Raccourci (Shortcut Trust) :** Peut être unidirectionnelle ou bidirectionnelle, transitive ou non transitive. Créée manuellement pour optimiser les authentifications entre des domaines éloignés dans une forêt.
*   **Approbation de Forêt (Forest Trust) :** Peut être unidirectionnelle ou bidirectionnelle, transitive (au sein de chaque forêt). Créée manuellement entre deux forêts distinctes.
*   **Approbation Externe (External Trust) :** Unidirectionnelle ou bidirectionnelle, non transitive. Créée manuellement entre des domaines de forêts différentes ou un domaine AD et un domaine NT4/Kerberos externe.
*   **Approbation de Domaine Kerberos (Realm Trust) :** Peut être unidirectionnelle ou bidirectionnelle, transitive ou non transitive. Utilisée pour approuver des domaines Kerberos non-Windows.

## Vecteurs d'Attaque Communs

1.  **Golden Ticket Inter-Domaines/Forêts (SID History & Trust Keys) :**
    *   **Description :** Si un attaquant compromet le compte `krbtgt` d'un domaine (`DOMAINE_A`), il peut forger un Golden Ticket pour ce domaine. Si `DOMAINE_A` a une relation d'approbation avec `DOMAINE_B`, l'attaquant peut tenter d'utiliser ce Golden Ticket pour accéder à des ressources dans `DOMAINE_B`.
    *   **SID History :** L'attribut `SIDHistory` permet à un compte d'un domaine d'avoir les identifiants de sécurité (SIDs) d'un autre domaine (souvent utilisé lors de migrations). Si un attaquant forge un Golden Ticket dans `DOMAINE_A` et y inclut le SID d'un groupe privilégié de `DOMAINE_B` (ex: `DOMAINE_B\Admins du Domaine`) dans le champ `ExtraSids` (ou via `SIDHistory` s'il peut le manipuler), il peut potentiellement obtenir des privilèges dans `DOMAINE_B`. Cela fonctionne particulièrement bien avec les approbations de forêt où le SID `BUILTIN\Administrators` (S-1-5-32-544) ou `Enterprise Admins` (pour le domaine racine de la forêt) peut être utilisé.
    *   **Clés d'Approbation (Trust Keys) :** Pour les approbations inter-forêts, des clés d'approbation (mots de passe) sont utilisées. Si un attaquant peut obtenir la clé d'approbation (ex: via Mimikatz `lsadump::trust`), il peut forger des tickets inter-forêts.
    *   **Outils :** Mimikatz (`kerberos::golden`), Rubeus.

2.  **Pass-the-Ticket / Overpass-the-Hash à Travers les Approbations :**
    *   **Description :** Si un utilisateur de `DOMAINE_A` a des droits légitimes sur une ressource dans `DOMAINE_B`, et que l'attaquant a compromis le compte de cet utilisateur (ou son hash/ticket), il peut utiliser ces credentials pour accéder à la ressource dans `DOMAINE_B`.
    *   **Technique :** Obtenir un TGS pour un service dans le domaine approuvé.
        ```powershell
        # Avec Rubeus, si un TGT pour DOMAINE_A\Utilisateur est injecté
        # Demander un TGS pour le service CIFS sur SRV_DOMB.DOMAINE_B.LOCAL
        Rubeus.exe sgettgs /service:CIFS/SRV_DOMB.DOMAINE_B.LOCAL /ptt
        # dir \\SRV_DOMB.DOMAINE_B.LOCAL\C$
        ```

3.  **Exploitation de Comptes Privilégiés avec Accès Inter-Domaines :**
    *   **Description :** Rechercher des utilisateurs ou des groupes de `DOMAINE_A` qui sont membres de groupes privilégiés dans `DOMAINE_B` (ex: `DOMAINE_A\Admin_Utilisateur` membre de `DOMAINE_B\Administrateurs Locaux` sur un serveur de `DOMAINE_B`).
    *   **Outils :** BloodHound, PowerView (`Get-NetDomainTrust`, `Get-NetForestTrust`, `Find-ForeignUser`, `Find-ForeignGroupMember`).

4.  **Attaque "Printer Bug" ou Coercition d'Authentification à Travers les Approbations :**
    *   **Description :** Si une machine dans `DOMAINE_A` peut forcer une authentification d'une machine de `DOMAINE_B` (ex: un DC de `DOMAINE_B`) vers un relais NTLM contrôlé par l'attaquant, et si la signature SMB n'est pas appliquée, l'attaquant peut relayer cette authentification vers d'autres machines dans `DOMAINE_B` ou même `DOMAINE_A`.
    *   **Prérequis :** Vulnérabilité de coercition, relais NTLM possible, absence de signature SMB.

5.  **Abus de la Délégation Kerberos Non Contrainte à Travers les Approbations :**
    *   **Description :** Si un compte machine (ex: `SRV_DOMA`) dans `DOMAINE_A` est configuré pour la délégation non contrainte, et qu'un administrateur de `DOMAINE_B` s'authentifie sur un service hébergé par `SRV_DOMA`, le TGT de l'administrateur de `DOMAINE_B` sera stocké dans LSASS sur `SRV_DOMA`. L'attaquant peut alors extraire ce TGT et l'utiliser pour accéder à des ressources dans `DOMAINE_B`.

## Énumération des Approbations

*   **PowerView :**
    ```powershell
    Get-NetDomainTrust
    Get-NetForestTrust
    (Get-NetDomainTrust -Domain <DOMAINE_CIBLE>).TrustType # Voir le type (ParentChild, Forest, External, etc.)
    (Get-NetDomainTrust -Domain <DOMAINE_CIBLE>).TrustAttributes # Voir les attributs (ex: TGT_DELEGATION pour la délégation inter-forêts)
    ```
*   **`nltest` (natif Windows) :**
    ```batch
    nltest /domain_trusts
    nltest /dclist:<NOM_DOMAINE_APPROUVE>
    ```
*   **BloodHound :** Visualise les relations d'approbation et les chemins d'attaque potentiels.

## Considérations de Sécurité et Contre-Mesures

*   **Principe de Moindre Privilège :** Ne créer que les approbations nécessaires. Préférer les approbations unidirectionnelles si possible.
*   **Filtrage SID (SID Filtering / Quarantine) :** Activé par défaut sur les approbations externes et de forêt. Empêche les SIDs de domaines "étrangers" (non approuvés directement ou via la chaîne de transitivité) d'être utilisés, limitant l'impact de `SIDHistory` malveillant. Ne pas désactiver sans une raison valable.
*   **Authentification Sélective (Selective Authentication) :** Pour les approbations de forêt ou externes, permet de spécifier explicitement quels utilisateurs/groupes du domaine approuvé peuvent s'authentifier sur quelles machines du domaine approbateur. Plus granulaire et sécurisé.
*   **Désactiver la Délégation Non Contrainte :** Surtout sur les systèmes critiques et ceux accessibles depuis d'autres domaines.
*   **Surveillance :** Surveiller les tentatives d'authentification inter-domaines suspectes, l'utilisation de `SIDHistory`.
*   **Sécuriser les Clés d'Approbation :** Les mots de passe des approbations doivent être forts.
*   **Patch Management :** Pour les vulnérabilités de coercition.

L'abus des relations d'approbation est une technique clé pour les mouvements latéraux étendus et la domination de forêts entières. 