# VIII.D. Prise de Contrôle des Contrôleurs de Domaine

Obtenir un accès administratif direct et persistant sur un ou plusieurs contrôleurs de domaine (DCs) est un objectif majeur pour la domination du domaine. Un DC compromis donne accès à la base de données NTDS.DIT (contenant tous les hashes du domaine), permet de manipuler la réplication, et d'exécuter des commandes avec les plus hauts privilèges.

## Vecteurs d'Accès Initiaux aux DCs

Si les droits de type DCSync ne sont pas encore obtenus, l'attaquant peut cibler directement les DCs :

1.  **Exploitation de Vulnérabilités :**
    *   **Vulnérabilités non patchées :** Zerologon (CVE-2020-1472), PrintNightmare (si le service Spouleur est actif sur un DC), etc.
    *   **Services tiers vulnérables :** Logiciels d'administration, agents de sauvegarde, antivirus installés sur les DCs.

2.  **Mots de Passe Faibles ou Réutilisés pour des Comptes de Service / Admin Local sur DC :**
    *   Bien que le compte Administrateur local soit désactivé par défaut sur les DCs après promotion, d'autres comptes pourraient exister ou le compte DSRM pourrait être mal configuré.
    *   Des comptes de service s'exécutant sur les DCs avec des mots de passe faibles.

3.  **Pass-the-Hash / Pass-the-Ticket :**
    *   Si le hash ou le ticket d'un compte ayant des droits d'admin local sur un DC (ou membre d'un groupe comme `Domain Admins`, `Enterprise Admins`, `BUILTIN\Administrators` du domaine) est obtenu.

4.  **Relais NTLM vers des Services sur le DC :**
    *   Si un service sur le DC (ex: LDAP sans signature, HTTP sur AD CS si installé sur DC) est vulnérable au relais NTLM et que la signature SMB n'est pas forcée.

5.  **Kerberoasting d'un Compte de Service avec Droits sur le DC :**
    *   Si un compte de service kerberoastable a, par une mauvaise configuration, des droits d'admin sur un DC.

## Une Fois l'Accès Obtenu (Admin Local ou Équivalent sur DC)

1.  **Dump de LSASS :**
    *   Utiliser Mimikatz (`sekurlsa::logonpasswords`, `sekurlsa::krbtgt`), ProcDump + analyse hors ligne.
    *   Objectif principal : Obtenir le hash NTLM du compte `krbtgt` et d'autres comptes privilégiés.

2.  **Accès à NTDS.DIT :**
    *   **Volume Shadow Copy (VSS) :**
        ```batch
        # Créer une copie shadow
        vssadmin create shadow /for=C:
        # Copier ntds.dit et SYSTEM hive depuis la copie shadow
        copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopyX\Windows\NTDS\ntds.dit C:\temp\
        copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopyX\Windows\System32\config\SYSTEM C:\temp\
        # Supprimer la copie shadow
        vssadmin delete shadows /all /quiet
        ```
    *   **Utilisation de `ntdsutil.exe` (Install From Media - IFM) :**
        ```batch
        ntdsutil "activate instance ntds" "ifm" "create full C:\temp\ifm" q q
        # ntds.dit sera dans C:\temp\ifm\Active Directory\
        # SYSTEM hive sera dans C:\temp\ifm\registry\
        ```
    *   **Outils tiers :** `Invoke-NinjaCopy`.
    *   **Extraction des Hashes depuis NTDS.DIT :**
        Utiliser Impacket (`secretsdump.py` localement sur le fichier), `esentutl.exe` pour réparer/défragmenter si nécessaire, puis `NTDSParse.py` ou des scripts PowerShell.
        ```bash
        # Avec secretsdump.py (sur une machine Linux avec les fichiers copiés)
        secretsdump.py -ntds ntds.dit -system SYSTEM LOCAL -outputfile hashes.txt
        ```

3.  **Persistance sur le DC :**
    *   **Techniques de persistance locales classiques :** Services, tâches planifiées, mais avec un risque de détection plus élevé sur un DC.
    *   **Skeleton Key :** (Voir [VIII.B Persistance au Niveau du Domaine](../07-persistance/B-persistance-domaine.md) et [VIII.C Attaques Kerberos Avancées](./C-attaques-kerberos-avancees.md)).
    *   **Modification du compte DSRM :** Synchroniser son hash avec un compte de domaine connu ou le modifier (voir [VII.B Persistance au Niveau du Domaine](../07-persistance/B-persistance-domaine.md)).
    *   **DLL Hijacking sur des services du DC.**
    *   **Security Support Provider (SSP) malveillant :** Injecter un SSP personnalisé dans LSASS pour capturer les mots de passe en clair. Très invasif et risqué. Mimikatz peut l'installer (`misc::memssp`).

4.  **Manipulation de la Réplication (DCShadow) :**
    *   Si l'attaquant contrôle un DC (ou a les droits pour enregistrer un nouveau DC), il peut utiliser DCShadow pour injecter des objets ou modifier des attributs dans AD de manière furtive.
    *   Outils : Mimikatz (`lsadump::dcshadow`).

## Sécurisation des Contrôleurs de Domaine

*   **Surface d'Attaque Minimale :**
    *   Aucun rôle ou logiciel inutile sur les DCs.
    *   Pas de navigation internet depuis les DCs.
    *   Limiter l'accès physique et réseau.
*   **Patch Management Rigoureux.**
*   **Comptes Privilégiés :**
    *   Mots de passe uniques et très forts pour tous les comptes admin et de service sur les DCs.
    *   Utiliser des stations d'administration sécurisées (PAWs - Privileged Access Workstations) pour administrer les DCs.
    *   Le groupe `BUILTIN\Administrators` sur un DC a des droits de domaine. Le protéger comme `Domain Admins`.
*   **Protection LSA (RunAsPPL) et Credential Guard.**
*   **Surveillance et Détection :**
    *   EDR sur les DCs.
    *   Microsoft Defender for Identity.
    *   Surveillance des journaux d'événements (création de processus, connexions, modifications de services, accès à LSASS).
    *   Surveiller les tentatives de dump de NTDS.DIT.
*   **Désactiver le service Spouleur d'impression sur les DCs.**
*   **Configuration sécurisée de la délégation.**

La compromission d'un DC est souvent synonyme de "game over" pour la sécurité du domaine. Leur protection est primordiale. 