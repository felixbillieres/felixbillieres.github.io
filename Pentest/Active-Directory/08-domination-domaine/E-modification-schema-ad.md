# VIII.E. Modification du Schéma Active Directory (Risqué)

La modification du schéma Active Directory est une technique de domination de domaine extrêmement puissante mais aussi très risquée et rarement nécessaire. Le schéma définit les types d'objets et d'attributs qui peuvent exister dans la forêt AD. Le modifier de manière incorrecte peut avoir des conséquences désastreuses et irréversibles sur la stabilité de toute la forêt.

**Cette technique ne doit être envisagée qu'en dernier recours, avec une compréhension approfondie et après des tests exhaustifs dans un environnement de laboratoire.**

## Concept

L'idée est d'ajouter des attributs ou des classes personnalisés au schéma qui pourraient être utilisés pour la persistance ou le contrôle. Par exemple :

*   Ajouter un attribut à la classe `user` ou `computer` qui pourrait stocker un payload ou une information de backdoor.
*   Modifier les permissions par défaut d'un nouvel attribut pour qu'il soit accessible ou modifiable par un compte contrôlé par l'attaquant.

## Prérequis

*   **Permissions :** L'utilisateur doit être membre du groupe `Schema Admins`. Ce groupe est généralement vide et n'a des membres que temporairement lors de modifications légitimes du schéma (ex: installation d'Exchange, mise à niveau du niveau fonctionnel du domaine/forêt).
*   **Maître d'Opérations du Schéma (Schema Master FSMO) :** Les modifications du schéma ne peuvent être effectuées que sur le DC qui détient le rôle de Maître du Schéma. Ce DC doit être accessible et le service de registre doit être activé pour permettre les modifications à distance (par défaut, il l'est).

## Risques Majeurs

*   **Instabilité de la Forêt :** Des erreurs dans la définition du schéma (types de données incorrects, OIDs conflictuels, etc.) peuvent corrompre la base de données AD ou empêcher les DCs de fonctionner correctement.
*   **Difficulté de Réversion :** Les modifications du schéma sont généralement permanentes. Supprimer des classes ou des attributs du schéma est complexe et souvent non supporté.
*   **Détection :** Les modifications du schéma sont des événements rares et hautement suspects qui devraient être étroitement surveillés.
*   **Complexité :** Nécessite une connaissance approfondie du fonctionnement interne d'AD et de la syntaxe de définition du schéma (LDIFDE, scripts).

## Exemple Théorique (À NE PAS FAIRE EN PRODUCTION SANS TESTS APPROFONDIS)

Supposons qu'un attaquant veuille ajouter un attribut `backdoorPayload` à la classe `user`.

1.  **Obtenir les droits `Schema Admins`.**
2.  **Identifier le Maître du Schéma.**
3.  **Préparer un fichier LDIF (LDAP Data Interchange Format) :**
    Cela impliquerait de définir un nouvel attribut avec un OID unique (obtenu légitimement ou en utilisant une plage privée), sa syntaxe, s'il est indexé, s'il est répliqué au Catalogue Global, etc. Puis, modifier la classe `user` pour inclure ce nouvel attribut dans ses `mayContain`.

    ```ldif
    # Exemple très simplifié et conceptuel - NE PAS UTILISER TEL QUEL
    # dn: CN=Backdoor-Payload,CN=Schema,CN=Configuration,DC=corp,DC=local
    # changetype: add
    # adminDescription: Attribut pour payload de backdoor
    # attributeID: 1.2.840.113556.1.8000.2554.XYZ.1 # OID fictif et probablement incorrect
    # attributeSyntax: 2.5.5.12 # Unicode String
    # isSingleValued: TRUE
    # showInAdvancedViewOnly: TRUE
    # lDAPDisplayName: backdoorPayload
    # ... autres attributs nécessaires ...

    # dn: CN=User,CN=Schema,CN=Configuration,DC=corp,DC=local
    # changetype: modify
    # add: mayContain
    # mayContain: backdoorPayload
    # -
    ```

4.  **Importer le fichier LDIF en utilisant `ldifde.exe` sur le Maître du Schéma :**
    ```batch
    ldifde -i -f add_attribute.ldif -s <NOM_MAITRE_SCHEMA> -c "CN=Configuration,DC=X,DC=Y" # Commande simplifiée
    ```

5.  **Forcer la réplication du schéma et attendre.**

6.  **Utiliser l'attribut :** L'attaquant pourrait ensuite écrire/lire des données dans `userObject.backdoorPayload`.

## Détection et Prévention

*   **Groupe `Schema Admins` :** Doit être vide en temps normal. Toute adhésion doit déclencher une alerte.
*   **Surveillance des Événements :**
    *   Event ID `1159` (Security Log) sur le Maître du Schéma indique une tentative de modification du schéma.
    *   Event ID `1450` et `1451` (Directory Service Log) indiquent le début et la fin d'une modification du schéma.
*   **Accès au Maître du Schéma :** Limiter l'accès réseau et les permissions sur le DC détenant ce rôle.
*   **Désactiver la modification du schéma à distance (si possible) :**
    La clé de registre `HKLM\SYSTEM\CurrentControlSet\Services\NTDS\Parameters\Schema Update Allowed` (REG_DWORD) sur le Maître du Schéma peut être mise à `0` pour empêcher les modifications (sauf par le système lui-même). Remettre à `1` pour les modifications légitimes.
*   **Sauvegardes Régulières de l'État du Système des DCs :** Essentiel pour une éventuelle restauration (qui serait complexe si le schéma est la cause du problème).

En résumé, la modification du schéma est une technique de "dernier recours" pour un attaquant, en raison de sa complexité, de ses risques, et du fait que d'autres méthodes de persistance et de domination sont souvent plus simples et plus sûres à mettre en œuvre. 