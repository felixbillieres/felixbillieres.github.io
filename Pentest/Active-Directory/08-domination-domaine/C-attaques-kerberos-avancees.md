# VIII.C. Attaques Kerberos Avancées

Au-delà des Golden et Silver Tickets classiques, d'autres techniques Kerberos avancées peuvent être utilisées pour la domination du domaine, la persistance, ou le mouvement latéral furtif.

## 1. Diamond Ticket / Sapphire Ticket (Key List Attack)

*   **Description (Concept) :**
    Ces termes ne sont pas standardisés comme "Golden Ticket" mais décrivent des attaques où l'attaquant, au lieu de compromettre le hash `krbtgt` (pour un Golden Ticket) ou un hash de compte de service (pour un Silver Ticket), compromet directement les **clés de session Kerberos** ou les **clés à long terme d'un compte** stockées en mémoire sur un système.
    *   **Diamond Ticket (concept) :** Si un attaquant peut dumper les clés Kerberos d'un utilisateur (ex: depuis LSASS après une authentification), il peut potentiellement réutiliser ces clés pour forger des TGS pour des services auxquels l'utilisateur a accès, sans avoir besoin du TGT original ou du mot de passe/hash de l'utilisateur. Cela s'apparente à un Pass-the-Key.
    *   **Sapphire Ticket (concept - plus proche de Golden/Silver) :** Si un attaquant compromet la clé à long terme d'un compte (ex: la clé AES256 dérivée du mot de passe d'un utilisateur ou d'un compte machine), il peut l'utiliser pour demander des TGTs (comme Overpass-the-Hash avec une clé) ou forger des TGS (comme un Silver Ticket avec une clé au lieu d'un hash NTLM).

*   **Outils / Techniques :**
    *   **Mimikatz :**
        *   `sekurlsa::ekeys` ou `sekurlsa::keys` : Peut afficher les clés Kerberos (clés de session, clés à long terme si disponibles) pour les sessions ouvertes.
        *   `kerberos::ptt <chemin_vers_ticket_kirbi_contenant_des_clés>` : Peut injecter des tickets.
        *   Si une clé à long terme (ex: AES256) d'un compte est obtenue, elle peut être utilisée avec `kerberos::golden` (en spécifiant `/aes256:<clé>` au lieu de `/rc4` ou `/krbtgt`) pour forger des tickets.
    *   **Rubeus :**
        *   `Rubeus.exe dump /service:krbtgt /nowrap` : Peut dumper les informations des tickets Kerberos, y compris les clés de session si disponibles.
        *   `Rubeus.exe asktgt /user:user /domain:corp.local /aes256:<CLE_AES256_UTILISATEUR> /ptt` : Demander un TGT en utilisant la clé AES du compte.
        *   `Rubeus.exe asksrv /service:cifs/server.corp.local /aes256:<CLE_AES256_COMPTE_SERVICE> /ptt` : Demander un TGS en utilisant la clé AES du compte de service.
        *   `Rubeus.exe seth /aes256:<CLE_AES256_COMPTE_SERVICE> /service:cifs /server:server.corp.local /user:FakeUser /ptt` : Forger un TGS (similaire à un Silver Ticket) en utilisant la clé AES du compte de service.

*   **Impact :** Permet l'usurpation d'identité et l'accès aux ressources sans connaître les mots de passe en clair ou les hashes NTLM, en s'appuyant directement sur les artefacts Kerberos.
*   **Détection/Prévention :**
    *   Protection LSA (RunAsPPL) pour rendre le dump de LSASS plus difficile.
    *   Credential Guard.
    *   Surveillance des accès anormaux aux services.

## 2. Abus de la Délégation Kerberos Non Contrainte (Unconstrained Delegation)

*   **Description :** Si un compte (généralement un compte machine d'un serveur) est configuré pour la délégation non contrainte, lorsqu'un utilisateur s'authentifie auprès d'un service sur ce serveur, le serveur obtient une copie du TGT de l'utilisateur et le stocke en mémoire (LSASS). Un attaquant ayant compromis ce serveur (avec des droits SYSTEM) peut extraire ces TGTs.
*   **Impact pour la Domination :** Si un administrateur de domaine (ou un autre compte à haut privilège) s'authentifie sur un serveur avec délégation non contrainte compromis, l'attaquant peut voler son TGT et l'utiliser pour accéder à n'importe quelle ressource du domaine, y compris les DCs (ex: pour DCSync).
*   **Outils :**
    *   **Énumération :** PowerView (`Get-NetComputer -Unconstrained`), BloodHound.
    *   **Extraction de TGTs :** Mimikatz (`sekurlsa::tickets /export`), Rubeus (`Rubeus.exe dump`).
    *   **Utilisation des TGTs volés :** Mimikatz (`kerberos::ptt`), Rubeus (`Rubeus.exe ptt /ticket:<ticket_base64_ou_chemin>`).
*   **Détection/Prévention :**
    *   Éviter la délégation non contrainte. Préférer la délégation contrainte ou la délégation contrainte basée sur les ressources (RBCD).
    *   Protéger les serveurs configurés pour la délégation non contrainte comme s'ils étaient des DCs.
    *   Mettre les comptes d'administrateurs dans le groupe "Protected Users" (limite la délégation et l'utilisation de certains types de clés).
    *   Surveiller l'extraction de tickets depuis LSASS.

## 3. Abus de la Délégation Contrainte Basée sur les Ressources (RBCD - Resource-Based Constrained Delegation)

*   **Description :** RBCD permet au propriétaire d'une ressource (ex: un compte machine) de configurer quels autres principaux (ex: un autre compte machine) sont autorisés à usurper des utilisateurs pour accéder à cette ressource. Si un attaquant a des droits d'écriture sur un compte machine cible (ex: un DC), il peut configurer RBCD pour permettre à un compte machine qu'il contrôle d'usurper des utilisateurs pour accéder au DC.
*   **Scénario d'Attaque Typique :**
    1.  L'attaquant compromet un compte machine `ATTAQUANT_MACHINE` (ou un compte utilisateur avec le SPN nécessaire pour S4U2Self).
    2.  L'attaquant obtient des droits d'écriture sur l'attribut `msDS-AllowedToActOnBehalfOfOtherIdentity` du compte machine `CIBLE_DC`. (Peut être obtenu via des ACLs vulnérables, ou si `ATTAQUANT_MACHINE` a `GenericWrite` sur `CIBLE_DC`).
    3.  L'attaquant configure `CIBLE_DC` pour faire confiance à `ATTAQUANT_MACHINE` pour la délégation.
        ```powershell
        # Avec PowerView ou ActiveDirectory module
        $AttackerMachine = Get-ADComputer -Identity ATTAQUANT_MACHINE
        Set-ADComputer -Identity CIBLE_DC -PrincipalsAllowedToDelegateToAccount $AttackerMachine
        ```
        Ou avec `rbcd.py` (Impacket) ou `SharpAllowedToAct`.
    4.  L'attaquant, depuis `ATTAQUANT_MACHINE` (ou en utilisant ses credentials), utilise S4U2Self pour obtenir un ticket de service pour lui-même vers `ATTAQUANT_MACHINE`, puis S4U2Proxy pour obtenir un ticket de service vers `CIBLE_DC` au nom d'un utilisateur privilégié (ex: Administrateur).
    *   **Outils :** Rubeus (`Rubeus.exe s4u /user:ATTAQUANT_MACHINE$ /rc4:<HASH_ATTAQUANT_MACHINE> /impersonateuser:Administrateur /msdsspn:CIFS/CIBLE_DC.corp.local /altservice:HOST /ptt`), Impacket (`getST.py`).
*   **Impact :** Permet à l'attaquant d'accéder à la machine cible (ex: DC) avec les privilèges de l'utilisateur usurpé.
*   **Détection/Prévention :**
    *   Surveiller les modifications de l'attribut `msDS-AllowedToActOnBehalfOfOtherIdentity`.
    *   Limiter les droits d'écriture sur les comptes machines, en particulier les DCs.
    *   BloodHound peut identifier les chemins d'abus RBCD.

## 4. "Forged PAC" / "Bronze Bit" (Modification du PAC)

*   **Description :** Le Privilege Attribute Certificate (PAC) dans un ticket Kerberos contient les informations d'autorisation de l'utilisateur (SIDs de groupe, etc.). Si un attaquant peut obtenir la clé du compte de service cible (pour un Silver Ticket) ou la clé `krbtgt` (pour un Golden Ticket), il peut non seulement forger le ticket mais aussi manipuler le contenu du PAC pour s'ajouter à des groupes privilégiés (ex: Admins du Domaine).
*   **Technique :**
    *   Lors de la création d'un Golden Ticket avec Mimikatz, les options `/groups` et `/sids` permettent d'ajouter des SIDs de groupes arbitraires au PAC.
    *   Des outils plus spécialisés peuvent permettre de modifier des PACs existants si la clé de signature est connue.
*   **Impact :** Élévation de privilèges arbitraire au sein du domaine ou pour un service spécifique.
*   **Détection/Prévention :**
    *   Comme pour Golden/Silver Tickets.
    *   Certaines solutions de sécurité tentent de valider la cohérence du PAC (plus complexe).

Ces attaques Kerberos avancées soulignent la nécessité de protéger non seulement les mots de passe et hashes NTLM, mais aussi les clés Kerberos elles-mêmes et les configurations de délégation. 