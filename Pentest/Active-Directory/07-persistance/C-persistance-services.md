# VII.C. Persistance via des Services (AD CS, Exchange)

Certains services d'infrastructure critiques, étroitement intégrés à Active Directory, peuvent être abusés pour établir une persistance si un attaquant obtient un contrôle suffisant sur eux.

## 1. Active Directory Certificate Services (AD CS)

Si un attaquant compromet AD CS ou obtient des droits suffisants sur sa configuration, il peut établir plusieurs formes de persistance.

*   **Modification de Modèles de Certificats (Certificate Templates) :**
    *   **Description :** Si un attaquant peut modifier un modèle de certificat existant ou en créer un nouveau, il peut le configurer de manière à permettre l'inscription pour des utilisateurs non privilégiés tout en accordant des droits élevés (ex: authentification de domaine, inscription au nom d'autrui - "enroll on behalf of").
    *   **Technique (ESC3, ESC4 dans la terminologie de SpecterOps) :**
        1.  Obtenir des droits d'écriture sur un modèle de certificat.
        2.  Modifier le modèle pour :
            *   Permettre l'inscription par un groupe contrôlé par l'attaquant (ou `Authenticated Users`).
            *   Ajouter l'EKU "Client Authentication" ou "Smart Card Logon".
            *   Permettre au demandeur de spécifier un SAN (Subject Alternative Name) - ESC1 like.
            *   Permettre l'inscription "Enroll on behalf of" (nécessite des droits d'agent d'inscription).
        3.  L'attaquant peut ensuite demander des certificats pour lui-même ou pour d'autres (y compris des admins) via ce modèle.
    *   **Détection :** Surveiller les modifications des modèles de certificats (attributs `pKIExtendedKeyUsage`, `msPKI-RA-Signature`, permissions d'inscription, etc.). Auditer régulièrement les modèles.

*   **Compromission du Compte de Service de l'Autorité de Certification (CA) :**
    *   **Description :** Si le compte de service de la CA est compromis, l'attaquant peut potentiellement signer des certificats arbitraires ou accéder à la clé privée de la CA.
    *   **Impact :** Peut permettre de forger des certificats pour n'importe quel usage.
    *   **Détection :** Protéger le compte de service de la CA, surveiller son utilisation.

*   **"Shadow Credentials" (via modification de `msDS-KeyCredentialLink`) :**
    *   **Description :** Si un attaquant a des droits d'écriture génériques (`GenericWrite` ou `WriteProperty` sur `msDS-KeyCredentialLink`) sur un objet ordinateur ou utilisateur, il peut ajouter ses propres informations d'identification de clé (similaires à Windows Hello for Business) à cet objet. Cela lui permet de s'authentifier en tant que cet objet en utilisant un certificat qu'il contrôle, sans connaître le mot de passe de l'objet.
    *   **Outils :** Whisker, PyWhisker, Certipy (`shadow auto`).
    *   **Impact :** Persistance furtive sur des comptes machines (y compris les DCs) ou utilisateurs.
    *   **Détection :** Surveiller les modifications de l'attribut `msDS-KeyCredentialLink`.

## 2. Microsoft Exchange Server

Exchange est profondément intégré à AD et sa compromission offre de nombreuses opportunités de persistance.

*   **Modification des Permissions de Boîtes aux Lettres :**
    *   **Description :** Un attaquant avec des droits d'administration Exchange peut s'accorder des permissions `FullAccess` sur des boîtes aux lettres cibles (ex: cadres, administrateurs).
    *   **Commandes (Exchange Management Shell) :**
        ```powershell
        Add-MailboxPermission -Identity <BOITE_CIBLE> -User <UTILISATEUR_ATTAQUANT> -AccessRights FullAccess -InheritanceType All
        ```
    *   **Impact :** Accès continu aux emails de la cible.
    *   **Détection :** Auditer régulièrement les permissions des boîtes aux lettres.

*   **Règles de Boîte aux Lettres Côté Serveur :**
    *   **Description :** Créer des règles de boîte aux lettres qui s'exécutent côté serveur pour transférer des emails, exécuter des applications (via des formulaires personnalisés malveillants - plus ancien mais possible), ou marquer des emails comme lus pour cacher l'activité.
    *   **Outils :** Outlook, OWA, `New-InboxRule` (Exchange Management Shell).
    *   **Impact :** Exfiltration de données, dissimulation d'activité.
    *   **Détection :** Examiner les règles de boîte aux lettres (via `Get-InboxRule`).

*   **Connecteurs de Transport / Agents de Transport :**
    *   **Description :** Des connecteurs ou agents de transport malveillants peuvent être installés pour intercepter, modifier ou rediriger le flux de messagerie.
    *   **Impact :** Exfiltration de données à grande échelle, injection de contenu.
    *   **Détection :** Auditer les connecteurs et agents de transport (`Get-TransportConnector`, `Get-TransportAgent`).

*   **Compromission de Comptes de Service Exchange :**
    *   **Description :** Les comptes utilisés par Exchange (ex: `Exchange Servers`, `Exchange Trusted Subsystem`) ont des privilèges élevés dans AD. Leur compromission offre une persistance puissante.
    *   **Impact :** Peut permettre de modifier des permissions AD, accéder à toutes les boîtes aux lettres.
    *   **Détection :** Protéger ces comptes, surveiller leur activité.

*   **Web Shells sur les Serveurs Exchange :**
    *   **Description :** Si une vulnérabilité a permis de déposer un web shell sur un serveur Exchange (ex: OWA, ECP), ce shell constitue une persistance.
    *   **Impact :** Accès à distance au serveur Exchange.
    *   **Détection :** Scanner les serveurs web pour les web shells, surveiller les processus suspects lancés par les pools d'applications IIS.

## Considérations Générales

*   **Principe de Moindre Privilège :** Appliquer strictement le moindre privilège pour les comptes de service et les administrateurs de ces plateformes.
*   **Audit et Surveillance :** Mettre en place un audit détaillé des modifications de configuration sur AD CS et Exchange. Surveiller les journaux pour les activités suspectes.
*   **Patch Management :** Maintenir ces services à jour pour se prémunir contre les vulnérabilités connues.

La persistance via ces services critiques peut être très difficile à déloger et offre à l'attaquant un contrôle significatif. 