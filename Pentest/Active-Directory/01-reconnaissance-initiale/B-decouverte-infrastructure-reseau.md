# B. Découverte de l'Infrastructure Réseau

Cette phase se concentre sur l'identification des hôtes actifs, des services exposés et des informations de base sur le domaine Active Directory, souvent depuis un point d'accès réseau interne sans authentification ou en scannant les IPs publiques identifiées.

## 1. Balayage Réseau (Découverte d'Hôtes)
*   **Objectif :** Identifier les machines actives sur le réseau cible.
*   **Outils et Commandes :**
    *   **Ping Sweep (ICMP) :**
        ```bash
        # fping (rapide et efficace)
        fping -asgq <PLAGE_IP_CIDR> # ex: 192.168.1.0/24
        # nmap (alternative)
        nmap -sn <PLAGE_IP_CIDR> 
        ```
    *   **ARP Scan (pour réseaux locaux, si sur le même segment L2) :**
        ```bash
        arp-scan -l
        nmap -PR -sn <PLAGE_IP_CIDR> # -PR force un ARP ping
        ```
    *   **TCP/UDP Port Scan (pour découvrir des hôtes via des ports communs ouverts) :**
        ```bash
        # Scan TCP SYN sur les ports les plus communs
        nmap -sS -p T:21,22,23,25,53,80,110,135,139,443,445,3389 <PLAGE_IP_CIDR> --open -oG - | grep "/open/"
        ```

## 2. Scan de Ports et Identification de Services
*   **Objectif :** Identifier les services en écoute sur les hôtes actifs et leurs versions.
*   **Outils et Commandes (Nmap) :**
    ```bash
    # Scan TCP SYN rapide des 1000 ports les plus communs avec détection de version
    nmap -sS -sV <IP_CIBLE_OU_PLAGE>

    # Scan TCP Connect (plus lent, plus bruyant, mais plus fiable si -sS est bloqué)
    nmap -sT -sV <IP_CIBLE_OU_PLAGE>

    # Scan de tous les ports TCP (très long)
    nmap -p- -sV <IP_CIBLE> --min-rate 1000 # Augmenter le rate pour accélérer

    # Scan UDP (long et moins fiable, cibler ports communs)
    sudo nmap -sU -sV -p U:53,67,68,69,123,161,162,500,4500 <IP_CIBLE> --version-intensity 0

    # Scripts NSE utiles (exemples)
    nmap --script default <IP_CIBLE>
    nmap --script vuln <IP_CIBLE> # Attention, peut être intrusif
    ```

## 3. Identification des Contrôleurs de Domaine (DC)
*   **Objectif :** Localiser les DCs, qui sont les cibles principales dans un environnement AD.
*   **Méthodes :**
    *   **Scan de ports spécifiques AD :**
        ```bash
        # LDAP, Kerberos, SMB, DNS, Global Catalog
        nmap -p 53,88,135,139,389,445,464,636,3268,3269 <PLAGE_IP_CIDR> --open -oG - | grep "/open/"
        # Les machines avec plusieurs de ces ports ouverts sont probablement des DCs.
        ```
    *   **Requêtes DNS (si un serveur DNS interne est accessible) :**
        ```bash
        # SRV records pour LDAP (identifie les DCs)
        host -t SRV _ldap._tcp.<DOMAINE.LOCAL>
        nslookup -type=SRV _ldap._tcp.<DOMAINE.LOCAL>

        # SRV records pour Kerberos
        host -t SRV _kerberos._tcp.<DOMAINE.LOCAL>
        host -t SRV _kerberos._udp.<DOMAINE.LOCAL>

        # Enregistrement A du domaine (souvent un DC)
        host <DOMAINE.LOCAL>
        ```
    *   **NetBIOS Name Scan (si sur le même segment réseau) :**
        ```bash
        nbtscan -r <PLAGE_IP_CIDR> # Chercher les noms avec <1B> (Domain Master Browser) ou <1C> (Domain Controllers)
        ```

## 4. Énumération des Services Exposés Clés
*   **Objectif :** Examiner de plus près les services AD courants.
    *   **SMB :**
        ```bash
        # Lister les partages (session nulle si possible)
        smbclient -N -L //<IP_CIBLE>
        crackmapexec smb <IP_CIBLE_OU_PLAGE> --shares -u '' -p ''

        # Scripts Nmap pour SMB
        nmap --script smb-enum-shares.nse,smb-os-discovery.nse,smb-protocols.nse,smb-security-mode.nse <IP_CIBLE>

        #Tester si NTLM disabled (utiliser le smbclient impacket
        smbclient.py -k <domain_name>/<username>@<smb_server_hostname> -dc-ip <dc_hostname_or_ip>
        ```
    *   **LDAP :**
        ```bash
        # Obtenir le RootDSE (informations de base sur le service LDAP et le domaine)
        nmap -p 389 --script ldap-rootdse <IP_DC>
        ldapsearch -x -h <IP_DC> -s base -b "" "(objectclass=*)" # Demande le RootDSE
        # Chercher : namingContexts (DN du domaine), supportedLDAPVersion, etc.
        ```
    *   **Kerberos :**
        ```bash
        # Vérifier si le port 88/tcp et 88/udp est ouvert.
        # Des outils comme Kerbrute peuvent être utilisés plus tard pour énumérer les utilisateurs.
        nmap -p 88 -sU -sS <IP_DC>
        ```
    *   **Services Web (IIS sur les DCs, ADFS, OWA, etc.) :**
        ```bash
        nmap -p 80,443,8080,8443 --open <PLAGE_IP_CIDR> -sV
        # Utiliser des outils comme gobuster, dirb, feroxbuster pour découvrir des répertoires/fichiers.
        ```

## 5. Informations de Base sur le Domaine (si possible sans authentification)
*   **Objectif :** Obtenir le nom de domaine, la politique de mot de passe.
    *   **Via RPC (Remote Procedure Call) - Session Nulle :**
        ```bash
        # rpcclient (Linux)
        rpcclient -U "" -N <IP_DC> # Tenter une connexion en session nulle
        rpcclient $> querydominfo   # Informations sur le domaine (nom, SID)
        rpcclient $> enumdomusers   # Tenter de lister les utilisateurs (souvent restreint)
        ```
    *   **enum4linux (wrapper pour plusieurs techniques d'énumération SMB/RPC) :**
        ```bash
        enum4linux -a <IP_DC> # Lance toutes les énumérations
        enum4linux -P <IP_DC> # Tente d'obtenir la politique de mot de passe
        ```
    *   **CrackMapExec (pour la politique de mot de passe via SAMR) :**
        ```bash
        # Nécessite souvent au moins un compte valide, mais peut parfois fonctionner en session nulle
        crackmapexec smb <IP_DC> -u '' -p '' --pass-pol 
        ```

## Points Clés à Noter (Découverte Infra)
*   Adresses IP des Contrôleurs de Domaine.
*   Nom FQDN du domaine Active Directory.
*   Services critiques exposés (LDAP, Kerberos, SMB, HTTP/S sur les DCs).
*   Versions des OS et des services (pour recherche de vulnérabilités connues).
*   Partages SMB accessibles (SYSVOL, NETLOGON sont standards).
*   Politique de mot de passe du domaine (si obtenue). 
